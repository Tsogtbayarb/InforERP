|******************************************************************************
|* tpisg3201m000  0  VRC B61U a7 isg 
|* Generate CT - Financial Template
|* merino1                       
|* 2019-03-22
|******************************************************************************
|* Main table tpisg301 Contract Wise Information, Form Type 4
|******************************************************************************
|* ISGEC01171, Prasanna Bhuyan, 22/3/2019, VRC B61U a7 isg
|* ISGEC002025, Arun Chauhan, 08/04/2019,VRC B61U a7 isg
|* New Development  
|****************************** declaration section ***************************
declaration:

	table	ttpisg301 | Contract Wise Information
	table	ttpisg302 | Payment-Term Advance
	table	ttpisg303 | Payment-Term Running
	table	ttpisg304 | Payment-Term Retention
	table	ttpisg305 | Cost Sheet Supply
	table	ttpisg306 | Cost Sheet Erection
	table	ttpisg307 | Cost Sheet Civil
	table	ttpisg308 | Cost Sheet Total
	table	ttpisg087 | Contract Header
	table	ttpisg088 | Contract Lines
	table	ttpisg058 | Cost Sheet Detail History
	table	ttpisg057 | Cost Sheet Header History
	table	ttppdm600 | Project
	table	ttfgld106 | Finalized Transactions
	table	ttfgld011 | Transaction Types
	table	ttfisg072 | Master Data for Sales Ledger
	table	ttpisg089 | Contractwise Cash Flow
	table	ttpisg090 | Contractwise extra Claim / Client Debits Entry
	table	ttpisg091 | Projectwise Bank Guarantee
	table	ttfisg041 | Cash Flow Data
	table	ttfacr200 | Open Items(Sale Invoice & Receipts) 
	table 	ttpisg309 | Billing 
	table	ttpisg310											|07.05.19.Adarsh.n
	table	ttccom100											
	table	ttcemm030											
	table	ttpisg313											
	table	ttpisg085											
	table	ttpisg316											
	table	ttpisg092
	table	ttpisg321
	table	ttpisg322
	table	ttpisg086
	table	ttpisg501
	table	ttpisg600

	extern	domain	tcorno		ccod.f, ccod.t 
	extern  domain	tfgld.year	fyer
	extern  domain	tfgld.prod	fprd
		domain	tcmcs.str100	csdc
		domain	tcamnt		sum.ibud, sum.tcst, sum.stcs, sum.cons, sum.bcth, sum.coco,sum.exhd, sum.cbac, sum.niba, sum.cont, c.amnt,
					sum.eitl, sum.ctoh, sum.cysc, sum.bdgd, sum.aled, sum.cbda, sum.cycn, sum.sson, d.amnt,
					sum.bdgd1, sum.aled1, sum.cbda1, sum.cycn1, sum.sson1, sum.stcs1, sum.cysc1, sum.coco1,
					sum.bdgd2, sum.aled2, sum.cbda2, sum.cycn2, sum.sson2, sum.stcs2, sum.cysc2, sum.coco2,
					sum.bdgd3, sum.aled3, sum.cbda3, sum.cycn3, sum.sson3, sum.stcs3, sum.cysc3, sum.coco3,
					SupplyAmt, CivilAmt, ErectionAmt, TotalReceivedSupply, TotalReceivedCivil, TotalReceivedErection,
					ReceivedAmt, sum.amnt, sum.budg, diff.amnt, cr.amnt, dr.amnt, BillingActual, sum.camt, sum.samt,
					cder, cdsr, cddr, cdds, cdra, cdsa, sum.cbgv, obga, obge, obgp, obgs, obgc, obgb, 
					TotalInAmt, TotalOutAmt, InAmt,
					OutAmt, sum.amto, sum.amti, sum.rsnd, sum.rsum, sum.rsbm, sum.rsgy, sum.rsmy, sum.rcnd,
					sum.rcum, sum.rcbm, sum.rcgy, sum.rcmy, sum.rend, sum.reum, sum.rebm, sum.regy, sum.remy,
					sum.rccm, sum.rcdm, sum.recm, sum.redm, sum.rscm, sum.rsdm, sum.oamo, sum.oami,			
					SupplyUnclaimedRetention, CivilUnclaimedRetention, ErectionUnclaimedRetention,
					TotalReceivedSupplyNetAmnt, TotalReceivedCivilNetAmnt, TotalReceivedErectionNetAmnt,
					ReceivedSupplyNetAmnt1, ReceivedSupplyNetAmnt2, InFlowActual
		domain	tcyesno		flag
		domain	tfgld.date	curr.date
														|07.05.19.Adarsh.sn
		domain	tcmcs.long	mnth.long
		domain	tcmcs.str10	mnth.desc,mnth.year
		domain	tfgld.year	f.year
		domain	tfgld.prod	f.prod
		domain	tfgld.btno	hold.btno
		domain	tcamnt		cash.inflow,cash.outflow,net.inflow,net.outflow,inflow.actual,inflow.variance,
					net.inflow.btno,net.outflow.btno,outflow.actual,outflow.variance,net.actual,
					net.variance,niba.cprj,niba.ccod.sply,niba.ccod.civl,niba.ccod.erec
		long	i,sern
														|07.05.19.Adarsh.en
		domain	tcamnt		tot.rec.catg.10,net.amth.catg.10,oflw.actu
|****************************** program section ********************************


|****************************** choice section *********************************
choice.generate_data:
on.choice:
	generate.data()
|****************************** group section **********************************

group.1:
init.group:
   get.screen.defaults()
   
|****************************** field section **********************************
field.ccod.f:
when.field.changes:
	ccod.t = ccod.f

|****************************** function section *******************************
functions:
function generate.data()
{
	flag = tcyesno.no
	
	select	tpisg087.*
	from	tpisg087
	where	tpisg087._index1 inrange {:ccod.f} and {:ccod.t}
	selectdo
		i = 0
		sern = 0
		
		|************************** Delete, Insert, Update Payment Term - All in tpisg313 for Contract Range
		delete.tpisg313(tpisg087.ccod)
		insert.update.tpisg313(tpisg087.ccod)
		
		|************************** Delete, Insert, Update Bank Guarantee Type in tpisg316 for Contract Range
		delete.tpisg316(tpisg087.ccod)
		insert.update.tpisg316(tpisg087.ccod)
		
		|************************** Delete, Insert, Update Billing Information in tpisg321 for Contract Range
		delete.tpisg321(tpisg087.ccod)
		insert.update.tpisg321(tpisg087.ccod)
		
		|************************** Delete, Insert, Update Cash Flow Information in tpisg322 for Contract Range
		delete.tpisg322(tpisg087.ccod)
		insert.update.tpisg322(tpisg087.ccod)
		
		|************************** Delete, Insert, Update for tpisg305, 306 and 307 for Cost Head Elements
		delete.tpisg305.306.and.307(tpisg087.ccod)
	 	insert.tpisg305.306.and.307(tpisg087.ccod)
		
		|************************** Insert & Update for tpisg301
		flag = tcyesno.no
		get_billing_data_for_tpisg301(tpisg087.ccod)
		get_claim_data_for_tpisg301(tpisg087.ccod)
		get_bg_type_wise_data_for_tpisg301(tpisg087.ccod)
		get_contractwise_data(tpisg087.ccod)
		get_cashflow_in_data(tpisg087.ccod, InFlowActual)
		get_cashflow_out_data(tpisg087.ccod)
		get_receivable_details(tpisg087.ccod)
		get_direct_supplier_payment(tpisg087.ccod)			|#Adarsh.18.11.19
		insert_update_in_tpisg301(tpisg087.ccod)
		
		|************************** Insert & Update for tpisg305
		csdc = ""
		csdc = "Order Value"
		flag = tcyesno.no
		get_data_from_tpisg058_for_desc_for_all_element(tpisg087.ccod, tpisg.ptyp.supply)
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Material Cost"
		flag = tcyesno.no
		get_data_from_tpisg058_for_desc_for_some_element(tpisg087.ccod, tpisg.ptyp.supply, "9")		
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Freight"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.supply, "99050000")
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Other Expenses"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.supply, "99080000")
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.supply, "99100000")
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
 		
		csdc = ""
		csdc = "Contingency-S"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.supply, "99180000")
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Warranty"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.supply, "99110000")
		insert_update_in_tpisg305_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Export Incentive"
		flag = tcyesno.no
		get_data_from_tpisg057_for_desc(tpisg087.ccod, tpisg.ptyp.supply)
		insert_update_in_tpisg305_for_desc_for_some_fields1(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contribution"
		flag = tcyesno.no
		get_data_from_tpisg057_for_desc(tpisg087.ccod, tpisg.ptyp.supply)
		insert_update_in_tpisg305_for_desc_for_some_fields2(tpisg087.ccod, csdc)
		
		|************************** Insert & Update for tpisg306
		csdc = ""
		csdc = "Order Value"
		flag = tcyesno.no
		get_data_from_tpisg058_for_desc_for_all_element(tpisg087.ccod, tpisg.ptyp.erection)
		insert_update_in_tpisg306_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Services Cost"
		flag = tcyesno.no
		get_data_from_tpisg058_for_services_cost(tpisg087.ccod, tpisg.ptyp.erection, "99010000", "99020000")
		insert_update_in_tpisg306_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Other Expenses"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.erection, "99080000")
		insert_update_in_tpisg306_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.erection, "99100000")
		insert_update_in_tpisg306_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency-S"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.erection, "99180000")
		insert_update_in_tpisg306_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Warranty"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.erection, "99110000")
		insert_update_in_tpisg306_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contribution"
		flag = tcyesno.no
		get_data_from_tpisg057_for_desc(tpisg087.ccod, tpisg.ptyp.erection)
		insert_update_in_tpisg306_for_some_fields(tpisg087.ccod, csdc)
		
		|************************** Insert & Update for tpisg307
		csdc = ""
		csdc = "Order Value"
		flag = tcyesno.no
		get_data_from_tpisg058_for_desc_for_all_element(tpisg087.ccod, tpisg.ptyp.civil)
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Material Cost"
		flag = tcyesno.no
		get_data_from_tpisg058_for_desc_for_some_element(tpisg087.ccod, tpisg.ptyp.civil, "9")	
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Services Cost"
		flag = tcyesno.no
		get_data_from_tpisg058_for_services_cost(tpisg087.ccod, tpisg.ptyp.civil, "99010000", "99020000")
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Freight"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.civil, "99050000")
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Other Expenses"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.civil, "99080000")
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.civil, "99100000")
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency-S"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.civil, "99180000")
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Warranty"
		flag = tcyesno.no
		get_data_from_tpisg058_for_fixed_element(tpisg087.ccod, tpisg.ptyp.civil, "99110000")
		insert_update_in_tpisg307_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contribution"
		flag = tcyesno.no
		get_data_from_tpisg057_for_desc(tpisg087.ccod, tpisg.ptyp.erection)
		insert_update_in_tpisg307_for_some_fields(tpisg087.ccod, csdc)
		
		|************************** Insert & Update for tpisg308
		csdc = ""
		csdc = "Order Value"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Material Cost"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Freight"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Other Expenses"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contingency-S"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Warranty"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Export Incentive"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Contribution"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Services Cost"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		csdc = ""
		csdc = "Non-Integrated Cost"
		flag = tcyesno.no
		insert_update_in_tpisg308_for_desc(tpisg087.ccod, csdc)
		
		|************************** Insert & Update for tpisg302
| 		delete_from_tpisg302(tpisg087.ccod)
| 		get_data_for_insert_update(tpisg087.ccod, tdisg.ptyp.advance)
		
		|************************** Insert & Update for tpisg303
| 		delete_from_tpisg303(tpisg087.ccod)
| 		get_data_for_insert_update(tpisg087.ccod, tdisg.ptyp.netpay)
		
		|************************** Insert & Update for tpisg304
| 		delete_from_tpisg304(tpisg087.ccod)
| 		get_data_for_insert_update(tpisg087.ccod, tdisg.ptyp.retention)
		
		|************************** Insert & Update for tpisg309
| 		delete_from_tpisg309(tpisg087.ccod)
| 		insert_update_in_tpisg309(tpisg087.ccod)
| 				
| 		|************************** Insert & Update for tpisg310
| 		delete.data.from.tpisg310.for.curr.ccod(tpisg087.ccod)
| 		insert.and.update.tpisg310(tpisg087.ccod)
		
		|************************** Initialize Serial Number for tpisg310
		i = 0
	endselect
	
	message("Updated Successfully!")
}

|****************************************************************************************************
|Insert & Update in "tpisg301"
|****************************************************************************************************

function insert_update_in_tpisg301(
					domain	tcorno	i.ccod
								)
{
	select	tpisg301.*
	from	tpisg301 for update
	where	tpisg301._index1 = {:i.ccod}
	selectdo
		tpisg301.user = logname$
		tpisg301.ccod = tpisg087.ccod
		tpisg301.ccno = tpisg087.ccno
| 		tpisg301.cust = tpisg087.cust
		tpisg301.cust = get.customer.name(tpisg087.cust)
		tpisg301.nodi = tpisg087.nodi
| 		tpisg301.lddn = tpisg087.lddn
		tpisg301.lddn = get.enterprize.unit.name(tpisg087.lddn)
		tpisg301.prod = tpisg087.prod
		tpisg301.zdat = tpisg087.zdat
		tpisg301.ccdt = tpisg087.ccdt
		tpisg301.orvl = tpisg087.orvl
		tpisg301.exrt = tpisg087.exrt
		tpisg301.ordl = tpisg087.ordl
		tpisg301.lddl = tpisg087.lddl
		tpisg301.blbd = sum.budg
		tpisg301.blal = BillingActual
		tpisg301.blvr = tpisg301.blal- tpisg301.blbd		
		tpisg301.cinb = sum.amti
		tpisg301.cino = sum.oami					
		tpisg301.cina = InFlowActual
		tpisg301.cinv = tpisg301.cinb - tpisg301.cina
		tpisg301.cotb = sum.amto
		tpisg301.coto = sum.oamo				
		tpisg301.cota = TotalOutAmt + oflw.actu
		tpisg301.cotv = tpisg301.cotb - tpisg301.cota
		tpisg301.cntb = tpisg301.cinb - tpisg301.cotb 
		tpisg301.cnto = sum.oami - sum.oamo					
		tpisg301.cnta = tpisg301.cina - tpisg301.cota
		tpisg301.cntv = tpisg301.cinv - tpisg301.cotv		
		tpisg301.rsnd = sum.rsnd
		tpisg301.rsum = sum.rsum
		tpisg301.rsbm = sum.rsbm
		tpisg301.rscm = sum.rscm			
		tpisg301.rsdm = sum.rsdm			
		tpisg301.rsgy = sum.rsgy
		tpisg301.rsmy = sum.rsmy
		tpisg301.rsur = SupplyUnclaimedRetention
								
		tpisg301.rstl = tpisg301.rsnd + tpisg301.rsum + 
				tpisg301.rsbm + tpisg301.rsgy + 
				tpisg301.rsmy + tpisg301.rsur +
				tpisg301.rscm + tpisg301.rsdm
								
		tpisg301.nrts = tpisg301.rsum + tpisg301.rsbm + 
				tpisg301.rsgy + tpisg301.rsmy + 
				tpisg301.rscm + tpisg301.rsdm	
				
		tpisg301.rcnd = sum.rcnd
		tpisg301.rcum = sum.rcum
		tpisg301.rcbm = sum.rcbm
		tpisg301.rccm = sum.rccm			
		tpisg301.rcdm = sum.rcdm			
		tpisg301.rcgy = sum.rcgy
		tpisg301.rcmy = sum.rcmy
		tpisg301.rcur = CivilUnclaimedRetention
		
		tpisg301.rctl = tpisg301.rcnd + tpisg301.rcum + 
				tpisg301.rcbm + tpisg301.rcgy + 
				tpisg301.rcmy + tpisg301.rcur +
				tpisg301.rccm + tpisg301.rcdm
				
		tpisg301.nrtc = tpisg301.rcum + tpisg301.rcbm + 
				tpisg301.rcgy + tpisg301.rcmy +
				tpisg301.rccm + tpisg301.rccm
				
		tpisg301.rend = sum.rend
		tpisg301.reum = sum.reum
		tpisg301.rebm = sum.rebm
		tpisg301.recm = sum.recm			
		tpisg301.redm = sum.redm			
		tpisg301.regy = sum.regy
		tpisg301.remy = sum.remy
		tpisg301.reur = ErectionUnclaimedRetention

		tpisg301.retl = tpisg301.rend + tpisg301.reum + 
				tpisg301.rebm + tpisg301.regy + 
				tpisg301.remy + tpisg301.reur + 
				tpisg301.recm + tpisg301.redm
				
		tpisg301.nrte = tpisg301.reum + tpisg301.rebm + 
				tpisg301.regy + tpisg301.remy +
				tpisg301.recm + tpisg301.redm 
								
		tpisg301.rtnd = tpisg301.rsnd + tpisg301.rcnd + tpisg301.rend
		tpisg301.rtum = tpisg301.rsum + tpisg301.rcum + tpisg301.reum
		tpisg301.rtbm = tpisg301.rsbm + tpisg301.rcbm + tpisg301.rebm
		tpisg301.rtcm = tpisg301.rscm + tpisg301.rccm + tpisg301.recm		
		tpisg301.rtdm = tpisg301.rsdm + tpisg301.rcdm + tpisg301.redm		
		tpisg301.rtgy = tpisg301.rsgy + tpisg301.rcgy + tpisg301.regy
		tpisg301.rtmy = tpisg301.rsmy + tpisg301.rcmy + tpisg301.remy
		tpisg301.rtur = tpisg301.rsur + tpisg301.rcur + tpisg301.reur
		tpisg301.rttl = tpisg301.rstl + tpisg301.rctl + tpisg301.retl
		tpisg301.nrtl = tpisg301.nrts + tpisg301.nrtc + tpisg301.nrte		
		
| 		tpisg301.obga = obga 
| 		tpisg301.obge = obge 
| 		tpisg301.obgp = obgp 
| 		tpisg301.obgs = obgs 
| 		tpisg301.obgc = obgc 
| 		tpisg301.obgb = obgb 
 
		tpisg301.cder = cder
		tpisg301.cdsr = cdsr
		tpisg301.cddr = cddr
		tpisg301.cdds = cdds
		tpisg301.cdra = cdra
		tpisg301.cdsa = cdsa
		tpisg301.rcdt = tpisg087.rcdt
		tpisg301.updt = utc.num()
		tpisg301.ecdt = tpisg087.ecdt
		tpisg301.ccur = get.project.currency(i.ccod)
		
		tpisg301.bvfo = tpisg301.cnto - tpisg301.cnta
		tpisg301.nrsa = 0
		tpisg301.civo = tpisg301.cino - tpisg301.cina
		tpisg301.covo = tpisg301.coto - tpisg301.cota
		tpisg301.cnvo = tpisg301.civo - tpisg301.covo
		
		db.update(ttpisg301, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		tpisg301.user = logname$
		tpisg301.ccod = tpisg087.ccod
		tpisg301.ccno = tpisg087.ccno
| 		tpisg301.cust = tpisg087.cust
		tpisg301.cust = get.customer.name(tpisg087.cust)
		tpisg301.nodi = tpisg087.nodi
| 		tpisg301.lddn = tpisg087.lddn
		tpisg301.lddn = get.enterprize.unit.name(tpisg087.lddn)
		tpisg301.prod = tpisg087.prod
		tpisg301.zdat = tpisg087.zdat
		tpisg301.ccdt = tpisg087.ccdt
		tpisg301.orvl = tpisg087.orvl
		tpisg301.exrt = tpisg087.exrt
		tpisg301.ordl = tpisg087.ordl
		tpisg301.lddl = tpisg087.lddl
		tpisg301.blbd = sum.budg
		tpisg301.blal = BillingActual
		tpisg301.blvr = tpisg301.blal -  tpisg301.blbd 
		
		tpisg301.cinb = sum.amti
		tpisg301.cino = sum.oami					
		tpisg301.cina = InFlowActual
		tpisg301.cinv = tpisg301.cinb - tpisg301.cina
		tpisg301.cotb = sum.amto
		tpisg301.coto = sum.oamo					
		tpisg301.cota = TotalOutAmt + oflw.actu
		tpisg301.cotv = tpisg301.cotb - tpisg301.cota
		tpisg301.cntb = tpisg301.cinb - tpisg301.cotb 
		tpisg301.cnto = sum.oami - sum.oami
		tpisg301.cnta = tpisg301.cina - tpisg301.cota
		tpisg301.cntv = tpisg301.cinv - tpisg301.cotv
		
		tpisg301.rsnd = sum.rsnd
		tpisg301.rsum = sum.rsum
		tpisg301.rsbm = sum.rsbm
		tpisg301.rscm = sum.rscm			
		tpisg301.rsdm = sum.rsdm			
		tpisg301.rsgy = sum.rsgy
		tpisg301.rsmy = sum.rsmy
		tpisg301.rsur = SupplyUnclaimedRetention

		tpisg301.rstl = tpisg301.rsnd + tpisg301.rsum + 
				tpisg301.rsbm + tpisg301.rsgy + 
				tpisg301.rsmy + tpisg301.rsur +
				tpisg301.rscm + tpisg301.rsdm
								
		tpisg301.nrts = tpisg301.rsum + tpisg301.rsbm + 
				tpisg301.rsgy + tpisg301.rsmy + 
				tpisg301.rscm + tpisg301.rsdm	
								
		tpisg301.rcnd = sum.rcnd
		tpisg301.rcum = sum.rcum
		tpisg301.rcbm = sum.rcbm		
		tpisg301.rccm = sum.rccm			
		tpisg301.rcdm = sum.rcdm			
		tpisg301.rcgy = sum.rcgy
		tpisg301.rcmy = sum.rcmy
		tpisg301.rcur = CivilUnclaimedRetention

		tpisg301.rctl = tpisg301.rcnd + tpisg301.rcum + 
				tpisg301.rcbm + tpisg301.rcgy + 
				tpisg301.rcmy + tpisg301.rcur +
				tpisg301.rccm + tpisg301.rcdm
				
		tpisg301.nrtc = tpisg301.rcum + tpisg301.rcbm + 
				tpisg301.rcgy + tpisg301.rcmy +
				tpisg301.rccm + tpisg301.rccm

		tpisg301.rend = sum.rend
		tpisg301.reum = sum.reum
		tpisg301.rebm = sum.rebm
		tpisg301.recm = sum.recm			
		tpisg301.redm = sum.redm			
		tpisg301.regy = sum.regy
		tpisg301.remy = sum.remy
		tpisg301.reur = ErectionUnclaimedRetention

		tpisg301.retl = tpisg301.rend + tpisg301.reum + 
				tpisg301.rebm + tpisg301.regy + 
				tpisg301.remy + tpisg301.reur + 
				tpisg301.recm + tpisg301.redm
				
		tpisg301.nrte = tpisg301.reum + tpisg301.rebm + 
				tpisg301.regy + tpisg301.remy +
				tpisg301.recm + tpisg301.redm 
								
		tpisg301.rtnd = tpisg301.rsnd + tpisg301.rcnd + tpisg301.rend
		tpisg301.rtum = tpisg301.rsum + tpisg301.rcum + tpisg301.reum
		tpisg301.rtbm = tpisg301.rsbm + tpisg301.rcbm + tpisg301.rebm
		tpisg301.rtcm = tpisg301.rscm + tpisg301.rccm + tpisg301.recm		
		tpisg301.rtdm = tpisg301.rsdm + tpisg301.rcdm + tpisg301.redm		
		tpisg301.rtgy = tpisg301.rsgy + tpisg301.rcgy + tpisg301.regy
		tpisg301.rtmy = tpisg301.rsmy + tpisg301.rcmy + tpisg301.remy
		tpisg301.rtur = tpisg301.rsur + tpisg301.rcur + tpisg301.reur
		tpisg301.rttl = tpisg301.rstl + tpisg301.rctl + tpisg301.retl
		tpisg301.nrtl = tpisg301.nrts + tpisg301.nrtc + tpisg301.nrte		
		
| 		tpisg301.obga = obga 
| 		tpisg301.obge = obge 
| 		tpisg301.obgp = obgp 
| 		tpisg301.obgs = obgs 
| 		tpisg301.obgc = obgc 
| 		tpisg301.obgb = obgb 
		
		tpisg301.cder = cder
		tpisg301.cdsr = cdsr
		tpisg301.cddr = cddr
		tpisg301.cdds = cdds
		tpisg301.cdra = cdra
		tpisg301.cdsa = cdsa
		tpisg301.rcdt = tpisg087.rcdt
		tpisg301.updt = utc.num()
		tpisg301.ecdt = tpisg087.ecdt
		tpisg301.ccur = get.project.currency(i.ccod)
		
		tpisg301.bvfo = tpisg301.cnto - tpisg301.cnta
		tpisg301.nrsa = 0
		tpisg301.civo = tpisg301.cino - tpisg301.cina
		tpisg301.covo = tpisg301.coto - tpisg301.cota
		tpisg301.cnvo = tpisg301.civo - tpisg301.covo
		
		db.insert(ttpisg301, db.skip.dupl, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	endselect	
}

function get_billing_data_for_tpisg301(
						domain	tcorno	i.ccod
									)
{
	sum.budg = 0
	BillingActual = 0
	
	select	sum(tpisg086.budg):sum.budg
	from	tpisg086
	where	tpisg086.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod})
	selectdo
	endselect
	
	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod}
	selectdo
		select	tppdm600.ncmp
		from	tppdm600
		where	tppdm600._index1 = {:tpisg088.cprj}
		selectdo
		endselect
		
		cr.amnt = 0
		
		|*CREDIT
		select	sum(tfgld106.amth(1)):cr.amnt
		from	tfgld106
		where	tfgld106.dim1 = :tpisg088.cprj
		and	tfgld106.dbcr = tfgld.dbcr.credit
		and	tfgld106.leac in (select tfisg072.leac from tfisg072) 
		and 	tfgld106._compnr = :tppdm600.ncmp
		selectdo
		endselect
		
		dr.amnt = 0
		
		|*DEBIT
		select	sum(tfgld106.amth(1)):dr.amnt
		from	tfgld106 
		where	tfgld106.dim1 = :tpisg088.cprj
		and	tfgld106.dbcr = tfgld.dbcr.debit
		and	tfgld106.leac in (select tfisg072.leac from tfisg072) 
		and 	tfgld106._compnr = :tppdm600.ncmp
		selectdo
		endselect
		
		diff.amnt = 0
		diff.amnt = cr.amnt - dr.amnt
		BillingActual = BillingActual + diff.amnt
	endselect
}	

function get_bg_type_wise_data_for_tpisg301(domain	tcorno	i.ccod)
{
	
	sum.cbgv = 0
	obga = 0
	obge = 0
	obgp = 0
	obgs = 0
	obgc = 0
	obgb = 0

	select	tpisg091.bgno,
		tpisg091.bgtp
	from	tpisg091
	where	tpisg091.ccod = :i.ccod
	and 	tpisg091.bgst = 1
	selectdo
		select tpisg092.cbgv:sum.cbgv,
			tpisg092.rvno
		from	tpisg092
		where	tpisg092._index1 = {:tpisg091.bgno}
		and 	tpisg092.stat = 1
		order by tpisg092.rvno desc
		as set with 1 rows
		selectdo
			on case etol(tpisg091.bgtp)
				case 1:
					obga = obga + sum.cbgv
					break
				case 2:
					obge = obge + sum.cbgv
					break
				case 3:
					obgp = obgp + sum.cbgv
					break
				case 4:
					obgs = obgs + sum.cbgv
					break
				case 5:
					obgc = obgc + sum.cbgv
					break
				case 6:
					obgb = obgb + sum.cbgv
					break
			endcase
		selectempty
			sum.cbgv = 0.00
		endselect
	selectempty
		tpisg091.bgno = ""
	endselect
}

function  get_claim_data_for_tpisg301(
					domain	tcorno		i.ccod
									)
{
	sum.camt = 0
	sum.samt = 0
	cder = 0
	cdsr = 0
	cddr = 0
	cdds = 0
	cdra = 0
	cdsa = 0
	
	select	sum(tpisg090.camt):sum.camt,
		sum(tpisg090.samt):sum.samt,
		tpisg090.cltp
	from	tpisg090	
	where	tpisg090._index1 = {:i.ccod}
	group by tpisg090.cltp
	selectdo
		if etol(tpisg090.cltp) = 1 then
			cder = sum.camt
			cdsr = sum.samt
			else if etol(tpisg090.cltp) = 2 then
				cddr = sum.camt
				cdds = sum.samt
				else if etol(tpisg090.cltp) = 3 then
					cdra = sum.camt
					cdsa = sum.samt
				endif
			endif
		endif
	selectempty
		sum.camt = 0
		sum.samt = 0
	endselect
	
}

function get_cashflow_out_data(
				domain	tcorno	i.ccod
							)
{
	domain	tfgld.btno	btno
	
	TotalInAmt = 0
	TotalOutAmt = 0
	InAmt = 0
	OutAmt = 0
	
	select	tpisg088.cprj, tppdm600.ncmp
	from	tpisg088, tppdm600
	where	tpisg088._index1 = {:i.ccod}
	and	tpisg088.cprj refers to tppdm600 UNREF CLEAR
	selectdo
		select	tfisg041.btno:btno
		from	tfisg041
		where	tfisg041.cprj = :tpisg088.cprj
		and	tfisg041._compnr = :tppdm600.ncmp
		group by tfisg041.btno
		selectdo
			InAmt = 0
			OutAmt = 0
			calculate_actual_inflow_outflow(tpisg088.cprj, btno, tppdm600.ncmp, tfcash.flow.in, InAmt)
			calculate_actual_inflow_outflow(tpisg088.cprj, btno, tppdm600.ncmp, tfcash.flow.out, OutAmt)
			
			if InAmt > OutAmt then
				TotalInAmt = TotalInAmt + (InAmt - OutAmt)
			else
				if InAmt < OutAmt then
					TotalOutAmt = TotalOutAmt + (OutAmt - InAmt)
				endif
			endif
		endselect
	endselect
}
										|#OLD
| function get_cashflow_in_data(
| 					domain	tcorno	i.ccod,
| 				ref	domain	tcamnt	o.totl
| 								)
| {
| 	domain	tcamnt	srcd1, crcd1, ercd1, srcd2, crcd2, ercd2, srcd3, crcd3, ercd3
| 	
| 	srcd1 = 0
| 	crcd1 = 0
| 	ercd1 = 0
| 	srcd2 = 0
| 	crcd2 = 0
| 	ercd2 = 0
| 	srcd3 = 0
| 	crcd3 = 0
| 	ercd3 = 0
| 	
| 	select	sum(tpisg302.srcd):srcd1,
| 		sum(tpisg302.crcd):crcd1,
| 		sum(tpisg302.ercd):ercd1,
| 		tpisg302.ccod
| 	from	tpisg302
| 	where	tpisg302._index1 = {:i.ccod}
| 	group by tpisg302.ccod
| 	selectdo
| 	selectempty
| 		srcd1 = 0
| 		crcd1 = 0
| 		ercd1 = 0
| 	endselect
| 	
| 	select	sum(tpisg303.srcd):srcd2,
| 		sum(tpisg303.crcd):crcd2,
| 		sum(tpisg303.ercd):ercd2,
| 		tpisg303.ccod
| 	from	tpisg303
| 	where	tpisg303._index1 = {:i.ccod}
| 	group by tpisg303.ccod
| 	selectdo
| 	selectempty
| 		srcd2 = 0
| 		crcd2 = 0
| 		ercd2 = 0
| 	endselect
| 	
| 	select	sum(tpisg304.srcd):srcd3,
| 		sum(tpisg304.crcd):crcd3,
| 		sum(tpisg304.ercd):ercd3,
| 		tpisg304.ccod
| 	from	tpisg304
| 	where	tpisg304._index1 = {:i.ccod}
| 	group by tpisg304.ccod
| 	selectdo
| 	selectempty
| 		srcd3 = 0
| 		crcd3 = 0
| 		ercd3 = 0
| 	endselect
| 	
| 	o.totl = srcd1 + crcd1 + ercd1 + srcd2 + crcd2 + ercd2 + srcd3 + crcd3 + ercd3
| }
												|#OLD
function get_cashflow_in_data(		domain	tcorno	i.ccod,
				ref	domain	tcamnt	o.totl	)
{
	select	sum(tpisg313.ramt):o.totl
	from	tpisg313
	where	tpisg313._index1 = {:i.ccod}
	selectdo
	selectempty
		o.totl = 0.0
	endselect
}


function calculate_actual_inflow_outflow(
						domain	tccprj		i.cprj,
						domain	tfgld.btno	i.btno,
						domain	tcncmp		i.ncmp,
						domain	tfcash.flow	i.ctyp,
					ref	domain	tcamnt		o.amnt
										)
{
	o.amnt = 0
	
	select	sum(tfisg041.amth):o.amnt  
	from	tfisg041
	where	tfisg041.cprj = :i.cprj
	and	tfisg041.ctyp = :i.ctyp
	and	tfisg041.btno = :i.btno
	and	tfisg041._compnr = :i.ncmp
	selectdo
	selectempty
		o.amnt = 0
	endselect
}

function get_contractwise_data(
				domain	tcorno	i.ccod
							)
{
	sum.amto = 0
	sum.amti = 0
	sum.oami = 0
	sum.oamo = 0
		
	select	sum(tpisg089.amto):sum.amto,
	 	sum(tpisg089.amti):sum.amti,
	 	sum(tpisg089.oami):sum.oami,
	 	sum(tpisg089.oamo):sum.oamo
	from	tpisg089
	where	tpisg089._index1 = {:i.ccod}
	selectdo
	selectempty
		sum.amto = 0
		sum.amti = 0
		sum.oami = 0
		sum.oamo = 0
	endselect
}

									
function get_receivable_details(
					domain	tcorno		i.ccod
									)
{
	domain	tcamnt		v.tot.diff
	domain	tfgld.date	docd
	curr.date = date.num()
	
	sum.rsnd = 0
	sum.rsum = 0
	sum.rsbm = 0
	sum.rscm = 0
	sum.rsdm = 0
	sum.rsgy = 0
	sum.rsmy = 0
	sum.rcnd = 0
	sum.rcum = 0
	sum.rcbm = 0
	sum.rccm = 0
	sum.rcdm = 0
	sum.rcgy = 0
	sum.rcmy = 0
	sum.rend = 0
	sum.reum = 0
	sum.rebm = 0
	sum.recm = 0
	sum.redm = 0
	sum.regy = 0
	sum.remy = 0
	
	select	tpisg088.cprj,
		tpisg088.ptyp,
		tppdm600.ncmp 
	from	tpisg088, tppdm600
	where	tpisg088._index1 = {:i.ccod}
	and	tpisg088.cprj refers to tppdm600 UNREF CLEAR
	selectdo
		tot.rec.catg.10 = 0.00
		total.receivable.catg.10(tot.rec.catg.10)
		v.tot.diff = 0.00
		on case etol(tpisg088.ptyp)
		case 1 :
			total.receivable.catg.3.4(tpisg088.ptyp)
			sum.rsmy = sum.rsmy + tot.rec.catg.10 
			if  sum.rsmy < 0 then	|more than 365 days
				sum.rsgy = sum.rsgy + sum.rsmy 
				sum.rsmy = 0
			endif	
			
			if sum.rsgy < 0 then	|181 to 365 days
				sum.rsdm = sum.rsdm + sum.rsgy 
				sum.rsgy = 0
			endif	
			
			if sum.rsdm < 0 then	|121 to 180 days
				sum.rscm = sum.rscm + sum.rsdm  
				sum.rsdm = 0
			endif	
			
			if sum.rscm  < 0 then	|91 to 120 days
				sum.rsbm = sum.rsbm + sum.rscm  
				sum.rscm = 0
			endif	
			
			if  sum.rsbm < 0 then	|61 to 90 days
				sum.rsum = sum.rsum + sum.rsbm  
				sum.rsbm = 0
			endif	
			
			if sum.rsum  < 0 then	|31 to 60 days
				sum.rsnd = sum.rsnd + sum.rsum 
				sum.rsum = 0
			endif
			
			if sum.rsnd < 0 then	|0 to 30 days
				sum.rsnd = 0
			endif

			get_unclaimed_retention(tpisg088.cprj, tppdm600.ncmp, d.amnt)
			SupplyUnclaimedRetention = SupplyUnclaimedRetention + d.amnt
			break
	
		case 2 :
			total.receivable.catg.3.4(tpisg088.ptyp)
			sum.rcmy = sum.rcmy + tot.rec.catg.10 
			if  sum.rcmy < 0 then	|more than 365 days
				sum.rcgy = sum.rcgy + sum.rcmy 
				sum.rcmy = 0
			endif	
			
			if sum.rcgy < 0 then	|181 to 365 days
				sum.rcdm = sum.rcdm + sum.rcgy 
				sum.rcgy = 0
			endif	
			
			if sum.rcdm < 0 then	|121 to 180 days
				sum.rccm = sum.rccm + sum.rcdm  
				sum.rcdm = 0
			endif	
			
			if sum.rccm  < 0 then	|91 to 120 days
				sum.rcbm = sum.rcbm + sum.rccm  
				sum.rccm = 0
			endif	
			
			if  sum.rcbm < 0 then	|61 to 90 days
				sum.rcum = sum.rcum + sum.rcbm  
				sum.rcbm = 0
			endif	
			
			if sum.rcum  < 0 then	|31 to 60 days
				sum.rcnd = sum.rcnd + sum.rcum 
				sum.rcum = 0
			endif
			
			if sum.rcnd < 0 then	|0 to 30 days
				sum.rcnd = 0
			endif
			
			get_unclaimed_retention(tpisg088.cprj, tppdm600.ncmp, d.amnt)
			CivilUnclaimedRetention = CivilUnclaimedRetention + d.amnt
			break
		case 3 :
			total.receivable.catg.3.4(tpisg088.ptyp)
			sum.remy = sum.remy + tot.rec.catg.10 
			if  sum.remy < 0 then	|more than 365 days
				sum.regy = sum.regy + sum.remy 
				sum.remy = 0
			endif	
			
			if sum.regy < 0 then	|181 to 365 days
				sum.redm = sum.redm + sum.regy 
				sum.regy = 0
			endif	
			
			if sum.redm < 0 then	|121 to 180 days
				sum.recm = sum.recm + sum.redm  
				sum.redm = 0
			endif	
			
			if sum.recm  < 0 then	|91 to 120 days
				sum.rebm = sum.rebm + sum.recm  
				sum.recm = 0
			endif	
			
			if  sum.rebm < 0 then	|61 to 90 days
				sum.reum = sum.reum + sum.rebm  
				sum.rebm = 0
			endif	
			
			if sum.reum  < 0 then	|31 to 60 days
				sum.rend = sum.rend + sum.reum 
				sum.reum = 0
			endif
			
			if sum.rend < 0 then	|0 to 30 days
				sum.rend = 0
			endif
			
			get_unclaimed_retention(tpisg088.cprj, tppdm600.ncmp, d.amnt)
			ErectionUnclaimedRetention = ErectionUnclaimedRetention + d.amnt
			break
		endcase
		
	endselect
}							
						
function total.receivable.catg.10(
					ref domain	tcamnt	net.amth.catg.10)
{					
	domain	tfgld.dbcr	i.dbcr
	domain	tcamnt		o.amth
	domain	tcamnt		debit.amth.catg.10,
				credit.amth.catg.10
	
	o.amth = 0.00
	net.amth.catg.10 = 0.00
	credit.amth.catg.10 = 0.00
	debit.amth.catg.10 = 0.00
	
	select	tfgld106.amth(1):o.amth, 
		tfgld106.dbcr:i.dbcr
	from	tfgld106,tfgld011	
	where	tfgld106._index1  = tfgld011.ttyp
	and	tfgld106.leac  in ("1520111","1520112","1520113","1520122")
	and	tfgld106.dim1 = :tpisg088.cprj
	and 	tfgld106._compnr = :tppdm600.ncmp
	and	tfgld011.ttyp not in ("OPB","AAR")
	and 	tfgld011.catg = 10
	selectdo
		on case etol(i.dbcr) 
			case 1:
				debit.amth.catg.10 = debit.amth.catg.10 + o.amth
				break
			case 2:			
				credit.amth.catg.10 = credit.amth.catg.10 + o.amth
				break
		endcase
	selectempty
		o.amth = 0.00
	endselect
		
	net.amth.catg.10 = (debit.amth.catg.10 - credit.amth.catg.10)  				
}						
					
function total.receivable.catg.3.4(domain	tpisg.ptyp	i.ptyp)

{	
	domain	tfgld.dbcr	i.dbcr
	domain	tfgld.date	dcdt
	domain	tfgld.ttyp	i.ttyp
	domain	tcamnt		o.amth	
	domain	tcamnt		net.amth.catg.3.or.4,
				debit.amth.catg.3.or.4,
				credit.amth.catg.3.or.4
	
	net.amth.catg.3.or.4 = 0.00
	debit.amth.catg.3.or.4  = 0.00
	credit.amth.catg.3.or.4 = 0.00
	o.amth = 0.00
	i.ttyp = ""
	dcdt = 0
	select	tfgld106.amth(1):o.amth, 
		tfgld106.dbcr:i.dbcr,
		tfgld011.ttyp:i.ttyp,
		tfgld106.dcdt:dcdt,
		tfgld011.catg
	from	tfgld106,tfgld011	
	where	tfgld106._index1  = tfgld011.ttyp
	and	tfgld106.leac  in ("1520111","1520112","1520113","1520122")
	and	tfgld106.dim1 = :tpisg088.cprj
	and 	tfgld106._compnr = :tppdm600.ncmp
	and	tfgld011.ttyp <> "OPB"
	and 	tfgld011.catg in(3,4,10)
	selectdo
		net.amth.catg.3.or.4 = 0
		debit.amth.catg.3.or.4  = 0.00
		credit.amth.catg.3.or.4 = 0.00
		on case etol(i.dbcr) 
			case 1:
				on case etol(tfgld011.catg)
				case 10:	
					if i.ttyp = "AAR" then
						debit.amth.catg.3.or.4 = o.amth
					endif
					break
					
				case 3:
				case 4:
					debit.amth.catg.3.or.4 =  o.amth
					break
				endcase
				break
			case 2:		
				on case etol(tfgld011.catg)
				case 10:	
					if i.ttyp = "AAR" then
						credit.amth.catg.3.or.4 =  o.amth
					endif
					break
					
				case 3:
				case 4:
					credit.amth.catg.3.or.4 =  o.amth
					break
				endcase	
				break
			endcase
		
		net.amth.catg.3.or.4 = (debit.amth.catg.3.or.4 - credit.amth.catg.3.or.4) 
	on case etol(i.ptyp)
	case 1:

		if (curr.date - dcdt) >= 0  
			and (curr.date - dcdt) <= 30	then
					
			sum.rsnd = sum.rsnd + net.amth.catg.3.or.4
		else 
			if (curr.date - dcdt) > 30 
				and (curr.date - dcdt)	<= 60 then
						
				sum.rsum = sum.rsum + net.amth.catg.3.or.4
			else
				if (curr.date - dcdt) > 60 
					and (curr.date - dcdt)	<= 90 then
					
					sum.rsbm = sum.rsbm + net.amth.catg.3.or.4
				else
					if (curr.date - dcdt) > 90 
						and (curr.date - dcdt)	<= 120 then
						
						sum.rscm = sum.rscm + net.amth.catg.3.or.4
					else
						if (curr.date - dcdt) > 120 
							and (curr.date - dcdt)	<= 180 then
							
							sum.rsdm = sum.rsdm + net.amth.catg.3.or.4
						else
							if (curr.date - dcdt) > 180
								and (curr.date - dcdt)	<= 365 then
								sum.rsgy = sum.rsgy + net.amth.catg.3.or.4
							else
								if (curr.date - dcdt) > 365 then
									sum.rsmy = sum.rsmy + net.amth.catg.3.or.4
								endif
							endif
						endif
					endif
				endif
			endif
		endif
		break
	case 2:

		if (curr.date - dcdt) >= 0  
			and (curr.date - dcdt) <= 30	then
					
			sum.rcnd = sum.rcnd + net.amth.catg.3.or.4
		else 
			if (curr.date - dcdt) > 30 
				and (curr.date - dcdt)	<= 60 then
						
				sum.rcum = sum.rcum + net.amth.catg.3.or.4
			else
				if (curr.date - dcdt) > 60 
					and (curr.date - dcdt)	<= 90 then
					
					sum.rcbm = sum.rcbm + net.amth.catg.3.or.4
				else
					if (curr.date - dcdt) > 90 
						and (curr.date - dcdt)	<= 120 then
						
						sum.rccm = sum.rccm + net.amth.catg.3.or.4
					else
						if (curr.date - dcdt) > 120 
							and (curr.date - dcdt)	<= 180 then
							
							sum.rcdm = sum.rcdm + net.amth.catg.3.or.4
						else
							if (curr.date - dcdt) > 180
								and (curr.date - dcdt)	<= 365 then
									
								sum.rcgy = sum.rcgy + net.amth.catg.3.or.4
							else
								if (curr.date - dcdt) > 365 then
									sum.rcmy = sum.rcmy + net.amth.catg.3.or.4
								endif
							endif
						endif
					endif
				endif
			endif
		endif
		break
	case 3:

		if (curr.date - dcdt) >= 0  
			and (curr.date - dcdt) <= 30	then
					
			sum.rend = sum.rend + net.amth.catg.3.or.4
		else 
			if (curr.date - dcdt) > 30 
				and (curr.date - dcdt)	<= 60 then
						
				sum.reum = sum.reum + net.amth.catg.3.or.4
			else
				if (curr.date - dcdt) > 60 
					and (curr.date - dcdt)	<= 90 then
					
					sum.rebm = sum.rebm + net.amth.catg.3.or.4
				else
					if (curr.date - dcdt) > 90 
						and (curr.date - dcdt)	<= 120 then
						
						sum.recm = sum.recm + net.amth.catg.3.or.4
					else
						if (curr.date - dcdt) > 120 
							and (curr.date - dcdt)	<= 180 then
							
							sum.redm = sum.redm + net.amth.catg.3.or.4
						else
							if (curr.date - dcdt) > 180
								and (curr.date - dcdt)	<= 365 then
									
								sum.regy = sum.regy + net.amth.catg.3.or.4
							else
								if (curr.date - dcdt) > 365 then
									sum.remy = sum.remy + net.amth.catg.3.or.4
								endif
							endif
						endif
					endif
				endif
			endif
		endif
		break
	endcase
	
	selectempty
		o.amth = 0.00
		dcdt = 0
		i.ttyp = ""	
	endselect

}
											
		
									
function get_unclaimed_retention(
					domain	tccprj	i.cprj,
					domain	tcncmp	i.ncmp,
				ref	domain	tcamnt	o.amnt
								)
{
	c.amnt = 0
	
	|*CREDIT
	select	sum(tfgld106.amth(1)):c.amnt
	from	tfgld106 
	where	tfgld106._index1  <> "OPB"
	and	tfgld106._index3 = "1520132"
	and	tfgld106.dbcr = 2
	and	tfgld106.dim1 = :i.cprj
	and 	tfgld106._compnr = :i.ncmp
	selectdo
	endselect
	
	d.amnt = 0
	
	|*DEBIT
	select	sum(tfgld106.amth(1)):d.amnt
	from	tfgld106 
	where	tfgld106._index1  <> "OPB"
	and	tfgld106._index3 = "1520132"
	and	tfgld106.dbcr = 1
	and	tfgld106.dim1 = :i.cprj
	and 	tfgld106._compnr = :i.ncmp
	selectdo
	endselect
	
	o.amnt = 0
	o.amnt = c.amnt - d.amnt
}
|****************************************************************************************************
|Insert & Update in "tpisg305"
|****************************************************************************************************
function insert_update_in_tpisg305_for_desc(
						domain	tcorno		i.ccod,
						domain	tcmcs.str100	i.csdc
										)
{
	select	tpisg305.*
	from	tpisg305 for update
	where	tpisg305._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg305.user = logname$
		tpisg305.csdc = i.csdc
		tpisg305.bdgd = sum.ibud
		tpisg305.aled = sum.tcst
		tpisg305.ccod = i.ccod
| 		tpisg305.cbda = sum.cbac										|09.05.19.Adarsh.o
		tpisg305.cbda = sum.cbac + sum.niba									|09.05.19.Adarsh.n
		tpisg305.cycn = sum.cont
		tpisg305.sson = tpisg305.bdgd - tpisg305.aled
		tpisg305.stcs = sum.stcs
		tpisg305.cysc = sum.cons
		tpisg305.coco = sum.exhd
		tpisg305.updt = utc.num()
		db.update(ttpisg305, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg305.user = logname$
			tpisg305.csdc = i.csdc
			tpisg305.bdgd = sum.ibud
			tpisg305.aled = sum.tcst
			tpisg305.cycn = sum.cont
			tpisg305.ccod = i.ccod
| 			tpisg305.cbda = sum.cbac									|09.05.19.Adarsh.o
			tpisg305.cbda = sum.cbac + sum.niba								|09.05.19.Adarsh.n
			tpisg305.sson = tpisg305.bdgd - tpisg305.aled
			tpisg305.stcs = sum.stcs
			tpisg305.cysc = sum.cons
			tpisg305.coco = sum.exhd
			tpisg305.updt = utc.num()
			db.insert(ttpisg305, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}

function get_data_from_tpisg058_for_desc_for_all_element(
								domain	tcorno		i.ccod,
								domain	tpisg.ptyp	i.ptyp
												)
{
	sum.ibud = 0
	sum.tcst = 0
	sum.stcs = 0
	sum.cons = 0
	sum.exhd = 0
	sum.cbac = 0
	sum.cont = 0

	select	sum(tpisg058.ibud):sum.ibud,
		sum(tpisg058.tcst):sum.tcst,
		sum(tpisg058.stcs):sum.stcs,
		sum(tpisg058.cons):sum.cons,
		sum(tpisg058.exhd):sum.exhd,
		sum(tpisg058.cbac):sum.cbac,
		sum(tpisg058.cont):sum.cont,
		sum(tpisg058.niba):sum.niba,										|09.05.19.Adarsh.n
		tpisg058.revn
	from	tpisg058
	where	tpisg058.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, :i.ptyp})
	and	tpisg058.levl = 2
	group by tpisg058.revn 
	order by tpisg058.revn desc
	selectdo
	selectempty
		flag = tcyesno.yes
	endselect
}

function get_data_from_tpisg058_for_desc_for_some_element(
								domain	tcorno		i.ccod,
								domain	tpisg.ptyp	i.ptyp,
								domain	tppdm.cspa	i.elem
												)
{
	sum.ibud = 0
	sum.tcst = 0
	sum.stcs = 0
	sum.cons = 0
	sum.exhd = 0
	sum.cbac = 0
	sum.cont = 0
	
	select	sum(tpisg058.ibud):sum.ibud,
		sum(tpisg058.tcst):sum.tcst,
		sum(tpisg058.stcs):sum.stcs,
		sum(tpisg058.cons):sum.cons,
		sum(tpisg058.exhd):sum.exhd,
		sum(tpisg058.cbac):sum.cbac,
		sum(tpisg058.cont):sum.cont,
		sum(tpisg058.niba):sum.niba,										|09.05.19.Adarsh.n
		tpisg058.revn
	from	tpisg058
	where	tpisg058.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, :i.ptyp})						|09.05.19.Adarsh.o
	and	tpisg058.elem(1;1) not in (:i.elem,"C")								|09.05.19.Adarsh.n
	and	tpisg058.levl = 2
	group by tpisg058.revn 
	order by tpisg058.revn desc
	selectdo
	selectempty
		flag = tcyesno.yes
	endselect
}

function get_data_from_tpisg058_for_fixed_element(
							domain	tcorno		i.ccod,
							domain	tpisg.ptyp	i.ptyp,
							domain	tppdm.cspa	i.elem
												)
{
	sum.ibud = 0
	sum.tcst = 0
	sum.stcs = 0
	sum.cons = 0
	sum.exhd = 0
	sum.cbac = 0
	sum.cont = 0
	
	select	sum(tpisg058.ibud):sum.ibud,
		sum(tpisg058.tcst):sum.tcst,
		sum(tpisg058.stcs):sum.stcs,
		sum(tpisg058.cons):sum.cons,
		sum(tpisg058.exhd):sum.exhd,
		sum(tpisg058.cbac):sum.cbac,
		sum(tpisg058.cont):sum.cont,
		sum(tpisg058.niba):sum.niba,										|09.05.19.Adarsh.n
		tpisg058.revn
	from	tpisg058
	where	tpisg058.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, :i.ptyp})
	and	tpisg058.elem = :i.elem
	group by tpisg058.revn 
	order by tpisg058.revn desc
	selectdo
	selectempty
		flag = tcyesno.yes	
	endselect
}										

function get_data_from_tpisg057_for_desc(
						domain	tcorno		i.ccod,
						domain	tpisg.ptyp	i.ptyp
									)
{
	sum.bcth = 0
	sum.ctoh = 0
	sum.eitl = 0
	
	select	sum(tpisg057.bcth):sum.bcth,
		sum(tpisg057.ctoh):sum.ctoh,
		sum(tpisg057.eitl):sum.eitl,
		tpisg057.revn
	from	tpisg057
	where	tpisg057.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, :i.ptyp})
	group by tpisg057.revn 
	order by tpisg057.revn desc
	selectdo
	selectempty
		flag = tcyesno.yes
	endselect
}

function insert_update_in_tpisg305_for_desc_for_some_fields1(
								domain	tcorno		i.ccod,
								domain	tcmcs.str100	i.csdc
												)
{
	select	tpisg305.*
	from	tpisg305 for update
	where	tpisg305._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg305.user = logname$
		tpisg305.csdc = i.csdc
		tpisg305.bdgd = sum.eitl
		tpisg305.aled = 0
		tpisg305.ccod = i.ccod
		tpisg305.cbda = 0
		tpisg305.sson = sum.eitl
		tpisg305.stcs = 0
		tpisg305.cysc = 0
		tpisg305.coco = 0
		tpisg305.updt = utc.num()
		db.update(ttpisg305, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg305.user = logname$
			tpisg305.csdc = i.csdc
			tpisg305.bdgd = sum.eitl
			tpisg305.aled = 0
			tpisg305.ccod = i.ccod
			tpisg305.cbda = 0
			tpisg305.sson = sum.eitl
			tpisg305.stcs = 0
			tpisg305.cysc = 0
			tpisg305.coco = 0
			tpisg305.updt = utc.num()
			db.insert(ttpisg305, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}



function insert_update_in_tpisg305_for_desc_for_some_fields2(
								domain	tcorno		i.ccod,
								domain	tcmcs.str100	i.csdc
												)
{
	select	tpisg305.*
	from	tpisg305 for update
	where	tpisg305._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg305.user = logname$
		tpisg305.csdc = i.csdc
		tpisg305.bdgd = sum.bcth
		tpisg305.aled = 0
		tpisg305.ccod = i.ccod
		tpisg305.cbda = 0
		tpisg305.sson = sum.ctoh
		tpisg305.stcs = 0
		tpisg305.cysc = 0
		tpisg305.coco = 0
		tpisg305.updt = utc.num()
		db.update(ttpisg305, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg305.user = logname$
			tpisg305.csdc = i.csdc
			tpisg305.bdgd = sum.bcth
			tpisg305.aled = 0
			tpisg305.ccod = i.ccod
			tpisg305.cbda = 0
			tpisg305.sson = sum.ctoh
			tpisg305.stcs = 0
			tpisg305.cysc = 0
			tpisg305.coco = 0
			tpisg305.updt = utc.num()
			db.insert(ttpisg305, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}

|****************************************************************************************************
|Insert & Update in "tpisg306"
|****************************************************************************************************

function insert_update_in_tpisg306_for_desc(
						domain	tcorno		i.ccod,
						domain	tcmcs.str100	i.csdc
										)
{
	select	tpisg306.*
	from	tpisg306 for update
	where	tpisg306._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg306.user = logname$
		tpisg306.csdc = i.csdc
		tpisg306.bdgd = sum.ibud
		tpisg306.aled = sum.tcst
		tpisg306.ccod = i.ccod
| 		tpisg306.cbda = sum.cbac										|09.05.19.Adarsh.o										
		tpisg306.cbda = sum.cbac + sum.niba									|09.05.19.Adarsh.n										
		tpisg306.cycn = sum.cont
		tpisg306.sson = tpisg306.bdgd - tpisg306.aled
		tpisg306.stcs = sum.stcs
		tpisg306.cysc = sum.cons
		tpisg306.coco = sum.exhd
		tpisg306.updt = utc.num()
		db.update(ttpisg306, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg306.user = logname$
			tpisg306.csdc = i.csdc
			tpisg306.bdgd = sum.ibud
			tpisg306.aled = sum.tcst
			tpisg306.ccod = i.ccod
| 			tpisg306.cbda = sum.cbac									|09.05.19.Adarsh.o
			tpisg306.cbda = sum.cbac + sum.niba								|09.05.19.Adarsh.n
			tpisg306.sson = tpisg306.bdgd - tpisg306.aled
			tpisg306.stcs = sum.stcs
			tpisg306.cycn = sum.cont
			tpisg306.cysc = sum.cons
			tpisg306.coco = sum.exhd
			tpisg306.updt = utc.num()
			db.insert(ttpisg306, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}

function insert_update_in_tpisg306_for_some_fields(
						domain	tcorno		i.ccod,
						domain	tcmcs.str100	i.csdc
										)
{
	select	tpisg306.*
	from	tpisg306 for update
	where	tpisg306._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg306.user = logname$
		tpisg306.csdc = i.csdc
		tpisg306.bdgd = sum.bcth
		tpisg306.aled = 0
		tpisg306.ccod = i.ccod
		tpisg306.cbda = 0
		tpisg306.cycn = 0
		tpisg306.sson = sum.ctoh
		tpisg306.stcs = 0
		tpisg306.cysc = 0
		tpisg306.coco = 0
		tpisg306.updt = utc.num()
		db.update(ttpisg306, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg306.user = logname$
			tpisg306.csdc = i.csdc
			tpisg306.bdgd = sum.bcth
			tpisg306.aled = 0
			tpisg306.ccod = i.ccod
			tpisg306.cbda = 0
			tpisg306.cycn = 0
			tpisg306.sson = sum.ctoh
			tpisg306.stcs = 0
			tpisg306.cysc = 0
			tpisg306.coco = 0
			tpisg306.updt = utc.num()
			db.insert(ttpisg306, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}

function get_data_from_tpisg058_for_services_cost(
						domain	tcorno		i.ccod,
						domain	tpisg.ptyp	i.ptyp,
						domain	tppdm.cspa	i.elem1,
						domain	tppdm.cspa	i.elem2
									)
{
	sum.ibud = 0
	sum.tcst = 0
	sum.stcs = 0
	sum.cons = 0
	sum.exhd = 0
	sum.cbac = 0
	sum.cont = 0
	
	select	sum(tpisg058.ibud):sum.ibud,
		sum(tpisg058.tcst):sum.tcst,
		sum(tpisg058.stcs):sum.stcs,
		sum(tpisg058.cons):sum.cons,
		sum(tpisg058.exhd):sum.exhd,
		sum(tpisg058.cbac):sum.cbac,
		sum(tpisg058.cont):sum.cont,
		sum(tpisg058.niba):sum.niba,										|09.05.19.Adarsh.n
		tpisg058.revn
	from	tpisg058
	where	tpisg058.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, :i.ptyp})
	and	((tpisg058.elem = :i.elem1) or (tpisg058.elem = :i.elem2))	
	group by tpisg058.revn 
	order by tpisg058.revn desc
	selectdo
	selectempty
		flag = tcyesno.yes
	endselect
}
|****************************************************************************************************
|Insert & Update in "tpisg307"
|****************************************************************************************************

function insert_update_in_tpisg307_for_desc(
						domain	tcorno		i.ccod,
						domain	tcmcs.str100	i.csdc
										)
{
	select	tpisg307.*
	from	tpisg307 for update
	where	tpisg307._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg307.user = logname$
		tpisg307.csdc = i.csdc
		tpisg307.bdgd = sum.ibud
		tpisg307.aled = sum.tcst
		tpisg307.ccod = i.ccod
| 		tpisg307.cbda = sum.cbac										|09.05.19.Adarsh.o
		tpisg307.cbda = sum.cbac + sum.niba									|09.05.19.Adarsh.n
		tpisg307.cycn = sum.cont
		tpisg307.sson = tpisg307.bdgd - tpisg307.aled
		tpisg307.stcs = sum.stcs
		tpisg307.cysc = sum.cons
		tpisg307.coco = sum.exhd
		tpisg307.updt = utc.num()
		db.update(ttpisg307, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg307.user = logname$
			tpisg307.csdc = i.csdc
			tpisg307.bdgd = sum.ibud
			tpisg307.aled = sum.tcst
			tpisg307.ccod = i.ccod
| 			tpisg307.cbda = sum.cbac									|09.05.19.Adarsh.o
			tpisg307.cbda = sum.cbac + sum.niba								|09.05.19.Adarsh.n
			tpisg307.cycn = sum.cont
			tpisg307.sson = tpisg307.bdgd - tpisg307.aled
			tpisg307.stcs = sum.stcs
			tpisg307.cysc = sum.cons
			tpisg307.coco = sum.exhd
			tpisg307.updt = utc.num()
			db.insert(ttpisg307, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}

function insert_update_in_tpisg307_for_some_fields(
						domain	tcorno		i.ccod,
						domain	tcmcs.str100	i.csdc
										)
{
	select	tpisg307.*
	from	tpisg307 for update
	where	tpisg307._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg307.user = logname$
		tpisg307.csdc = i.csdc
		tpisg307.bdgd = sum.bcth
		tpisg307.aled = 0
		tpisg307.ccod = i.ccod
		tpisg307.cbda = 0
		tpisg307.cycn = 0
		tpisg307.sson = sum.ctoh
		tpisg307.stcs = 0
		tpisg307.cysc = 0
		tpisg307.coco = 0
		tpisg307.updt = utc.num()
		db.update(ttpisg307, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		if flag <> tcyesno.yes	then 
			tpisg307.user = logname$
			tpisg307.csdc = i.csdc
			tpisg307.bdgd = sum.bcth
			tpisg307.aled = 0
			tpisg307.ccod = i.ccod
			tpisg307.cbda = 0
			tpisg307.cycn = 0
			tpisg307.sson = sum.ctoh
			tpisg307.stcs = 0
			tpisg307.cysc = 0
			tpisg307.coco = 0
			tpisg307.updt = utc.num()
			db.insert(ttpisg307, db.skip.dupl, e)
			if not e then 
				commit.transaction()
			else
				abort.transaction()
			endif
		endif
	endselect
}

function insert_update_in_tpisg308_for_desc(
						domain	tcorno		i.ccod,
						domain	tcmcs.str100	i.csdc
										)
{
	get_data_on_basis_contract_and_costsheet_desc(i.ccod, i.csdc)
	
	select	tpisg308.*
	from	tpisg308 for update
	where	tpisg308._index1 = {:i.ccod, :i.csdc}
	selectdo
		tpisg308.user = logname$
		tpisg308.csdc = i.csdc
		tpisg308.bdgd = sum.bdgd
		tpisg308.aled = sum.aled
		tpisg308.ccod = i.ccod
		tpisg308.cbda = sum.cbda
		tpisg308.cycn = sum.cycn
		tpisg308.sson = sum.sson
		tpisg308.stcs = sum.stcs
		tpisg308.cysc = sum.cysc
		tpisg308.coco = sum.coco
		tpisg308.updt = utc.num()
		db.update(ttpisg308, db.retry, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	selectempty
		tpisg308.user = logname$
		tpisg308.csdc = i.csdc
		tpisg308.bdgd = sum.bdgd
		tpisg308.aled = sum.aled
		tpisg308.ccod = i.ccod
		tpisg308.cbda = sum.cbda
		tpisg308.cycn = sum.cycn
		tpisg308.sson = sum.sson
		tpisg308.stcs = sum.stcs
		tpisg308.cysc = sum.cysc
		tpisg308.coco = sum.coco
		tpisg308.updt = utc.num()
		db.insert(ttpisg308, db.skip.dupl, e)
		if not e then 
			commit.transaction()
		else
			abort.transaction()
		endif
	endselect
}

function get_data_on_basis_contract_and_costsheet_desc(
								domain	tcorno		i.ccod,
								domain	tcmcs.str100	io.csdc
												)
{
	initialize()
	
	select	sum(tpisg305.bdgd):sum.bdgd1,
		sum(tpisg305.aled):sum.aled1,
		sum(tpisg305.cbda):sum.cbda1,
		sum(tpisg305.cycn):sum.cycn1,
		sum(tpisg305.sson):sum.sson1,
		sum(tpisg305.stcs):sum.stcs1,
		sum(tpisg305.cysc):sum.cysc1,
		sum(tpisg305.coco):sum.coco1
	from	tpisg305
	where	tpisg305._index1 = {:i.ccod, :io.csdc}
	group by tpisg305._index1
	selectdo
	endselect
	
	select	sum(tpisg306.bdgd):sum.bdgd2,
		sum(tpisg306.aled):sum.aled2,
		sum(tpisg306.cbda):sum.cbda2,
		sum(tpisg306.cycn):sum.cycn2,
		sum(tpisg306.sson):sum.sson2,
		sum(tpisg306.stcs):sum.stcs2,
		sum(tpisg306.cysc):sum.cysc2,
		sum(tpisg306.coco):sum.coco2
	from	tpisg306
	where	tpisg306._index1 = {:i.ccod, :io.csdc}
	group by tpisg306._index1
	selectdo
	endselect
	
	select	sum(tpisg307.bdgd):sum.bdgd3,
		sum(tpisg307.aled):sum.aled3,
		sum(tpisg307.cbda):sum.cbda3,
		sum(tpisg307.cycn):sum.cycn3,
		sum(tpisg307.sson):sum.sson3,
		sum(tpisg307.stcs):sum.stcs3,
		sum(tpisg307.cysc):sum.cysc3,
		sum(tpisg307.coco):sum.coco3
	from	tpisg307
	where	tpisg307._index1 = {:i.ccod, :io.csdc}
	group by tpisg307._index1
	selectdo
	endselect
	
	sum.bdgd = sum.bdgd1 + sum.bdgd2 + sum.bdgd3
	sum.aled = sum.aled1 + sum.aled2 + sum.aled3
	sum.cbda = sum.cbda1 + sum.cbda2 + sum.cbda3
	sum.cycn = sum.cycn1 + sum.cycn2 + sum.cycn3
	sum.sson = sum.sson1 + sum.sson2 + sum.sson3
	sum.stcs = sum.stcs1 + sum.stcs2 + sum.stcs3
	sum.cysc = sum.cysc1 + sum.cysc2 + sum.cysc3
	sum.coco = sum.coco1 + sum.coco2 + sum.coco3
}

function initialize()
{
	sum.bdgd = 0
	sum.aled = 0
	sum.cbda = 0
	sum.cycn = 0
	sum.sson = 0
	sum.stcs = 0
	sum.cysc = 0
	sum.coco = 0
	sum.bdgd1 = 0
	sum.aled1 = 0
	sum.cbda1 = 0
	sum.cycn1 = 0
	sum.sson1 = 0
	sum.stcs1 = 0
	sum.cysc1 = 0
	sum.coco1 = 0
	sum.bdgd2 = 0
	sum.aled2 = 0
	sum.cbda2 = 0
	sum.cycn2 = 0
	sum.sson2 = 0
	sum.stcs2 = 0
	sum.cysc2 = 0
	sum.coco2 = 0
	sum.bdgd3 = 0
	sum.aled3 = 0
	sum.cbda3 = 0
	sum.cycn3 = 0
	sum.sson3 = 0
	sum.stcs3 = 0
	sum.cysc3 = 0
	sum.coco3 = 0
}
										|#OLD
| function get_data_for_insert_update(
| 					domain	tcorno		i.ccod,
| 					domain	tdisg.ptyp	PaymentType
| 										)
| {
| 	domain	tcpono		srno
| 	domain	tcmcs.str100	desc
| 	
| 	srno = 0
| 	
| 	SupplyAmt = 0
| 	CivilAmt = 0
| 	ErectionAmt = 0
| 	
| 	select	tpisg085.desc:desc
| 	from	tpisg085
| 	where	tpisg085.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod})
| 	and	tpisg085.ptyp = :PaymentType
| 	group by tpisg085.desc
| 	selectdo
| 		select	sum(tpisg085.amnt):SupplyAmt
| 		from	tpisg085
| 		where	tpisg085.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, tpisg.ptyp.supply})
| 		and	tpisg085.ptyp = :PaymentType
| 		and	tpisg085.desc = :desc 
| 		selectdo
| 		selectempty
| 			SupplyAmt = 0
| 		endselect
| 		
| 		select	sum(tpisg085.amnt):CivilAmt
| 		from	tpisg085
| 		where	tpisg085.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, tpisg.ptyp.civil})
| 		and	tpisg085.ptyp = :PaymentType
| 		and	tpisg085.desc = :desc
| 		selectdo
| 		selectempty
| 			CivilAmt = 0
| 		endselect
| 		
| 		select	sum(tpisg085.amnt):ErectionAmt
| 		from	tpisg085
| 		where	tpisg085.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod, tpisg.ptyp.erection})
| 		and	tpisg085.ptyp = :PaymentType
| 		and	tpisg085.desc = :desc
| 		selectdo
| 		selectempty
| 			ErectionAmt = 0
| 		endselect
| 		
| 		srno = srno + 1
| 		if PaymentType = tdisg.ptyp.advance then	|Advance
| 			insert_update_tpisg302(i.ccod, srno, desc)
| 			else if	PaymentType = tdisg.ptyp.retention then		|Retention
| 				insert_update_tpisg304(i.ccod, srno, desc)
| 				else if	PaymentType = tdisg.ptyp.netpay	then		|Netpay
| 					insert_update_tpisg303(i.ccod, srno, desc)
| 				endif
| 			endif
| 		endif
| 	endselect
| 	
| 	if PaymentType = tdisg.ptyp.advance then	|Advance
| 		get_data_from_ledger_for_tpisg302(i.ccod)
| 		insert_update_tpisg302(i.ccod, 1, desc)
| 		
| 		else if	PaymentType = tdisg.ptyp.retention then		|Retention
| 			get_data_from_ledger_for_tpisg304(i.ccod)
| 			insert_update_tpisg304(i.ccod, 1, desc)
| 			
| 			else if	PaymentType = tdisg.ptyp.netpay	then		|Netpay
| 				get_data_from_ledger_for_tpisg303(i.ccod)
| 				insert_update_tpisg303(i.ccod, 1, desc)
| 			endif
| 		endif
| 	endif
| }

| function insert_update_tpisg302(
| 					domain	tcorno		i.ccod,
| 					domain	tcpono		i.srno,
| 					domain	tcmcs.str100	i.desc
| 									)
| {
| 	select	tpisg302.*
| 	from	tpisg302 for update
| 	where	tpisg302._index1 = {:i.ccod, :i.srno}
| 	selectdo
| 		tpisg302.srcd = TotalReceivedSupplyNetAmnt
| 		tpisg302.crcd = TotalReceivedCivilNetAmnt
| 		tpisg302.ercd = TotalReceivedErectionNetAmnt
| 		db.update(ttpisg302, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	selectempty
| 		tpisg302.user = logname$
| 		tpisg302.paym = i.desc
| 		tpisg302.samt = SupplyAmt
| 		tpisg302.camt = CivilAmt
| 		tpisg302.eamt = ErectionAmt
| 		tpisg302.srcd = 0
| 		tpisg302.crcd = 0
| 		tpisg302.ercd = 0
| 		tpisg302.ccod = i.ccod
| 		tpisg302.updt = utc.num()
| 		tpisg302.srno = i.srno
| 		db.insert(ttpisg302, db.skip.dupl, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }
| function insert_update_tpisg303(
| 					domain	tcorno		i.ccod,
| 					domain	tcpono		i.srno,
| 					domain	tcmcs.str100	i.desc
| 									)
| {
| 	select	tpisg303.*
| 	from	tpisg303 for update
| 	where	tpisg303._index1 = {:i.ccod, :i.srno}
| 	selectdo
| 		tpisg303.srcd = TotalReceivedSupplyNetAmnt
| 		tpisg303.crcd = TotalReceivedCivilNetAmnt
| 		tpisg303.ercd = TotalReceivedErectionNetAmnt
| 		db.update(ttpisg303, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	selectempty
| 		tpisg303.user = logname$
| 		tpisg303.paym = i.desc
| 		tpisg303.samt = SupplyAmt
| 		tpisg303.camt = CivilAmt
| 		tpisg303.eamt = ErectionAmt
| 		tpisg303.srcd = 0
| 		tpisg303.crcd = 0
| 		tpisg303.ercd = 0
| 		tpisg303.ccod = i.ccod
| 		tpisg303.updt = utc.num()
| 		tpisg303.srno = i.srno
| 		db.insert(ttpisg303, db.skip.dupl, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }
| function insert_update_tpisg304(
| 					domain	tcorno		i.ccod,
| 					domain	tcpono		i.srno,
| 					domain	tcmcs.str100	i.desc
| 									)
| {
| 	select	tpisg304.*
| 	from	tpisg304 for update
| 	where	tpisg304._index1 = {:i.ccod, :i.srno}
| 	selectdo
| 		tpisg304.srcd = TotalReceivedSupply
| 		tpisg304.crcd = TotalReceivedCivil
| 		tpisg304.ercd = TotalReceivedErection
| 		db.update(ttpisg304, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	selectempty
| 		tpisg304.user = logname$
| 		tpisg304.paym = i.desc
| 		tpisg304.samt = SupplyAmt
| 		tpisg304.camt = CivilAmt
| 		tpisg304.eamt = ErectionAmt
| 		tpisg304.srcd = 0
| 		tpisg304.crcd = 0
| 		tpisg304.ercd = 0
| 		tpisg304.ccod = i.ccod
| 		tpisg304.updt = utc.num()
| 		tpisg304.srno = i.srno
| 		db.insert(ttpisg304, db.skip.dupl, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }
| function get_data_from_ledger_for_tpisg302(
| 						domain	tcorno	i.ccod
| 									)
| {
| 	TotalReceivedSupplyNetAmnt = 0
| 	TotalReceivedCivilNetAmnt = 0
| 	TotalReceivedErectionNetAmnt = 0
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.supply}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr
| 		from	tfgld106 
| 		where	tfgld106._index3 = "2510311"
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp not in ("AAR","AUR")
| 		and	tfgld106.otyp <> "OPB"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :				|*DEBIT
| 				TotalReceivedSupplyNetAmnt = TotalReceivedSupplyNetAmnt - tfgld106.amnt
| 				break
| 				
| 			case 2 :				|*CREDIT
| 				TotalReceivedSupplyNetAmnt = TotalReceivedSupplyNetAmnt + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.civil}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr
| 		from	tfgld106 
| 		where	tfgld106._index3 = "2510311"
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp not in ("AAR","AUR")
| 		and	tfgld106.otyp <> "OPB"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :				|*DEBIT
| 				TotalReceivedCivilNetAmnt = TotalReceivedCivilNetAmnt - tfgld106.amnt
| 				break
| 				
| 			case 2 :				|*CREDIT
| 				TotalReceivedCivilNetAmnt = TotalReceivedCivilNetAmnt + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.erection}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr
| 		from	tfgld106 
| 		where	tfgld106._index3 = "2510311"
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp not in ("AAR","AUR")
| 		and	tfgld106.otyp <> "OPB"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				TotalReceivedErectionNetAmnt = TotalReceivedErectionNetAmnt - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				TotalReceivedErectionNetAmnt = TotalReceivedErectionNetAmnt + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| }

| function get_data_from_ledger_for_tpisg303(
| 						domain	tcorno	i.ccod
| 									)
| {
| 	ReceivedSupplyNetAmnt1 = 0
| 	ReceivedSupplyNetAmnt2 = 0
| 	TotalReceivedSupplyNetAmnt = 0
| 	TotalReceivedCivilNetAmnt = 0
| 	TotalReceivedErectionNetAmnt = 0
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.supply}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111", "1520112", "1520113", "1520121", "1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				ReceivedSupplyNetAmnt1 = ReceivedSupplyNetAmnt1 - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				ReceivedSupplyNetAmnt1 = ReceivedSupplyNetAmnt1 + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111", "1520112", "1520113", "1520121", "1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and	tfgld106.ctyp = "SRC"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				ReceivedSupplyNetAmnt2 = ReceivedSupplyNetAmnt2 - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				ReceivedSupplyNetAmnt2 = ReceivedSupplyNetAmnt2 + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	TotalReceivedSupplyNetAmnt = ReceivedSupplyNetAmnt1 - ReceivedSupplyNetAmnt2
| 	
| 	ReceivedSupplyNetAmnt1 = 0
| 	ReceivedSupplyNetAmnt2 = 0
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.civil}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111", "1520112", "1520113", "1520121", "1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				ReceivedSupplyNetAmnt1 = ReceivedSupplyNetAmnt1 - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				ReceivedSupplyNetAmnt1 = ReceivedSupplyNetAmnt1 + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111", "1520112", "1520113", "1520121", "1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and	tfgld106.ctyp = "SRC"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				ReceivedSupplyNetAmnt2 = ReceivedSupplyNetAmnt2 - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				ReceivedSupplyNetAmnt2 = ReceivedSupplyNetAmnt2 + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	TotalReceivedCivilNetAmnt = ReceivedSupplyNetAmnt1 - ReceivedSupplyNetAmnt2
| 	
| 	ReceivedSupplyNetAmnt1 = 0
| 	ReceivedSupplyNetAmnt2 = 0
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.erection}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111", "1520112", "1520113", "1520121", "1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				ReceivedSupplyNetAmnt1 = ReceivedSupplyNetAmnt1 - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				ReceivedSupplyNetAmnt1 = ReceivedSupplyNetAmnt1 + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111", "1520112", "1520113", "1520121", "1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and	tfgld106.ctyp = "SRC"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				ReceivedSupplyNetAmnt2 = ReceivedSupplyNetAmnt2 - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				ReceivedSupplyNetAmnt2 = ReceivedSupplyNetAmnt2 + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	TotalReceivedErectionNetAmnt = ReceivedSupplyNetAmnt1 - ReceivedSupplyNetAmnt2
| }

| function get_data_from_ledger_for_tpisg304(
| 						domain	tcorno	i.ccod
| 									)
| {
| 	TotalReceivedSupply = 0
| 	TotalReceivedCivil = 0
| 	TotalReceivedErection = 0
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.supply}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111","1520112","1520113","1520121","1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and	tfgld106.ctyp = "SRC"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				TotalReceivedSupply = TotalReceivedSupply - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				TotalReceivedSupply = TotalReceivedSupply + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.civil}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111","1520112","1520113","1520121","1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and	tfgld106.ctyp = "SRC"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				TotalReceivedCivil = TotalReceivedCivil - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				TotalReceivedCivil = TotalReceivedCivil + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| 	
| 	select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod,tpisg.ptyp.erection}
| 	selectdo
| 		select	tppdm600.ncmp
| 		from	tppdm600
| 		where	tppdm600._index1 = {:tpisg088.cprj}
| 		selectdo
| 		endselect
| 		
| 		
| 		select	tfgld106.amnt, tfgld106.dbcr 
| 		from	tfgld106 
| 		where	tfgld106.leac in ("1520111","1520112","1520113","1520121","1520122")
| 		and	tfgld106.dim1 = :tpisg088.cprj
| 		and	tfgld106.otyp(1;1) = "B"
| 		and	tfgld106.ctyp = "SRC"
| 		and 	tfgld106._compnr = :tppdm600.ncmp
| 		selectdo
| 			on case etol(tfgld106.dbcr)
| 			case 1 :					|*DEBIT
| 				TotalReceivedErection = TotalReceivedErection - tfgld106.amnt
| 				break
| 				
| 			case 2 :					|*CREDIT
| 				TotalReceivedErection = TotalReceivedErection + tfgld106.amnt
| 				break
| 			endcase
| 		endselect
| 	endselect
| }

| function delete_from_tpisg302(
| 				domain	tcorno	i.ccod
| 							)
| {
| 	select	tpisg302.*
| 	from	tpisg302 for update
| 	where	tpisg302._index1 = {:i.ccod}
| 	selectdo
| 		db.delete(ttpisg302, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }

| function delete_from_tpisg303(
| 				domain	tcorno	i.ccod
| 							)
| {
| 	select	tpisg303.*
| 	from	tpisg303 for update
| 	where	tpisg303._index1 = {:i.ccod}
| 	selectdo
| 		db.delete(ttpisg303, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }

| function delete_from_tpisg304(
| 				domain	tcorno	i.ccod
| 							)
| {
| 	select	tpisg304.*
| 	from	tpisg304 for update
| 	where	tpisg304._index1 = {:i.ccod}
| 	selectdo
| 		db.delete(ttpisg304, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }

| function delete_from_tpisg309(								
| 				domain	tcorno	i.ccod
| 							)
| {
| 	select	tpisg309.*
| 	from	tpisg309 for update
| 	where	tpisg309._index1 = {:i.ccod}
| 	selectdo
| 		db.delete(ttpisg309, db.retry, e)
| 		if not e then 
| 			commit.transaction()
| 		else
| 			abort.transaction()
| 		endif
| 	endselect
| }

|*********** Insert and Update in tpisg309						
| function insert_update_in_tpisg309(	domain	tcorno	i.ccod	)
| {
| 	domain	tfgld.year	o.year
| 	domain	tpisg.month	o.mnth
| 	domain	tfgld.sdes	o.desc
| 	domain	tcmcs.str20	mnyr,l.date
| 	long 	ret
| 	
| 	o.year = 0
| 	o.mnth = empty
| 	o.desc = ""
| 	
| 	select	tppdm600.ncmp 
| 	from	tpisg088, tppdm600
| 	where	tpisg088._index1 = {:i.ccod}
| 	and	tpisg088.cprj refers to tppdm600 UNREF CLEAR
| 	selectdo
| 	endselect 
| 	
| 	select	tpisg086.year:o.year, 
| 		tpisg086.mnth:o.mnth
| 	from	tpisg088,tpisg086
| 	where	tpisg088._index1 = {:i.ccod}
| 	and	tpisg088.cprj  = tpisg086.cprj
| 	group by tpisg086.year,tpisg086.mnth
| 	order by tpisg086.year,tpisg086.mnth
| 	selectdo
| 		tpisgdll000020.Convert.calendar.year.month.to.fiscal.year.period(
| 											o.year,
| 											etol(o.mnth),
| 											fyer,
| 											fprd,
| 											o.desc
| 										)
| 		
| 		mnyr = o.desc(1;3) & "-" & str$(o.year)
| 		
| 		select	distinct tpisg088.ptyp 
| 		from	tpisg088
| 		where	tpisg088._index1 = {:i.ccod}
| 		order by tpisg088.ptyp 
| 		selectdo
| 			get_insert_billing_data_for_tpisg309(
| 							i.ccod,
| 							tpisg088.ptyp,
| 							o.year,
| 							o.mnth,
| 							tppdm600.ncmp,
| 							fyer,
| 							fprd,
| 							mnyr
| 							)
| 		endselect
| 					
| 	endselect
| 			
| }

| function get_insert_billing_data_for_tpisg309(
| 						domain	tcorno		i.ccod,
| 						domain	tpisg.ptyp	i.ptyp,
| 						domain	tfgld.year	i.year,
| 						domain	tpisg.month	i.mnth,
| 						domain	tcncmp		i.comp, 
| 						domain	tfgld.year	i.fyer,
| 						domain	tfgld.prod	i.fprd,
| 						domain	tcmcs.str20	i.mnyr

| 						)
| {
| 	domain	tcamnt		cr.amnt,dr.amnt,diff.amnt,Budgeted,Actual
| 	Budgeted = 0
| 	Actual = 0
| 	
| 		select	sum(tpisg086.budg):Budgeted
| 		from	tpisg086
| 		where	tpisg086.cprj in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod} and tpisg088.ptyp = :i.ptyp)
| 		and tpisg086.year = :i.year and tpisg086.mnth = :i.mnth
| 		selectdo
| 		endselect	
| 		
| 		cr.amnt = 0
| 		
| 		|*CREDIT
| 		select	sum(tfgld106.amnt):cr.amnt
| 		from	tfgld106
| 		where	tfgld106._index10 = {:i.fyer,:i.fprd}
| 		and 	tfgld106.dim1 in (select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod} and tpisg088.ptyp = :i.ptyp)
| 		and	tfgld106.dbcr = tfgld.dbcr.credit
| 		and	tfgld106.leac in (select tfisg072.leac from tfisg072) 
| 		and 	tfgld106._compnr = :i.comp
| 		selectdo
| 		endselect
| 		
| 		dr.amnt = 0
| 		
| 		|*DEBIT
| 		select	sum(tfgld106.amnt):dr.amnt
| 		from	tfgld106 
| 		where	tfgld106._index10 = {:i.fyer,:i.fprd}
| 		and	tfgld106.dim1 in(select tpisg088.cprj from tpisg088 where tpisg088._index1 = {:i.ccod} and tpisg088.ptyp = :i.ptyp)
| 		and	tfgld106.dbcr = tfgld.dbcr.debit
| 		and	tfgld106.leac in (select tfisg072.leac from tfisg072) 
| 		and 	tfgld106._compnr = :i.comp
| 		selectdo
| 		endselect
| 		
| 		diff.amnt = 0
| 		diff.amnt = cr.amnt - dr.amnt
| 		Actual = Actual + diff.amnt
| 		
| 		|Insert data in tpisg309
| 		
| 		select	tpisg309.* 
| 		from	tpisg309 for update
| 		where	tpisg309._index1 = {:i.ccod}
| 		and	tpisg309.mnyr = :i.mnyr
| 		selectdo
| 			tpisg309.user = logname$
| 			
| 			on case etol(i.ptyp)
| 				case 1:
| 					tpisg309.sybd = Budgeted
| 					tpisg309.syac = Actual
| 					tpisg309.syvr = tpisg309.syac - tpisg309.sybd
| 					break
| 				case 2:
| 					tpisg309.clbd = Budgeted
| 					tpisg309.clac = Actual
| 					tpisg309.clvr = tpisg309.clac - tpisg309.clbd
| 					break
| 				case 3:
| 					tpisg309.erbd = Budgeted
| 					tpisg309.erac = Actual
| 					tpisg309.ervr = tpisg309.erac - tpisg309.erbd
| 					break
| 			endcase
| 				
| 			tpisg309.tlbd = tpisg309.sybd + tpisg309.clbd + tpisg309.erbd
| 			tpisg309.tlac = tpisg309.syac + tpisg309.clac + tpisg309.erac
| 			tpisg309.tlvr = tpisg309.syvr + tpisg309.clvr + tpisg309.ervr
| 			tpisg309.updt = utc.num()
| 			
| 			db.update(ttpisg309, db.retry, e)
| 			if not e then 
| 				commit.transaction()
| 			else
| 				abort.transaction()
| 			endif
| 				
| 		selectempty
| 			sern = sern + 1
| 			tpisg309.ccod = i.ccod
| 			tpisg309.mnyr = i.mnyr
| 			tpisg309.sern = sern
| 			
| 			on case etol(i.ptyp)
| 				case 1:
| 					tpisg309.sybd = Budgeted
| 					tpisg309.syac = Actual
| 					tpisg309.syvr = tpisg309.syac - tpisg309.sybd
| 					break
| 				case 2:
| 					tpisg309.clbd = Budgeted
| 					tpisg309.clac = Actual
| 					tpisg309.clvr = tpisg309.clac - tpisg309.clbd
| 					break
| 				case 3:
| 					tpisg309.erbd = Budgeted
| 					tpisg309.erac = Actual
| 					tpisg309.ervr = tpisg309.erac - tpisg309.erbd
| 					break
| 			endcase
| 				
| 			tpisg309.tlbd = tpisg309.sybd + tpisg309.clbd + tpisg309.erbd
| 			tpisg309.tlac = tpisg309.syac + tpisg309.clac + tpisg309.erac
| 			tpisg309.tlvr = tpisg309.syvr + tpisg309.clvr + tpisg309.ervr
| 			tpisg309.updt = utc.num()

| 			db.insert(ttpisg309, db.skip.dupl, e)
| 			if not e then 
| 				commit.transaction()
| 			else
| 				abort.transaction()
| 			endif
| 		endselect
| }
| 												|07.05.19.Adarsh.sn
| function delete.data.from.tpisg310.for.curr.ccod(domain tcorno i.ccod)
| {
| 		select	tpisg310.*
| 		from	tpisg310 for update
| 		where	tpisg310._index1 = {:i.ccod}
| 		selectdo
| 			db.delete(ttpisg310,DB.RETRY,e)
| 			if not e then
| 				commit.transaction()
| 			else
| 				abort.transaction()
| 			endif
| 		endselect
| }
| 	
| function insert.and.update.tpisg310(domain tcorno i.ccod)
| {
| 	initialize.variables()
| 	select	tpisg087.ccod
| 	from	tpisg087
| 	where	tpisg087._index1 = {:i.ccod}
| 	selectdo
| 		select	tpisg089.*
| 		from	tpisg089
| 		where	tpisg089._index1 = {:tpisg087.ccod}
| 		selectdo
| 			mnth.long = etol(tpisg089.mnth)
| 			mnth.desc = enum.descr$("tpisg.month",tpisg089.mnth)
| 			mnth.desc = mnth.desc(1;3)
| 			mnth.year = mnth.desc & "-" & str$(tpisg089.year)
| 			
| 			tpisgdll000020.convert.calender.year.and.month.to.corresponding.fiscal.year.and.period(tpisg089.year,mnth.long,f.year,f.prod)
| 			
| 			select	tpisg088.cprj
| 			from	tpisg088
| 			where	tpisg088._index1 = {:i.ccod}
| 			selectdo
| 				select	tppdm600.ncmp 
| 				from	tppdm600
| 				where	tppdm600._index1 = {:tpisg088.cprj}
| 				selectdo
| 				endselect 
| 				
| 				select	tfisg041.btno,tfisg041.ctyp,tfisg041.year,tfisg041.prod,tfisg041.amth
| 				from	tfisg041
| 				where	tfisg041.cprj = {:tpisg088.cprj} 
| 				and	tfisg041._compnr = {:tppdm600.ncmp}
| 				and	tfisg041.year = {:f.year}
| 				and	tfisg041.prod = {:f.prod}
| 				order by	tfisg041.btno desc
| 				selectdo
| 					if hold.btno <> tfisg041.btno then
| 						net.inflow.btno = net.inflow.btno + net.inflow
| 						net.outflow.btno = net.outflow.btno + net.outflow
| 						cash.inflow = 0.0
| 						cash.outflow = 0.0
| 						net.inflow = 0.0
| 						net.outflow = 0.0
| 						if tfisg041.ctyp = tfcash.flow.in then
| 							cash.inflow = cash.inflow + tfisg041.amth
| 							if cash.inflow > cash.outflow then
| 								net.inflow = cash.inflow - cash.outflow
| 							else
| 								if cash.inflow < cash.outflow then
| 									net.outflow = cash.outflow - cash.inflow
| 								endif
| 							endif
| 							if cash.inflow = cash.outflow then
| 								net.inflow = 0.0
| 								net.outflow =  0.0
| 							endif
| 						else
| 							if tfisg041.ctyp = tfcash.flow.out then
| 								cash.outflow = cash.outflow + tfisg041.amth
| 								if cash.inflow > cash.outflow then
| 									net.inflow = cash.inflow - cash.outflow
| 								else
| 									if cash.inflow < cash.outflow then
| 										net.outflow = cash.outflow - cash.inflow
| 									endif
| 								endif
| 								if cash.inflow = cash.outflow then
| 									net.inflow = 0.0
| 									net.outflow =  0.0
| 								endif
| 							endif
| 						endif
| 					else
| 						if tfisg041.ctyp = tfcash.flow.in then
| 							cash.inflow = cash.inflow + tfisg041.amth
| 							if cash.inflow > cash.outflow then
| 								net.inflow = cash.inflow - cash.outflow
| 							else
| 								if cash.inflow < cash.outflow then
| 									net.outflow = cash.outflow - cash.inflow
| 								endif
| 							endif
| 							if cash.inflow = cash.outflow then
| 								net.inflow = 0.0
| 								net.outflow =  0.0
| 							endif
| 						else
| 							if tfisg041.ctyp = tfcash.flow.out then
| 								cash.outflow = cash.outflow + tfisg041.amth
| 								if cash.inflow > cash.outflow then
| 									net.inflow = cash.inflow - cash.outflow
| 								else
| 									if cash.inflow < cash.outflow then
| 										net.outflow = cash.outflow - cash.inflow
| 									endif
| 								endif
| 								if cash.inflow = cash.outflow then
| 									net.inflow = 0.0
| 									net.outflow =  0.0
| 								endif
| 							endif
| 						endif
| 					endif
| 					hold.btno = tfisg041.btno
| 				selecteos
| 					net.inflow.btno = net.inflow.btno + net.inflow
| 					net.outflow.btno = net.outflow.btno + net.outflow
| 				endselect
| 				hold.btno = 0
| 			endselect
| 			
| 			inflow.actual = net.inflow.btno
| 			inflow.variance = tpisg089.amti - inflow.actual
| 			outflow.actual = net.outflow.btno
| 			outflow.variance = tpisg089.amto - outflow.actual
| 			net.actual = inflow.actual - outflow.actual
| 			net.variance = inflow.variance - outflow.variance
| 			
| 			select	tpisg310.*
| 			from	tpisg310
| 			where	tpisg310._index1 = {:tpisg089.ccod}
| 			and	tpisg310.moyr = :mnth.year
| 			selectdo
| 			selectempty
| 				i = i + 1
| 				tpisg310.ccod = tpisg089.ccod
| 				tpisg310.sern = i
| 				tpisg310.moyr = mnth.year
| 				tpisg310.ifbu = tpisg089.amti
| 				tpisg310.ifac = inflow.actual
| 				tpisg310.ifva = inflow.variance
| 				tpisg310.ofbu = tpisg089.amto
| 				tpisg310.ofac = outflow.actual
| 				tpisg310.ofva = outflow.variance
| 				tpisg310.ntbu = tpisg089.namt
| 				tpisg310.ntac = net.actual
| 				tpisg310.ntva = net.variance
| 				tpisg310.user = logname$
| 				tpisg310.updt = utc.num()
| 				db.insert(ttpisg310,DB.RETRY,db.skip.dupl)
| 				commit.transaction()
| 			endselect
| 			initialize.variables()
| 		endselect
| 	endselect
| }
											|#OLD
function delete.tpisg305.306.and.307(domain tcorno i.ccod)
{
	select	tpisg305.*
	from	tpisg305 for update
	where	tpisg305._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg305,DB.RETRY)
		commit.transaction()
	endselect
	
	select	tpisg306.*
	from	tpisg306 for update	
	where	tpisg306._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg306,DB.RETRY)
		commit.transaction()
	endselect
	
	select	tpisg307.*
	from	tpisg307 for update
	where	tpisg307._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg307,DB.RETRY)
		commit.transaction()
	endselect
}

function insert.tpisg305.306.and.307(domain tcorno i.ccod)
{
	niba.cprj = 0.0
	niba.ccod.sply = 0.0
	niba.ccod.civl = 0.0
	niba.ccod.erec = 0.0
	
	select	tpisg088.ccod,tpisg088.ptyp,tpisg088.cprj
	from	tpisg088
	where	tpisg088._index1 = {:i.ccod}
	selectdo
		on case etol(tpisg088.ptyp)
		case 1:
			select	sum(tpisg058.niba):niba.cprj
			from	tpisg058
			where	tpisg058._index1 = {:tpisg088.cprj}
			and	tpisg058.elem(1;1) = "C"
			selectdo
				niba.ccod.sply = niba.ccod.sply + niba.cprj
			endselect
			break
		case 2:
			select	sum(tpisg058.niba):niba.cprj
			from	tpisg058
			where	tpisg058._index1 = {:tpisg088.cprj}
			and	tpisg058.elem(1;1) = "C"
			selectdo
				niba.ccod.civl = niba.ccod.civl + niba.cprj
			endselect
			break
		case 3:
			select	sum(tpisg058.niba):niba.cprj
			from	tpisg058
			where	tpisg058._index1 = {:tpisg088.cprj}
			and	tpisg058.elem(1;1) = "C"
			selectdo
				niba.ccod.erec = niba.ccod.erec + niba.cprj
			endselect
			break
		default:
			niba.cprj = 0.0
			niba.ccod.sply = 0.0
			niba.ccod.civl = 0.0
			niba.ccod.erec = 0.0
		endcase
	endselect
	
	select	tpisg305.*
	from	tpisg305
	where	tpisg305._index1 = {:tpisg088.ccod}
	and	tpisg305.csdc = "Non-Integrated Cost"
	selectdo
	selectempty
		db.set.to.default(ttpisg305)
		tpisg305.user = logname$
		tpisg305.csdc = "Non-Integrated Cost"
		tpisg305.ccod = tpisg088.ccod
		tpisg305.cbda = niba.ccod.sply
		tpisg305.updt = utc.num()
		db.insert(ttpisg305,DB.RETRY)
		commit.transaction()
	endselect
	
	select	tpisg306.*
	from	tpisg306
	where	tpisg306._index1 = {:tpisg088.ccod}
	and	tpisg306.csdc = "Non-Integrated Cost"
	selectdo
	selectempty
		db.set.to.default(ttpisg306)
		tpisg306.user = logname$
		tpisg306.csdc = "Non-Integrated Cost"
		tpisg306.ccod = tpisg088.ccod
		tpisg306.cbda = niba.ccod.erec
		tpisg306.updt = utc.num()
		db.insert(ttpisg306,DB.RETRY)
		commit.transaction()
	endselect
	
	select	tpisg307.*
	from	tpisg307
	where	tpisg307._index1 = {:tpisg088.ccod}
	and	tpisg307.csdc = "Non-Integrated Cost"
	selectdo
	selectempty
		db.set.to.default(ttpisg307)
		tpisg307.user = logname$
		tpisg307.csdc = "Non-Integrated Cost"
		tpisg307.ccod = tpisg088.ccod
		tpisg307.cbda = niba.ccod.civl
		tpisg307.updt = utc.num()
		db.insert(ttpisg307,DB.RETRY)
		commit.transaction()
	endselect
}
										|07.05.19.Adarsh.en
function domain tcnama get.customer.name(domain tccom.bpid tpisg087.cust)
{
	select	tccom100.nama
	from	tccom100
	where	tccom100._index1 = {:tpisg087.cust}
	selectdo
	selectempty
		tccom100.nama = ""
	endselect
	
	return(tccom100.nama)
}

function domain tcdsca get.enterprize.unit.name(domain tcemm.grid tpisg087.lddn)
{
	select	tcemm030.dsca
	from	tcemm030
	where	tcemm030._index1 = {:tpisg087.lddn}
	selectdo
	selectempty
		tcemm030.dsca = ""
	endselect
	
	return(tcemm030.dsca)
}

function domain tcccur get.project.currency(domain tccprj i.ccod)
{
	select	tpisg088.ccur
	from	tpisg088
	where	tpisg088._index1 = {:i.ccod}
	as set with 1 rows
	selectdo
	selectempty
		tpisg088.ccur = ""
	endselect
	
	return(tpisg088.ccur)
}

function insert.update.tpisg313(domain tcorno i.ccod)
{
	select	tpisg088.ccod,tpisg088.cprj,tpisg088.ptyp,tppdm600.ncmp
	from	tpisg088,tppdm600
	where	tpisg088._index1 = {:i.ccod}
	and	tpisg088.cprj refers to tppdm600
	selectdo
		select	tpisg085.ptyp,tpisg085.sptp,tpisg085.amnt
		from	tpisg085
		where	tpisg085._index1 = {:tpisg088.cprj}
		selectdo
			select	tpisg313.*
			from	tpisg313 for update
			where	tpisg313._index1 = {:tpisg088.ccod,:tpisg088.ptyp,:tpisg085.ptyp,:tpisg085.sptp}
			selectdo
				tpisg313.ptam = tpisg313.ptam + tpisg085.amnt
				tpisg313.ramt = tpisg313.ramt + get.general.ledger.amount(tpisg085.ptyp) + get.customer.receipt.amount(tpisg088.cprj,tpisg085.ptyp)	|#Adarsh.15.11.19
				tpisg313.updo = utc.num()
				tpisg313.updb = logname$
				db.update(ttpisg313,DB.RETRY)
				commit.transaction()
			selectempty
				tpisg313.ccod = tpisg088.ccod
				tpisg313.ptyp = tpisg088.ptyp
				tpisg313.ptty = tpisg085.ptyp
				tpisg313.ptst = tpisg085.sptp
				tpisg313.ptam = tpisg085.amnt
				tpisg313.ramt = get.general.ledger.amount(tpisg085.ptyp) + get.customer.receipt.amount(tpisg088.cprj,tpisg085.ptyp)			|#Adarsh.15.11.19
				tpisg313.updo = utc.num()
				tpisg313.updb = logname$
				db.insert(ttpisg313,DB.RETRY)
				commit.transaction()
			endselect
		selectempty
		endselect
	endselect
}

function domain tcamnt get.general.ledger.amount(domain tdisg.ptyp i.ptyp)
{
	domain	tcamnt	net.amnt,net.amnt.1,net.amnt.2
	
	net.amnt = 0.0
	net.amnt.1 = 0.0
	net.amnt.2 = 0.0
	
	on case etol(i.ptyp)
	case 1 :
		select	tfgld106.amth,tfgld106.dbcr
		from	tfgld106 
		where	tfgld106.leac in ("2510311","1550911")
		and	tfgld106.dim1 = :tpisg088.cprj
		and	tfgld106.otyp not in ("AAR","AUR")
		and	tfgld106.otyp <> "OPB"
		and 	tfgld106._compnr = :tppdm600.ncmp
		selectdo
			on case	etol(tfgld106.dbcr)
			case 1 :		|*Debit
				net.amnt = net.amnt - tfgld106.amth(1)
				break
			case 2 :		|*Credit
				net.amnt = net.amnt + tfgld106.amth(1)
				break
			endcase
		endselect
		break
	case 3 :
		select	tfgld106.amth,tfgld106.dbcr 
		from	tfgld106 
		where	tfgld106.leac in ("1520111","1520112","1520113","1520121","1520122","1550911")
		and	tfgld106.dim1 = :tpisg088.cprj
		and	tfgld106.otyp(1;1) = "B"
		and	tfgld106.ctyp = "SRC"
		and 	tfgld106._compnr = :tppdm600.ncmp
		selectdo
			on case etol(tfgld106.dbcr)	
			case 1 :		|*Debit
				net.amnt = net.amnt - tfgld106.amth(1)
				break
			case 2 :		|*Credit
				net.amnt = net.amnt + tfgld106.amth(1)
				break
			endcase
		endselect
		break
	case 4 :
		select	tfgld106.amth,tfgld106.dbcr 
		from	tfgld106 
		where	tfgld106.leac in ("1520111","1520112","1520113","1520121","1520122","1550911")
		and	tfgld106.dim1 = :tpisg088.cprj
		and	tfgld106.otyp(1;1) = "B"
		and 	tfgld106._compnr = :tppdm600.ncmp
		selectdo
			on case etol(tfgld106.dbcr)
			case 1 :		|*Debit
				net.amnt.1 = net.amnt.1 - tfgld106.amth(1)
				break
			case 2 :		|*Credit
				net.amnt.1 = net.amnt.1 + tfgld106.amth(1)
				break
			endcase
		endselect
		
		select	tfgld106.amth, tfgld106.dbcr 
		from	tfgld106 
		where	tfgld106.leac in ("1520111","1520112","1520113","1520121","1520122","1550911")
		and	tfgld106.dim1 = :tpisg088.cprj
		and	tfgld106.otyp(1;1) = "B"
		and	tfgld106.ctyp = "SRC"
		and 	tfgld106._compnr = :tppdm600.ncmp
		selectdo
			on case etol(tfgld106.dbcr)
			case 1 :		|*Debit
				net.amnt.2 = net.amnt.2 - tfgld106.amth(1)
				break
			case 2 :		|*Credit
				net.amnt.2 = net.amnt.2 + tfgld106.amth(1)
				break
			endcase
		endselect
		
		net.amnt = net.amnt.1 - net.amnt.2
		break
	endcase
	
	return(net.amnt)
}

function delete.tpisg313(domain tcorno i.ccod)
{
	select	tpisg313.*
	from	tpisg313 for update
	where	tpisg313._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg313,DB.RETRY)
		commit.transaction()
	endselect
}

function delete.tpisg316(domain tcorno i.ccod)
{
	select	tpisg316.*
	from	tpisg316 for update
	where	tpisg316._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg316,DB.RETRY)
		commit.transaction()
	endselect
}
		
function insert.update.tpisg316(domain tcorno i.ccod)
{
	select	tpisg091.bgno,
		tpisg091.bgtp
	from	tpisg091
	where	tpisg091.ccod = :i.ccod
	and 	tpisg091.bgst = 1
	selectdo
		select 	tpisg092.cbgv,
			tpisg092.rvno
		from	tpisg092
		where	tpisg092._index1 = {:tpisg091.bgno}
		and 	tpisg092.stat = 1
		order by	tpisg092.rvno desc
		as set with 1 rows
		selectdo
		selectempty
			tpisg092.cbgv = 0.00
		endselect
		
		select	tpisg316.*
		from	tpisg316 for update
		where	tpisg316._index1 = {:i.ccod,:tpisg091.bgtp}
		selectdo
			tpisg316.oamt = tpisg316.oamt + tpisg092.cbgv
			tpisg316.upby = logname$
			tpisg316.upon = utc.num()
			db.update(ttpisg316,DB.RETRY)
			commit.transaction()
		selectempty
			tpisg316.ccod = i.ccod
			tpisg316.btyp = tpisg091.bgtp
			tpisg316.oamt = tpisg092.cbgv
			tpisg316.upby = logname$
			tpisg316.upon = utc.num()
			db.insert(ttpisg316,DB.RETRY)
			commit.transaction()
		endselect
	endselect
}

function delete.tpisg321(domain	tcorno	i.ccod)
{
	select	tpisg321.*
	from	tpisg321 for update
	where	tpisg321._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg321,DB.RETRY)
		commit.transaction()
	endselect
}

function insert.update.tpisg321(domain	tcorno	i.ccod)
{
	domain	tcamnt	amnt.cr,amnt.dr,amnt.actual
	
	amnt.cr = 0.0
	amnt.dr = 0.0
	amnt.actual = 0.0
	
	select	tpisg088.cprj,tpisg088.ptyp,tppdm600.ncmp
	from	tpisg088,tppdm600
	where	tpisg088._index1 = {:i.ccod}
	and	tpisg088.cprj refers to tppdm600 
	selectdo
		select	tpisg086.*
		from	tpisg086
		where	tpisg086._index1 = {:tpisg088.cprj}
		selectdo
			tpisgdll000020.convert.calender.year.and.month.to.corresponding.fiscal.year.and.period(tpisg086.year,etol(tpisg086.mnth),f.year,f.prod)
			
			select	sum(tfgld106.amnt):amnt.cr
			from	tfgld106
			where	tfgld106._index10 = {:f.year,:f.prod}
			and 	tfgld106.dim1 = :tpisg088.cprj
			and	tfgld106.dbcr = tfgld.dbcr.credit
			and	tfgld106.leac in(select tfisg072.leac from tfisg072) 
			and 	tfgld106._compnr = :tppdm600.ncmp
			selectdo
			endselect
			
			select	sum(tfgld106.amnt):amnt.dr
			from	tfgld106 
			where	tfgld106._index10 = {:f.year,:f.prod}
			and	tfgld106.dim1 = :tpisg088.cprj
			and	tfgld106.dbcr = tfgld.dbcr.debit
			and	tfgld106.leac in(select tfisg072.leac from tfisg072) 
			and 	tfgld106._compnr = :tppdm600.ncmp
			selectdo
			endselect
			
			amnt.actual = amnt.cr - amnt.dr
			
			select	tpisg321.*
			from	tpisg321 for update
			where	tpisg321._index1 = {:i.ccod,:tpisg088.ptyp,:tpisg086.year,:tpisg086.mnth}
			selectdo
				tpisg321.budg = tpisg321.budg + tpisg086.budg
				tpisg321.actu = tpisg321.actu + amnt.actual
				tpisg321.outl = tpisg321.outl + tpisg086.outl
				tpisg321.varb = tpisg321.budg - tpisg321.actu
				tpisg321.varo = tpisg321.outl - tpisg321.actu
				tpisg321.upon = utc.num()
				tpisg321.upby = logname$
				db.update(ttpisg321,DB.RETRY)
				commit.transaction()
			selectempty
				tpisg321.ccod = i.ccod
				tpisg321.ptyp = tpisg088.ptyp
				tpisg321.year = tpisg086.year
				tpisg321.mnth = tpisg086.mnth
				tpisg321.budg = tpisg086.budg
				tpisg321.actu = amnt.actual
				tpisg321.outl = tpisg086.outl
				tpisg321.varb = tpisg321.budg - tpisg321.actu
				tpisg321.varo = tpisg321.outl - tpisg321.actu
				tpisg321.upon = utc.num()
				tpisg321.upby = logname$
				db.insert(ttpisg321,DB.RETRY)
				commit.transaction()
			endselect
			
			amnt.cr = 0.0
			amnt.dr = 0.0
			amnt.actual = 0.0
		endselect
	endselect
}

function delete.tpisg322(domain	tcorno	i.ccod)
{
	select	tpisg322.*
	from	tpisg322 for update
	where	tpisg322._index1 = {:i.ccod}
	selectdo
		db.delete(ttpisg322,DB.RETRY)
		commit.transaction()
	endselect
}

function insert.update.tpisg322(domain	tcorno	i.ccod)
{
	initialize.variables()
	select	tpisg089.*
	from	tpisg089
	where	tpisg089._index1 = {:tpisg087.ccod}
	selectdo
		tpisgdll000020.convert.calender.year.and.month.to.corresponding.fiscal.year.and.period(tpisg089.year,etol(tpisg089.mnth),f.year,f.prod)
		select	tpisg088.cprj,tpisg088.ptyp,tppdm600.ncmp
		from	tpisg088,tppdm600
		where	tpisg088._index1 = {:i.ccod}
		and	tpisg088.cprj refers to tppdm600
		selectdo
			select	tfisg041.btno,tfisg041.ctyp,tfisg041.year,tfisg041.prod,tfisg041.amth
			from	tfisg041
			where	tfisg041.cprj = {:tpisg088.cprj} 
			and	tfisg041._compnr = {:tppdm600.ncmp}
			and	tfisg041.year = {:f.year}
			and	tfisg041.prod = {:f.prod}
			order by	tfisg041.btno desc
			selectdo
				if hold.btno <> tfisg041.btno then
					net.inflow.btno = net.inflow.btno + net.inflow
					net.outflow.btno = net.outflow.btno + net.outflow
					cash.inflow = 0.0
					cash.outflow = 0.0
					net.inflow = 0.0
					net.outflow = 0.0
					if tfisg041.ctyp = tfcash.flow.in then
						cash.inflow = cash.inflow + tfisg041.amth
						if cash.inflow > cash.outflow then
							net.inflow = cash.inflow - cash.outflow
						else
							if cash.inflow < cash.outflow then
								net.outflow = cash.outflow - cash.inflow
							endif
						endif
						if cash.inflow = cash.outflow then
							net.inflow = 0.0
							net.outflow =  0.0
						endif
					else
						if tfisg041.ctyp = tfcash.flow.out then
							cash.outflow = cash.outflow + tfisg041.amth
							if cash.inflow > cash.outflow then
								net.inflow = cash.inflow - cash.outflow
							else
								if cash.inflow < cash.outflow then
									net.outflow = cash.outflow - cash.inflow
								endif
							endif
							if cash.inflow = cash.outflow then
								net.inflow = 0.0
								net.outflow =  0.0
							endif
						endif
					endif
				else
					if tfisg041.ctyp = tfcash.flow.in then
						cash.inflow = cash.inflow + tfisg041.amth
						if cash.inflow > cash.outflow then
							net.inflow = cash.inflow - cash.outflow
						else
							if cash.inflow < cash.outflow then
								net.outflow = cash.outflow - cash.inflow
							endif
						endif
						if cash.inflow = cash.outflow then
							net.inflow = 0.0
							net.outflow =  0.0
						endif
					else
						if tfisg041.ctyp = tfcash.flow.out then
							cash.outflow = cash.outflow + tfisg041.amth
							if cash.inflow > cash.outflow then
								net.inflow = cash.inflow - cash.outflow
							else
								if cash.inflow < cash.outflow then
									net.outflow = cash.outflow - cash.inflow
								endif
							endif
							if cash.inflow = cash.outflow then
								net.inflow = 0.0
								net.outflow =  0.0
							endif
						endif
					endif
				endif
				hold.btno = tfisg041.btno
			selecteos
				net.inflow.btno = net.inflow.btno + net.inflow
				net.outflow.btno = net.outflow.btno + net.outflow
			endselect
			hold.btno = 0
		endselect
		
		inflow.actual = net.inflow.btno
		outflow.actual = net.outflow.btno
		
		select	tpisg322.*
		from	tpisg322 for update
		where	tpisg322._index1 = {:tpisg089.ccod,:tpisg088.ptyp,:tpisg089.year,:tpisg089.mnth}
		selectdo
			tpisg322.ibud = tpisg322.ibud + tpisg089.amti
			tpisg322.iact = tpisg322.iact + inflow.actual
			tpisg322.ivfb = tpisg322.ivfb + tpisg322.ibud - tpisg322.iact
			tpisg322.obud = tpisg322.obud + tpisg089.amto
			tpisg322.oact = tpisg322.oact + outflow.actual
			tpisg322.ovfb = tpisg322.ovfb + tpisg322.obud - tpisg322.oact
			tpisg322.nbud = tpisg322.nbud + tpisg322.ibud - tpisg322.obud
			tpisg322.nact = tpisg322.nact + tpisg322.iact - tpisg322.oact	
			tpisg322.nvfb = tpisg322.nvfb + tpisg322.nbud - tpisg322.nact
			tpisg322.iout = tpisg322.iout + tpisg089.oami
			tpisg322.ivfo = tpisg322.ivfo + tpisg322.iout - tpisg322.iact
			tpisg322.oout = tpisg322.oout + tpisg089.oamo
			tpisg322.ovfo = tpisg322.ovfo + tpisg322.oout - tpisg322.oact
			tpisg322.nout = tpisg322.nout + tpisg322.iout - tpisg322.oout
			tpisg322.nvfo = tpisg322.nvfo + tpisg322.nout - tpisg322.nact
			tpisg322.upon = utc.num()
			tpisg322.upby = logname$
			db.update(ttpisg322,DB.RETRY)
			commit.transaction()
		selectempty
			tpisg322.ccod = tpisg089.ccod
			tpisg322.ptyp = tpisg088.ptyp
			tpisg322.year = tpisg089.year
			tpisg322.mnth = tpisg089.mnth
			tpisg322.ibud = tpisg089.amti
			tpisg322.iact = inflow.actual
			tpisg322.ivfb = tpisg322.ibud - tpisg322.iact
			tpisg322.obud = tpisg089.amto
			tpisg322.oact = outflow.actual
			tpisg322.ovfb = tpisg322.obud - tpisg322.oact
			tpisg322.nbud = tpisg322.ibud - tpisg322.obud
			tpisg322.nact = tpisg322.iact - tpisg322.oact	
			tpisg322.nvfb = tpisg322.nbud - tpisg322.nact
			tpisg322.iout = tpisg089.oami
			tpisg322.ivfo = tpisg322.iout - tpisg322.iact
			tpisg322.oout = tpisg089.oamo
			tpisg322.ovfo = tpisg322.oout - tpisg322.oact
			tpisg322.nout = tpisg322.iout - tpisg322.oout
			tpisg322.nvfo = tpisg322.nout - tpisg322.nact
			tpisg322.upon = utc.num()
			tpisg322.upby = logname$
			db.insert(ttpisg322,DB.RETRY)
			commit.transaction()
		endselect
		initialize.variables()
	endselect
}

function initialize.variables()
{
	cash.inflow = 0.0
	cash.outflow = 0.0
	net.inflow = 0.0
	net.inflow.btno = 0.0
	net.outflow = 0.0
	net.outflow.btno = 0.0
	inflow.actual = 0.0
	outflow.actual = 0.0
	net.actual = 0.0
	hold.btno = 0
}

function double get.customer.receipt.amount(	domain	tccprj		i.cprj,
						domain	tdisg.ptyp	i.ptyp	)
{
	domain	tcamnt	recd.amnt
	
	recd.amnt = 0.0
	
	select	tpisg501.rcid,tpisg501.amnt
	from	tpisg501
	where	tpisg501.cprj = {:i.cprj}
	selectdo
		select	tpisg500.rcid
		from	tpisg500
		where	tpisg500._index1 = {:tpisg501.rcid}
		and	tpisg500.rtyp = :i.ptyp
| 		and	tpisg500.stat = 4
		and	tpisg500.ebia = 2
		selectdo
			recd.amnt = recd.amnt + tpisg501.amnt
		endselect
	endselect
	
	return(recd.amnt)
}

function get_direct_supplier_payment(domain	tcorno	i.ccod)
{
	oflw.actu = 0.0
	
	select	tpisg088.cprj
	from	tpisg088
	where	tpisg088._index1 = {:i.ccod}
	selectdo
		select	tpisg600.pric
		from	tpisg600
		where	tpisg600.cprj = :tpisg088.cprj
		and	tpisg600.aflg = 2
| 		and	tpisg600.frz1 = 1
		selectdo
			oflw.actu = oflw.actu + tpisg600.pric
		endselect
	endselect
}
|************************************************ End Of Code ***************************************************
