|******************************************************************************
|* tfacp24003  0  VRC B40O c4 SIS 
|* Print Purchase Order Summary
|* Veena Development User        
|* 2005-05-18
|******************************************************************************
|* Main table tfacp200 Open Items (Purchase Invoices & Payments), Form Type 4
|******************************************************************************
|* Ported from BaaN.[- VRC B40O c4 SIS] 
|*
|* ISGEC001003, IT0205, Arjit Gupta, VRC B61U a7 isg
|* Landed Cost Added in Gross Amount as suggested by Mr. Deepak Rawat 
|*
|* ISGEC001025, IT0242, Sujeet Kumar		2014-09-06	
|* As per the discussion with Mr.Deepak Rawat
|* For Only Summary Report
|*
|* ID   ISGEC001061, Sujeet Kumar	2014-09-29
|* Modification in PO Summary Report
|* Previous Comments are also Removed.
|* Copy Session Code is : tfmsl2400m100 [Tested on Development Server With Functional]
|* Functional: Mr. Deepak Rawat
|*
|* ID ISGEC001086,	Sujeet Kumar		2014-10-10
|* More than 6 line found on tfacp201.
|* Functional: Mr. Deepak Rawat
|*
|* ID ISGEC001153,	Sujeet Kumar		2014-11-10
|* Intercompnay Document Releation Logic
|* Functional: Mr. Deepak Rawat
|*

|* ID ISGEC01045, Shilpa Janardanan, 2015-02-05
|* Logic for Company to be placed for calculating Unallocated Advance Amount
|*
|* ISGEC004016, Dharmendra, 2015-02-24
|* Logic added to print Match with orders = cost invoice 
|*
|* ID ISGEC001165, Manish Manchanda, 2015-02-24
|* compnr added in select

|* IDENT ISGEC015002, Shilpa Janardanan, 30/04/2015
|* Logic for cheque number printing

|* IDENT ISGEC015003 Shilpa Janardanan, 02/05/2015
|* Logic correction for unadjusted debit note
|*
|* IDENT PATCH002040 Mani sharma , 15-05-2015
|* Print Summary for each Order 
|*
|* IDENT ISGEC01041, Ritu Sharma, 2015-05-16
|* Modifications to correct the document number.
|****************************** declaration section ***************************
declaration:

	table ttfacp200 | Open Items (Purchase Invoices & Payments)
	table ttfgld011 | Transaction Types
	table ttccom100 | Suppliers
	table ttfacp100
	table ttfacp251
	table ttfacp201
	table ttfcmg100
	table ttfgld106
	table ttppdm600
	table ttcmcs052
	table ttdpur401
	table ttdpur400
	table ttdpur406
	table ttfisg001
	table ttfmsl020
	table	ttfcmg112		
	table	ttfcmg103
	table	ttcmcs065
	table	ttclct200
	table	ttfacp203
	table	ttfgld102
	table   ttfacp935
	
	table	ttccom000		|#ISGEC001153.n
	table	ttcemm170
	table   twhisg312
|**************  FORM FIELDS ***********************************

  extern  domain  tccprj      		prjt.f  
  extern  domain  tccprj		prjt.t
  extern  domain  tccom.bpid      	supp.f  
  extern  domain  tccom.bpid      	supp.t  
  extern  domain  tcorno	      	orno.f
  extern  domain  tcorno      		orno.t
|********************************************************
  extern  domain  tccom.bpid  		suno.m
  extern  domain  tccprj  		cprj.m,v.cprj
  extern  domain  tcorno    		orno.m
  extern  domain  tfgld.docn  ninv.m,docn.m
  extern  domain  tfgld.amnt  bal.m
  extern  domain  tfgld.amnt  basic.m
  
  extern  domain  tfacp.bloc  bloc1.m
  extern  domain  tfacp.bloc  bloc2.m
  extern  domain  tfacp.bloc  bloc3.m
  extern  domain  tfacp.bloc  bloc4.m
  extern  domain  tfacp.bloc  bloc5.m
  extern  domain  tfacp.bloc  bloc6.m
  
  extern           string     bloc.m(3,6)
  extern  domain  tfcmg.cheq  chq.m
  extern  domain  tfgld.date  chqdt.m
  extern  domain  tfgld.amnt  gross.m,v.amth,gross.m2
  extern  domain  tfgld.date  isup.dt.m
  extern  domain  tfacp.isup  isup.m
  extern  domain  tfgld.date  ninv.docd.m
  extern  domain  tfgld.amnt  paid.m
  extern  domain  tfgld.docn  pmtdoc.m
  extern  domain  tfgld.ttyp  pmttdoc.m
  extern  domain  tfgld.amnt  ret.m(6)
  extern  domain  tfgld.amnt  ret1.m
  extern  domain  tfgld.amnt  ret2.m
  extern  domain  tfgld.amnt  ret3.m
  extern  domain  tfgld.amnt  ret4.m
  extern  domain  tfgld.amnt  ret5.m
  extern  domain  tfgld.amnt  ret6.m
  
  extern  domain  tfgld.amnt  total.basic.m
  extern  domain  tfgld.amnt  total.gross.m
  extern  domain  tfgld.amnt  total.paid.m
  extern  domain  tfgld.amnt  unadjadv.m
  extern  domain  tfgld.amnt  unadjunall.m
  extern  domain  tfgld.amnt  unadjdnote.m
  extern  domain  tfgld.amnt  adv.assigned.m
  extern  domain  tfgld.amnt  temp.adv.assigned.m
  extern  domain  tfgld.amnt  unal.assigned.m
  extern  domain  tfgld.amnt  temp.unal.assigned.m
  extern  domain  tfgld.amnt  dnote.assigned.m
  extern  domain  tfgld.amnt  temp.dnote.assigned.m
  
  extern  domain  tfgld.ttyp  ninv.ttyp.m,ttyp.m
  extern  domain  tcnama  sunama.m
  extern  domain  tppdm.desc  projdesc.m
  extern  domain whinh.shpm   rcno.var 
  domain  tcmcs.long  	comp,x
  domain  tcmcs.long  	ocmp.m
  extern  domain  tcorno  rvno.m,new.orno,old.orno
  domain  tcyesno ptrprinted.m
  domain  tcyesno pgnprinted.m
  extern	domain	tfgld.amnt		extx.l,cltx.l,adas.w,adua.w,uaas.w,uaua.w,inam.w,pamt.w,oamt.w,gros.w,
						dnas.w,dnus.w
extern	domain	tcdsca		nama.w
extern	domain	tfacp.isup	isup.w
extern	domain	tcmcs.str30	purc.invo	
extern	domain	tfgld.docn	temp.paym.docn
extern  domain tcdsca          paym.docn
extern	domain	tcncmp		curr.comp
extern	domain	tcbool		docn.found
extern domain tcamnt           grna.w
extern domain tfcmg.cheq       cheq.w
|****************************** Report Variables **********************************
extern	domain	tfgld.ttyp		o.tfacp200.ttyp
extern	domain	tfgld.docn		o.tfacp200.ninv
extern	domain	tfgld.amnt		o.tfacp200.amth(3)
extern	domain	tfgld.date		o.tfacp200.docd
extern	domain	tfacp.isup		o.tfacp200.isup

extern	domain	tfgld.docn		l.tfacp200.doca
extern	domain	tfgld.ttyp		l.tfacp200.typa

extern	domain	tfgld.ttyp		l.tfacp200.tdoc
extern	domain	tfgld.docn		l.tfacp200.docn
extern	domain	tfgld.amnt		l.tfacp200.amth(3)
extern	domain	tfacp.tpay		l.tfacp200.tpay
extern	domain	tfcmg.cheq		l.tfacp200.pdoc
extern	domain	tfgld.refc		l.tfacp200.refr

extern	domain	tfgld.amnt		balance.amth

extern	domain	tfgld.amnt		o.tfacp251.amth(3)

extern	domain	tfgld.amnt		o.tfacp201.amnt(6)
extern	domain	tfgld.amnt		tot.basic
extern	domain	tfgld.amnt		tot.gross
extern	domain	tfgld.amnt		tot.balance
extern	domain	tfgld.amnt		tot.adjust

long ret_val
boolean 	linking_document
extern	domain	tcyesno			print.detail

extern	domain	tcmcs.str15		document
extern  domain tcamnt  amnt.total
extern	domain	tfgld.amnt	adv.un.assign
extern	domain	tfgld.amnt	un.adv.balance
extern	domain	tcsern		print.condition
							|#SUJEET20150330.sn
extern	domain	tfgld.amnt		cost.basic
extern	domain	tfgld.amnt		cost.gross
extern domain  tcmcs.str13       invoice.no
							|#SUJEET20150330.en
extern domain tcdate 		in.date.utc
extern domain tfgld.date           date.var
domain tfgld.docn              prev.irno,new.irno
long yearno, monthno, month_dayno
long hours, minutes, seconds
extern domain tcpono    temp
extern domain tfgld.docn   prev.docn,new.docn
|****************************** program section ***********************************
before.program:
	curr.comp = get.compnr()
|****************************** form section ***********************************
form.1:
init.form:
	get.screen.defaults()
|****************************** choice section ********************************
choice.cont.process:
on.choice:
	execute(print.data)

choice.print.data:
on.choice:
	print.detail = tcyesno.no
	if rprt_open() then
		print.detail = tcyesno.no
		print.condition = 1			|#SUJEET20150330.n
		print.summary.report()
							|#ISGEC001061.so	Time Being	
							
| 		message("%f",adv.un.assign)
| 		message("%f",un.adv.balance)
		
		print.detail = tcyesno.yes
		
| 		print.condition = 1			|# ISGEC004016.n		|#SUJEET20150330.o
		print.condition = 2			|# ISGEC004016.n		|#SUJEET20150330.n
		print.detail.report()
		
| 		print.condition = 2			|# ISGEC004016.sn	|#ISGEC001165.so
| 		rprt_send()						|#ISGEC001165.eo
		
		print.condition = 3						
| 		Print.purchase.order.for.cost.invoice()	

| 		print.condition = 4		|#ISGEC001165.so
| 		rprt_send()			|#ISGEC001165.eo
							|# ISGEC004016.en
							|#ISGEC001062.eo
		rprt_close()
		
	else
		choice.again()
	endif
	
|****************************** field section *********************************
field.prjt.f:
when.field.changes:
	prjt.t = prjt.f

field.supp.f:
when.field.changes:
	supp.t = supp.f

field.orno.f:
when.field.changes:
	orno.t = orno.f
|****************************** function section ******************************
functions:

function po.summary.detail()
{
	comp = get.compnr()
	
	select	tdpur401.*, tccom100.nama:sunama.m, tcmcs052.dsca:projdesc.m			
	from	tdpur401, tccom100, tcmcs052 
	where 	tdpur401._index5 inrange {:prjt.f}	and	{:prjt.t}
	and	tdpur401._index1 inrange {:orno.f}	and	{:orno.t}
	and	tdpur401._index4 inrange {:supp.f}	and	{:supp.t}
	and	tdpur401.oltp <> tdgen.oltp.total
	and	tdpur401.otbp refers to tccom100 Unref Clear
	selectdo
		select	tfacp251.*
		from	tfacp251
		where	tfacp251._index3 = {:curr.comp, tfacp.otyp.purchase, 
			:tdpur401.orno, :tdpur401.pono, :tdpur401.sqnb}
		selectdo
			select	tfacp200.*
			from  	tfacp200
			where  	tfacp200._index1 = {:tfacp251.ityp, :tfacp251.idoc}
			and 	tfacp200.tpay = tfacp.tpay.invoice  
			and	tfacp200.docn = 0
			selectdo
				ninv.ttyp.m = tfacp200.ttyp
				ninv.m = tfacp200.ninv
				ninv.docd.m = tfacp200.docd
				gross.m = tfacp200.amth(1)
				total.gross.m = total.gross.m + gross.m
				isup.m = tfacp200.isup
				
			endselect
			
		endselect
	endselect
	
	
}


function print.detail.report()
{
	domain	tcorno	prv.orno
	domain	tcmcs.str15	prv.docn
	domain	tfgld.amnt	bas.val, tmp.bal
	domain	tcbool		multi.item
	domain	tfgld.lino	tmp.tfacp200.lino
	domain	tfacp.bloc	tmp.bloc
	long 	i

	domain	tfgld.ttyp	tds.tfacp200.ttyp
	domain	tfgld.ninv	tds.tfacp200.ninv
	domain	tfgld.lino	tds.tfacp200.line
	domain	tcyesno		tds.tfacp200.whti
	domain	tcyesno		o.tfacp200.whti
	boolean			one.time
	boolean			found

	curr.comp = get.compnr()
	prv.orno = ""
	prv.docn = ""
	multi.item = false
	document = ""
	o.tfacp200.ttyp = ""
	o.tfacp200.ninv = 0
	linking_document = false
	o.tfacp200.isup = ""
	o.tfacp200.docd = 0
	tds.tfacp200.whti = tcyesno.no

	tot.basic = 0			|#SUJEET20150330.n
	tot.gross = 0			|#SUJEET20150330.n

								|#ISGEC001061.sn
	select 	tdpur401.orno
	from	tdpur401
	where	tdpur401._index5 inrange {:prjt.f,:orno.f} and {:prjt.t,:orno.t}
	and	tdpur401.otbp inrange :supp.f and :supp.t
	group by tdpur401.orno
	selectdo
								|#ISGEC001061.en
			
	select	tdpur400.orno, tdpur400.cofc, tcmcs065.comp
	from	tdpur400, tcmcs065
| 	where	tdpur400._index1 inrange {:orno.f}	and	{:orno.t}		|#ISGEC001061.o
	where	tdpur400._index1 = {:tdpur401.orno}					|#ISGEC001061.n
	and	tdpur400.cofc refers to tcmcs065 Unref Clear
	selectdo
		
		
		
		select	tfacp251.ityp, tfacp251.idoc, tfacp251.orno,tfacp251.shpm
| 		, sum(tfacp251.amth(1)):bas.val
		from	tfacp251,tdpur401
		where	tfacp251._index3 = {:curr.comp, tfacp.otyp.purchase, :tdpur400.orno}
		and	tfacp251._compnr = :tcmcs065.comp
		and	tdpur401.orno = tfacp251.orno
		and	tdpur401.pono = tfacp251.pono
		and	tdpur401.sqnb = tfacp251.sqnb
		and	tdpur401.cprj inrange :prjt.f and :prjt.t
		group by tfacp251.ityp, tfacp251.idoc, tfacp251.orno,tfacp251.shpm
		order by tfacp251.orno
		selectdo
| 			new.docn = tfacp251.shpm
			tds.tfacp200.whti = tcyesno.no
			
| 			select tfacp251.shpm
| 			from    tfacp251
| 			where	tfacp251._index3 = {:curr.comp, tfacp.otyp.purchase, :tdpur400.orno}
| 			and	tfacp251._compnr = :tcmcs065.comp
| 			and	tfacp251.orno = :tfacp251.orno
| 			and	tfacp251.pono = :tfacp251.pono
| 			and	tfacp251.sqnb = :tfacp251.sqnb
| 			selectdo
| 			endselect	
		
			select	tdpur401.orno
			from	tdpur401, tdpur400
			where	tdpur401._index5 inrange {:prjt.f}	and	{:prjt.t}
			and	tdpur401._index4 inrange {:supp.f}	and	{:supp.t}
			and	tdpur401._index1 = {:tfacp251.orno}
			and	tdpur401.oltp <> tdgen.oltp.total
			and	tdpur401.orno refers to tdpur400
			and	tdpur400.hdst <> tdpur.hdst.cancelled
			group by tdpur401.orno
			selectdo
				tdpur400.orno = tdpur401.orno
				if	prv.orno <> tdpur401.orno	then
					multi.item = false
					prv.orno = tdpur401.orno
| 					tot.basic = 0			|#SUJEET20150330.o
| 					tot.gross = 0			|#SUJEET20150330.o
					tot.balance = 0
					tot.adjust = 0
					prv.docn = ""
				else
					if	document = tfacp251.ityp & str$(tfacp251.idoc)	then
						multi.item = true
					endif	
				endif
				
				o.tfacp251.amth(1) = bas.val

				if not isspace(document) and document <> tfacp251.ityp & str$(tfacp251.idoc) then
| 					print.condition = 5		|#SUJEET20150330.o
| 					rprt_send()			|#ISGEC001165.o
				endif	
| 				print.condition = 1			|#SUJEET20150330.o
				
				o.tfacp200.amth(1) = 0 
				o.tfacp200.amth(2) = 0 
				o.tfacp200.amth(3) = 0 
				
				balance.amth = 0
				
				|retentions Payment Schedule
				invoice.no = ""			
				if	multi.item = false	then
					select	tfacp200.ttyp:o.tfacp200.ttyp,
						tfacp200.ninv:o.tfacp200.ninv,
						tfacp200.amth:o.tfacp200.amth,
						tfacp200.docd:o.tfacp200.docd,
						tfacp200.isup:o.tfacp200.isup,
						tfacp200.whti:o.tfacp200.whti
					from  	tfacp200
					where  	tfacp200._index1 = {:tfacp251.ityp, :tfacp251.idoc}
					and	tfacp200.docn = 0
					and	tfacp200._compnr = :tcmcs065.comp
					selectdo
						invoice.no = o.tfacp200.ttyp & "-" & str$(o.tfacp200.ninv)
						linking_document = false
						balance.amth = o.tfacp200.amth(1)
						paym.docn = ""
						select	tfacp200.tdoc, tfacp200.docn, tfacp200.tpay, tfacp200.amth, 
							tfacp200.ttyp, tfacp200.ninv
						from	tfacp200
						where	tfacp200._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
						and	tfacp200.tpay in (2,8)
						and	tfacp200.docn <> 0 
						as set with 1 rows
						selectdo
							paym.docn = tfacp200.tdoc & "-" & str$(tfacp200.docn)	|Payment Document
							pamt.w = abs(tfacp200.amth(1))					|Paid Amount
							if	tfacp200.tpay = ltoe(2) then 	
								anticipated.payments.receipts.1()
							endif
							if	tfacp200.tpay = ltoe(8) then
								anticipated.payments.receipts()
							endif
						endselect
						document = o.tfacp200.ttyp & str$(o.tfacp200.ninv)
						
						get.ir.details()	
						l.tfacp200.amth(1) = 0
						l.tfacp200.amth(2) = 0
						l.tfacp200.amth(3) = 0
						
						l.tfacp200.tdoc = ""
						l.tfacp200.docn = 0
						tmp.tfacp200.lino = 0
						l.tfacp200.pdoc= ""
						bloc1.m = ""
						bloc2.m = ""
						bloc3.m = ""
						bloc4.m = ""
						bloc5.m = ""
						bloc6.m = ""
						for i = 1 to 6
							o.tfacp201.amnt(i) = 0
							bloc.m(1,i) = ""
						endfor	
						i = 0
						select	tfacp201.amnt, tfacp201.cdf_bloc:tmp.bloc
						from	tfacp201
						where	tfacp201._index1 = {:tfacp251.ityp, :tfacp251.idoc}
						and	tfacp201.cdf_bloc <> ""
						and	tfacp201._compnr = :tcmcs065.comp
						selectdo
							i = i + 1
							if i <= 6 then		|#ISGEC001086.n
								o.tfacp201.amnt(i) = tfacp201.amnt
								bloc.m(1,i) = tmp.bloc 
							endif			|#ISGEC001086.n
							
						endselect
						bloc1.m = bloc.m(1,1)
						bloc2.m = bloc.m(1,2)
						bloc3.m = bloc.m(1,3)
						bloc4.m = bloc.m(1,4)
						bloc5.m = bloc.m(1,5)
						bloc6.m = bloc.m(1,6)
						
						select	sum(a_tfacp200.amth(1)):tmp.bal
						from	tfacp200 a_tfacp200
						where	a_tfacp200._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
						and	a_tfacp200.docn <> 0
						and	a_tfacp200._compnr = :tcmcs065.comp
						selectdo
						selectempty
							tmp.bal = 0
						endselect	
						
						if	prv.docn <> document	then
							prv.docn = document
							tot.basic = tot.basic + o.tfacp251.amth(1)
							tot.balance = tot.balance + (balance.amth - (-1 * tmp.bal))
							tot.gross = tot.gross + o.tfacp200.amth(1)
						endif
						
						
						one.time = true
						
						select 	tfacp200.tdoc:l.tfacp200.typa,
							tfacp200.docn:l.tfacp200.doca,
							tfacp200.amth:l.tfacp200.amth,
							tfacp200.tpay:l.tfacp200.tpay,
							tfacp200.pdoc:l.tfacp200.pdoc,
							tfacp200.docd:o.tfacp200.docd,
							tfacp200.doca:l.tfacp200.docn,		|#ISGEC001165.n
							tfacp200.typa:l.tfacp200.tdoc,		|#ISGEC001165.n
							tfacp200.tdoc:l.tfacp200.tdoc,		|#ISGEC01041.n
							tfacp200.docn:l.tfacp200.docn,		|#ISGEC01041.n
							tfacp200.refr:l.tfacp200.refr
						from	tfacp200
						where	tfacp200._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
						and	tfacp200.docn <> 0
						and	tfacp200._compnr = :tcmcs065.comp
						selectdo
							if	l.tfacp200.docn	=	0	and	isspace(l.tfacp200.tdoc)	then
								l.tfacp200.docn	=	l.tfacp200.doca
								l.tfacp200.tdoc	=	l.tfacp200.typa
							endif
							tot.adjust = tot.adjust + l.tfacp200.amth(1)
							on case l.tfacp200.tpay
								case 	tfacp.tpay.unallocated.ant:
								case	tfacp.tpay.anticipated:
									
									Get_Cheque_Anticipated(l.tfacp200.tdoc, l.tfacp200.docn,
										o.tfacp200.ttyp, o.tfacp200.ninv,l.tfacp200.pdoc)
									break
								case	tfacp.tpay.normal:
									
									Get_Cheque_Normal(l.tfacp200.tdoc, l.tfacp200.docn,
									o.tfacp200.ttyp, o.tfacp200.ninv, tfcmg.tcsh.cntr, l.tfacp200.pdoc)									
									break
							endcase
							
							linking_document = true
							
							
							
							if o.tfacp200.whti = tcyesno.yes and one.time = true then
								
								select 	tfacp203.amti
								from	tfacp203
								where	tfacp203._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}|,:tds.tfacp200.line}
								and	tfacp203.txtp = tctax.txtp.income.tax		|#ISGEC001061.n
								and	tfacp203._compnr = :tcmcs065.comp		|#ISGEC001165.n
								selectdo
									
									o.tfacp200.amth(1) = o.tfacp200.amth(1) + tfacp203.amti
| 									tot.gross = tot.gross + tfacp203.amti
									balance.amth = balance.amth + tfacp203.amti
								endselect
								
								one.time =false
							endif
							
							balance.amth = balance.amth - (  -1 * l.tfacp200.amth(1))
							
							
							
							rprt_send()
						selectempty
												|#sujeet.sn
							if o.tfacp200.whti = tcyesno.yes and one.time = true then
								
								select 	tfacp203.amti
								from	tfacp203
								where	tfacp203._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}|,:tds.tfacp200.line}
								and	tfacp203.txtp = tctax.txtp.income.tax		|#ISGEC001061.n
								and	tfacp203._compnr = :tcmcs065.comp		|#ISGEC001165.n
								selectdo
									
									o.tfacp200.amth(1) = o.tfacp200.amth(1) + tfacp203.amti
| 									tot.gross = tot.gross + tfacp203.amti
									balance.amth = balance.amth + tfacp203.amti
								endselect
								
								one.time =false
							endif
												|#sujeet.en
						endselect
						
						
						|*** Check TDS Document
						
						
						tds.tfacp200.ttyp = ""
						tds.tfacp200.ninv = 0
						tds.tfacp200.line = 0
						
						select 	tfacp200.ttyp:tds.tfacp200.ttyp,
							tfacp200.ninv:tds.tfacp200.ninv,
							tfacp200.line:tds.tfacp200.line,
							tfacp200.whti:tds.tfacp200.whti,
							tfacp200.tdoc:l.tfacp200.tdoc,		|#ISGEC01041.n
							tfacp200.docn:l.tfacp200.docn		|#ISGEC01041.n
						from	tfacp200
						where	tfacp200._index1 = {:tfacp251.ityp, :tfacp251.idoc}
						and	tfacp200.docn = 0
						and	tfacp200._compnr = :tcmcs065.comp
						and	tfacp200.whti = tcyesno.yes
						selectdo
							select 	tfacp203.amti
							from	tfacp203
							where	tfacp203._index1 = {:tds.tfacp200.ttyp,:tds.tfacp200.ninv}|,:tds.tfacp200.line}
							and	tfacp203.txtp = tctax.txtp.income.tax		|#ISGEC001061.n
							and	tfacp203._compnr = :tcmcs065.comp		|#ISGEC001165.n
							selectdo
									l.tfacp200.tdoc = tds.tfacp200.ttyp
									l.tfacp200.docn = tds.tfacp200.ninv
									l.tfacp200.amth(1) = tfacp203.amti * (-1)
									balance.amth = balance.amth - tfacp203.amti
									tot.gross = tot.gross + tfacp203.amti
									l.tfacp200.pdoc = ""		
	
									rprt_send()
							selectempty
								tfacp203.amti  =0
								tds.tfacp200.whti = tcyesno.no
| 								l.tfacp200.pdoc = ""
							endselect
						selectempty
							l.tfacp200.tdoc = ""
							l.tfacp200.docn = 0
							l.tfacp200.amth(1) = 0
						endselect
						
						if not linking_document and tds.tfacp200.whti = tcyesno.no then
							
							rprt_send()
						endif
						
					endselect
				endif
			endselect
| 			prev.docn = new.docn
		endselect
	endselect
	endselect
}


|**************  New Functions **********************************

function get.advance.unallocated.document(
			domain	tfgld.ttyp	i.ttyp,
			domain	tfgld.docn	i.docn,
		ref	domain	tfgld.ttyp	o.ttyp,
		ref	domain	tfgld.docn	o.docn
					)
{
	select	tfcmg100.typo, tfcmg100.doco, tfcmg100.ttyp, tfcmg100.docn
	from	tfcmg100
	where	tfcmg100.typo = :i.ttyp
	and	tfcmg100.doco = :i.docn
	selectdo
		if	not isspace(tfcmg100.ttyp)	and	tfcmg100.docn <> 0	then
			o.ttyp = tfcmg100.ttyp
			o.docn = tfcmg100.docn
		else
			o.ttyp = tfcmg100.typo
			o.docn = tfcmg100.doco
		endif	
	selectempty
		select	tfcmg100.ttyp, tfcmg100.docn
		from	tfcmg100
		where	tfcmg100.ttyp = :i.ttyp
		and	tfcmg100.docn = :i.docn
		selectdo
			o.ttyp = tfcmg100.ttyp
			o.docn = tfcmg100.docn
		selectempty
			o.ttyp = i.ttyp
			o.docn = i.docn
		endselect
	endselect	
}

function Get_Cheque_Normal(
			domain	tfgld.ttyp	i.tdoc,
			domain	tfgld.docn	i.docn,
			domain	tfgld.ttyp	i.ttyp,
			domain	tfgld.docn	i.ninv,
			domain	tfcmg.tcsh	i.tcsh,
		ref	domain	tfcmg.cheq	o.cheq
			)
{
	o.cheq = ""
	select	tfgld102.lino
	from	tfgld102
| 	where	tfgld102._index1 = {:i.tdoc, :i.docn}
| 	and	tfgld102._index9 = {:i.ttyp, :i.ninv}
	where	tfgld102.ttyp = :i.tdoc
	and	tfgld102.docn = :i.docn
	and	tfgld102.tcsh = :i.tcsh
	and	tfgld102.ctyp = :i.ttyp
	and	tfgld102.cdoc = :i.ninv
| 	and	tfgld102._compnr = :tcmcs065.comp
	and	tfgld102._compnr = :curr.comp
	selectdo
		select	tfcmg112.bank, tfcmg112.tdoc, tfcmg112.pdoc
		from	tfcmg112
		where	tfcmg112._index2 = {:i.tdoc, :i.docn, :tfgld102.lino}
| 		and	tfcmg112._compnr = :tcmcs065.comp
		and	tfcmg112._compnr = :curr.comp
		selectdo
			select	tfcmg103.paym
			from	tfcmg103
			where	tfcmg103.ttyp = :tfcmg112.tdoc
			and	tfcmg103.docn = :tfcmg112.pdoc
			and	tfcmg103.bank = :tfcmg112.bank
| 			and	tfcmg103._compnr = :tcmcs065.comp
			and	tfcmg103._compnr = :curr.comp
			selectdo
				select	tfcmg100.cheq:o.cheq
				from	tfcmg100
				where	tfcmg100._index1 = {:tfcmg112.bank, :tfcmg103.paym}
				and	tfcmg100.typo = :tfcmg112.tdoc
				and	tfcmg100.doco = :tfcmg112.pdoc
| 				and	tfcmg100._compnr = :tcmcs065.comp
				and	tfcmg100._compnr = :curr.comp
				selectdo
				selectempty
					o.cheq = ""
				endselect
			selectempty
				o.cheq = ""
			endselect
		selectempty
			o.cheq = ""
		endselect
	selectempty

		select	tfgld106.olin
		from	tfgld106
		where	tfgld106._index1 = {:i.tdoc, :i.docn}
		and	tfgld106._index9 = {:i.ttyp, :i.ninv}
		and	tfgld106.tcsh = :i.tcsh
| 		and	tfgld106._compnr = :tcmcs065.comp
		and	tfgld106._compnr = :curr.comp
		selectdo
			select	tfcmg112.bank, tfcmg112.tdoc, tfcmg112.pdoc
			from	tfcmg112
			where	tfcmg112._index2 = {:i.tdoc, :i.docn, :tfgld106.olin}
| 			and	tfcmg112._compnr = :tcmcs065.comp
			and	tfcmg112._compnr = :curr.comp
			selectdo
				select	tfcmg103.paym
				from	tfcmg103
				where	tfcmg103.ttyp = :tfcmg112.tdoc
				and	tfcmg103.docn = :tfcmg112.pdoc
				and	tfcmg103.bank = :tfcmg112.bank
| 				and	tfcmg103._compnr = :tcmcs065.comp
				and	tfcmg103._compnr = :curr.comp
				selectdo
					select	tfcmg100.cheq:o.cheq
					from	tfcmg100
					where	tfcmg100._index1 = {:tfcmg112.bank, :tfcmg103.paym}
					and	tfcmg100.typo = :tfcmg112.tdoc
					and	tfcmg100.doco = :tfcmg112.pdoc
| 					and	tfcmg100._compnr = :tcmcs065.comp
					and	tfcmg100._compnr = :curr.comp
					selectdo
					selectempty
						o.cheq = ""
					endselect
				selectempty
					o.cheq = ""
				endselect
			selectempty
				o.cheq = ""
			endselect
		endselect	
	endselect
	if o.cheq = "" then			|#ISGEC015002.sn
		o.cheq = l.tfacp200.pdoc
	endif					|#ISGEC015002.en
	
}		

function Get_Cheque_Anticipated(
			domain	tfgld.ttyp	i.tdoc,
			domain	tfgld.docn	i.docn,
			domain	tfgld.ttyp	i.ttyp,
			domain	tfgld.docn	i.ninv,
		ref	domain	tfcmg.cheq	o.cheq
				)
{
	select	tfcmg100.cheq:o.cheq
	from	tfcmg100
	where	tfcmg100.typo = :i.tdoc
	and	tfcmg100.doco = :i.docn
| 	and	tfcmg100._compnr = :tcmcs065.comp
	and	tfcmg100._compnr = :curr.comp
	
	selectdo
	selectempty
		Get_Cheque_Normal(i.tdoc, i.docn, i.ttyp, i.ninv, tfcmg.tcsh.cntr.ant, o.cheq)
	endselect
}

function print.summary.report()
{
	boolean 	found
	oamt.w = 0
	gros.w = 0
	suno.m = ""
	
								|#ISGEC001061.sn
	domain	tcamnt		tot.bas		|Basic Amount
	domain	tcamnt		tot.amnt	|Total Order Amount
	domain	tcamnt		tot.exc		|Excise Tax Amount
	domain	tcamnt		tot.stx		|Salse/Server Tax Amount
	domain	tcamnt		tot.oth1	|Other Charge 1	
	domain	tcamnt		tot.oth2								
	
	select 	tdpur401.orno
	from	tdpur401
	where	tdpur401._index5 inrange {:prjt.f,:orno.f} and {:prjt.t,:orno.t}
	and	tdpur401.otbp inrange :supp.f and :supp.t
	group by tdpur401.orno
	selectdo
								|#ISGEC001061.en
		select 	tdpur400.*, tccom100.nama:sunama.m
		from	tdpur400, tccom100
		| 	where	tdpur400._index2 inrange {:supp.f,:orno.f} and {:supp.t,:orno.t}	|#ISGEC001061.o
		where	tdpur400._index1 = {:tdpur401.orno}					|#ISGEC001061.n	
		and	tdpur400.hdst <> tdpur.hdst.cancelled
		and	tdpur400.otbp refers to tccom100 Unref Clear
		selectdo
			
			suno.m = tdpur400.otbp
			select	max(tdmsl400.vrsn):rvno.m
			from	tdmsl400
			where	tdmsl400._index1 = {:tdpur400.orno}
			and	tdmsl400.stat = tcyesno.yes 
			and	tdmsl400.work = tdmsl.work.completed
			selectdo
			endselect
			select	sum(tdpur401.extx.l):extx.l, sum(tdpur401.cltx.l):cltx.l, tdpur401.orno
			from	tdpur401
			where	tdpur401._index1 = {:tdpur400.orno}				|#ISGEC001061.n
	| 		and	tdpur401._index5 inrange {:prjt.f}	and	{:prjt.t}	|#ISGEC001061.o	
			and	tdpur401.oltp in (tdgen.oltp.total, tdgen.oltp.orderline)
			group by tdpur401.orno
			selectdo
					tot.bas = 0
					tot.amnt = 0
					tot.exc = 0
					tot.stx = 0
					tot.oth1 = 0
					tot.oth2 = 0
					
				tfmsldll0020.purchase_order_amount(tdpur400.orno,
					tot.bas,	|Basic Amount
					tot.amnt,	|Total Order Amount
					tot.exc,	|Excise Tax Amount
					tot.stx,	|Salse/Server Tax Amount
					tot.oth1,	|Other Charge 1	
					tot.oth2)	|Other Charge 2
					
| 				oamt.w = tdpur400.oamt						|#ISGEC001061.o							
				oamt.w = tot.bas						|#ISGEC001061.n		
| 				gros.w = oamt.w + extx.l + cltx.l + Get_Landed_Cost(tdpur401.orno)	|#ISGEC001061.o		
				gros.w = tot.amnt						|#ISGEC001061.n			
									|#ISGEC001153.sn
| 				select 	tccom000.ncmp
| 				from	tccom000
| 				where	tccom000._index1 = {0}
| 				selectdo
				initialize.variable()			|#ISGEC001153.n	
				select	tcemm170.comp
				from	tcemm170
				where	tcemm170.comp not in (100,900)
				selectdo
									|#ISGEC001153.en
					get.data.from.tfmsl020(tdpur400.orno,prjt.f,prjt.t,tcemm170.comp)
				endselect				|#ISGEC001153.n
				get.data.credit.note(tdpur400.orno)		
			rprt_send()
			selectempty
				extx.l = 0
				cltx.l = 0
			endselect
			
			
		endselect
	endselect					|#ISGEC001061.n	
}	


function get.data.from.tfmsl020
			(
				domain tcorno		i.orno,		|Purchase Order
				domain	tccprj		i.cprj.f,	|Project From
				domain	tccprj		i.cprj.t,	|Project To
				domain	tcncmp		i.ncmp		|Company
			)
										
{

	domain	tfgld.ttyp	get.ttyp
	domain	tfgld.docn	get.docn
	domain	tcorno		v.prno
	domain	tccprj		m.cprj
	domain	tcorno		m.orno
	
	domain	tfgld.ttyp	in.ttyp
	domain	tfgld.docn	in.ninv
	domain	tfgld.lino	in.line
	
| 	initialize.variable()			|#ISGEC001153.o
	set.fmin(m.cprj)	
	set.fmin(m.orno)
		select	tfacp200.ttyp, tfacp200.ninv,tfacp200.line, tfacp200.amth, tfacp200.balh, tfacp200.ifbp,
			tfacp200.isup, tfacp200.tpay, tfacp200.tdoc, tfacp200.docn, tfacp200.lino,
			tfacp200.cdf_prno:v.prno,tfacp200.amnt, tfacp200.bahc,tfacp200.whti,
					|#ISGEC001153.sn
			tfacp200.pcom,
			tfacp200.payt,
			tfacp200.payd,
			tfacp200.payl
					|#ISGEC001153.en
					
		from	tfacp200
		where	tfacp200.cdf_cprj inrange :i.cprj.f and :i.cprj.t
		and	tfacp200.cdf_prno = :i.orno
		and	tfacp200.ifbp inrange :supp.f and :supp.t
												
		and	tfacp200.docn = 0
		and	tfacp200.lino = 0
		and	tfacp200._compnr = :i.ncmp		|#ISGEC001153.n
		selectdo
			if i.ncmp <> tfacp200.pcom and tfacp200.payd <> 0 then
				in.ttyp = tfacp200.payt
				in.ninv = tfacp200.payd
				in.line = tfacp200.payl
			else
				in.ttyp = tfacp200.ttyp
				in.ninv = tfacp200.ninv
				in.line = tfacp200.line
			endif
									|#ISGEC001153.en
			on case tfacp200.tpay
				
												
				case tfacp.tpay.advance:	|ltoe(9)												
				case tfacp.tpay.advance.ant:	|ltoe(11)
	
					select 	tfcmg112.cdoc
					from	tfcmg112
									|#ISGEC001153.so
| 					where	tfcmg112.tdoc = :tfacp200.ttyp
| 					and	tfcmg112.pdoc = :tfacp200.ninv
| 					and	tfcmg112.scom = :tfacp200.line
									|#ISGEC001153.en
									
									|#ISGEC001153.sn
					where	tfcmg112.tdoc = :in.ttyp
					and	tfcmg112.pdoc = :in.ninv
					and	tfcmg112.scom = :in.line
									|#ISGEC001153.en

					as set with 1 rows
					selectdo
						if tfcmg112.cdoc = 0 then
							
							
							select tfmsl020.adrq
							from	tfmsl020
							where	tfmsl020._index4 = {:tfacp200.ttyp,:tfacp200.ninv,:tfacp200.line}
							and	(tfmsl020.optn = tfoption.account or tfmsl020.optn = tfoption.exchange)
							and	tfmsl020.fcom = :i.ncmp	|#ISGEC01045.n
							selectdo
								adv.un.assign = adv.un.assign + abs(tfacp200.amth(1))
								un.adv.balance = un.adv.balance +  abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))
							selectempty
								adua.w = adua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Advance Unassign
								adas.w = adas.w + abs(tfacp200.amth(1))
							endselect
							
							
							
							|#30-09-2014
| 							adua.w = adua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Advance Unassign
| 							adas.w = adas.w + abs(tfacp200.amth(1))
							|#30-09-2014
							
							if tfacp200.whti = tcyesno.yes   then
								select 	tfacp203.amti
								from	tfacp203
								where	tfacp203._index1 = {:tfacp200.ttyp,:tfacp200.ninv,:tfacp200.line}
								and	tfacp203.txtp = tctax.txtp.income.tax		|#ISGEC001061.n
								and	tfacp203._compnr = :i.ncmp		|#ISGEC001153.n
								selectdo
									|#30-09-2014	
| 										adua.w = adua.w + tfacp203.amti
| 										adas.w = adas.w + tfacp203.amti
									|#30-09-2014	
										select tfmsl020.adrq
										from	tfmsl020
										where	tfmsl020._index4 = {:tfacp200.ttyp,:tfacp200.ninv,:tfacp200.line}	|#ISGEC001153.o
										and	(tfmsl020.optn = tfoption.account or tfmsl020.optn = tfoption.exchange)
										selectdo
											adv.un.assign = adv.un.assign + abs(tfacp203.amti)
											if tfacp200.balh(1) <> 0 or tfacp200.bahc(1) <> 0 then
												un.adv.balance = un.adv.balance +  abs(tfacp203.amti)
											endif
											
										selectempty
											
											adua.w = adua.w + tfacp203.amti
											adas.w = adas.w + tfacp203.amti
										endselect
								selectempty
								endselect
							endif
						endif
					selectempty
					|#30-09-2014	
| 						adua.w = adua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Advance Unassign
| 						adas.w = adas.w + abs(tfacp200.amth(1))
| 					|#30-09-2014	
						
						
						select tfmsl020.adrq
						from	tfmsl020
						where	tfmsl020._index4 = {:tfacp200.ttyp,:tfacp200.ninv,:tfacp200.line}	|#ISGEC001153.o
| 						where	tfmsl020._index4 = {:in.ttyp,:in.ninv,:in.line}			|#ISGEC001153.n
						and	(tfmsl020.optn = tfoption.account or tfmsl020.optn = tfoption.exchange)
						and	tfmsl020.fcom = :i.ncmp		|#ISGEC01045.n
						selectdo
							adv.un.assign = adv.un.assign + abs(tfacp200.amth(1))
							un.adv.balance = un.adv.balance +  abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))
						selectempty
							adua.w = adua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Advance Unassign
							adas.w = adas.w + abs(tfacp200.amth(1))
						endselect
						
						if tfacp200.whti = tcyesno.yes  then
							select 	tfacp203.amti
							from	tfacp203
							where	tfacp203._index1 = {:tfacp200.ttyp,:tfacp200.ninv,:tfacp200.line}
							and	tfacp203.txtp = tctax.txtp.income.tax		|#ISGEC001061.n
							and	tfacp203._compnr = :i.ncmp		|#ISGEC001153.n
							selectdo
								select tfmsl020.adrq
								from	tfmsl020
								where	tfmsl020._index4 = {:tfacp200.ttyp,:tfacp200.ninv,:tfacp200.line}	
								and	(tfmsl020.optn = tfoption.account or tfmsl020.optn = tfoption.exchange)
								selectdo
									adv.un.assign = adv.un.assign + abs(tfacp203.amti)
									if tfacp200.balh(1) <> 0 or tfacp200.bahc(1) <> 0then
										un.adv.balance = un.adv.balance +  abs(tfacp203.amti)
									endif
									
								selectempty
									|#30-09-2014	
									adua.w = adua.w + tfacp203.amti
									adas.w = adas.w + tfacp203.amti
									|#30-09-2014	
								endselect
								
								
| 									adua.w = adua.w + tfacp203.amti
| 									adas.w = adas.w + tfacp203.amti
							selectempty
							endselect
						endif
					endselect
					
					
					
					
					
					break
				case tfacp.tpay.unallocated:	|ltoe(10)
				case tfacp.tpay.unallocated.ant:	|ltoe(12)
													
					select 	tfcmg112.cdoc
					from	tfcmg112
									|#ISGEC001153.so
| 					where	tfcmg112.tdoc = :tfacp200.ttyp
| 					and	tfcmg112.pdoc = :tfacp200.ninv
| 					and	tfcmg112.scom = :tfacp200.line
									|#ISGEC001153.eo
									|#ISGEC001153.sn
					where	tfcmg112.tdoc = :in.ttyp
					and	tfcmg112.pdoc = :in.ninv
					and	tfcmg112.scom = :in.line
									|#ISGEC001153.en				
					as set with 1 rows
					selectdo
						if tfcmg112.cdoc = 0 then
							uaua.w = uaua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Unallocated Unassign	
							uaas.w = uaas.w + abs(tfacp200.amth(1))	|Unallocated Assign	|#ISGEC001025.o
						endif
						
					selectempty
						uaua.w = uaua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Unallocated Unassign	
						uaas.w = uaas.w + abs(tfacp200.amth(1))	|Unallocated Assign	|#ISGEC001025.o
					endselect	
													
					break
			ENDCASE		
				
		selectempty
		endselect
}

function get.data.credit.note(
			domain	tcorno		o.orno
				)
{
	dnas.w = 0
	dnus.w = 0
	isup.w = ""
	inam.w = 0
	purc.invo = ""
		
| 	select	tfacp200.amnt, tfacp200.balh, tfacp200.isup, tfacp200.amth			|#ISGEC015003.o
	select	tfacp200.amnt, tfacp200.balh, tfacp200.isup, tfacp200.amth,tfacp200.bala	|#ISGEC015003.n
	from	tfacp200
	where	tfacp200.cdf_cprj inrange :prjt.f	and	:prjt.t
	and	tfacp200.cdf_prno = :o.orno
	and	tfacp200.tpay = tfacp.tpay.credit
	and	tfacp200.docn = 0
	selectdo
		dnas.w = dnas.w + abs(tfacp200.amnt)
| 		dnus.w = dnus.w + abs(tfacp200.balh(1))			|#ISGEC015003.o
		dnus.w = dnus.w + (abs(tfacp200.balh(1)) - tfacp200.bala)	|#ISGEC015003.n
		isup.w = tfacp200.isup 
		purc.invo = tfacp200.ttyp & "-" & str$(tfacp200.ninv)	|Purchase Invoice
		inam.w = abs(tfacp200.amth(1))				|Invoice Amount
	endselect	
}

function Get_Advance_Unallocated(
			domain tcorno		i.orno
				)
{
	domain	tccprj	mn.cprj
	domain	tccprj	mn.orno
	
	set.fmin(mn.cprj)
	set.fmin(mn.orno)
	
	select	tfacp200.ttyp, tfacp200.ninv, tfacp200.amth, tfacp200.balh, tfacp200.ifbp,
		tfacp200.isup, tfacp200.tpay, tfacp200.tdoc, tfacp200.docn, tfacp200.lino,
		tfacp200.amnt, tfacp200.bahc
	from	tfacp200
	where	tfacp200.cdf_cprj inrange :prjt.f	and	:prjt.t
	and	tfacp200.cdf_prno = :i.orno
	and	tfacp200.cdf_cprj <> :mn.cprj
	and	tfacp200.cdf_prno <> :mn.orno
	and	tfacp200.docn = 0
	and	tfacp200.lino = 0
	selectdo
		on case tfacp200.tpay
			case tfacp.tpay.advance:	|ltoe(9)		
			case tfacp.tpay.advance.ant:	|ltoe(11)
				adas.w = adas.w + abs(tfacp200.amth(1))				|Advance Assign
				adua.w = adua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Advance Unassign
				break
			case tfacp.tpay.unallocated:	|ltoe(10)		
			case tfacp.tpay.unallocated.ant:	|ltoe(12)
				uaas.w = uaas.w + abs(tfacp200.amth(1))				|Unallocated Assign
				uaua.w = uaua.w + abs(tfacp200.balh(1)) + abs(tfacp200.bahc(1))	|Unallocated Unassign	
				break
		ENDCASE		
	selectempty
	endselect
}				
				
function initialize.variable()
{
	adas.w = 0
	adua.w = 0
	uaas.w = 0
	uaua.w = 0
| 	dnas.w = 0
| 	dnus.w = 0
| 	isup.w = ""
| 	inam.w = 0
| 	purc.invo = ""
	paym.docn = ""
	amnt.total = 0
	temp.paym.docn = 0
	pamt.w = 0
	adv.un.assign = 0
	un.adv.balance = 0
}

function domain tcamnt Get_Landed_Cost(
			domain tcorno		im.orno
				)
{
	domain	tcpono	tmp.sqnb, tmp.pono
	string	tmp.borf(5), prv.borf(5)
	domain	tcamnt	oth.chg1
	
	oth.chg1 = 0
	select	a_tdpur401.pono:tmp.pono, a_tdpur401.sqnb:tmp.sqnb 
	from	tdpur401 a_tdpur401
	where	a_tdpur401._index1 = {:im.orno}
	and	a_tdpur401.oltp in (2,3,4)
	selectdo
		tmp.borf = str$(tmp.pono)&"/"&str$(tmp.sqnb)
		select	tclct200.* from tclct200
		where	tclct200._index1 = {2}
		and	tclct200.bobj = :im.orno
		and	tclct200.borf = :tmp.borf
		order by tclct200._index1
		selectdo
			oth.chg1 = oth.chg1 + tclct200.lcam
		endselect
	endselect

	return(oth.chg1)
}

							|# ISGEC004016.sn
function Print.purchase.order.for.cost.invoice()
{
	domain tcorno v.prno
	long i
	domain	tfacp.bloc	tmp.bloc
	domain	tfgld.ttyp	tds.tfacp200.ttyp
	domain	tfgld.ninv	tds.tfacp200.ninv
	domain	tfgld.lino	tds.tfacp200.line
	domain	tcyesno		tds.tfacp200.whti
	domain	tcyesno		o.tfacp200.whti
	boolean			one.time
	domain	tcmcs.str15	prv.docn	
	domain	tfgld.amnt	tmp.bal	
	
| 	tot.basic = 0					|#SUJEET20150330.o
| 	tot.gross = 0					|#SUJEET20150330.o
	tot.balance = 0
	tot.adjust = 0
	

	
	cost.basic = 0
	cost.gross = 0
	
	
	
	
	select	tfacp200.ttyp:o.tfacp200.ttyp, 
		tfacp200.ninv:o.tfacp200.ninv,
| 		tfacp200.line, 
		tfacp200.amth:o.tfacp200.amth, 
		tfacp200.balh, 
		tfacp200.ifbp,
		tfacp200.isup:o.tfacp200.isup, 
		tfacp200.tpay, 
		tfacp200.tdoc, 
		tfacp200.docn, 
		tfacp200.lino,
		tfacp200.cdf_prno:v.prno,
		tfacp200.amnt, 
		tfacp200.bahc,
		tfacp200.whti:o.tfacp200.whti,
		tfacp200.pcom,
		tfacp200.payt,
		tfacp200.payd,
		tfacp200.payl,
		tfacp200.tdoc
	from	tfacp200
	where	tfacp200.cdf_cprj inrange :prjt.f and :prjt.t
	and	tfacp200.cdf_prno inrange :orno.f and :orno.t
	and	tfacp200.ifbp inrange :supp.f and :supp.t
	and	tfacp200.docn = 0
	and	tfacp200.tpay = tfacp.tpay.invoice
	and	tfacp200.appr = tfacp.inv.expence
| 	and	tfacp200.lino = 0				|#SUJEET20150330.o
	selectdo
		linking_document = false			|#SUJEET20150330.n
| 		o.tfacp200.ttyp = tfacp200.ttyp
| 		o.tfacp200.ninv = tfacp200.ninv
| 		o.tfacp200.isup = tfacp200.isup
| 		o.tfacp200.amth = tfacp200.amth
		l.tfacp200.tdoc = tfacp200.tdoc
		o.tfacp251.amth(1) = o.tfacp200.amth(1)		|#SUJEET20150330.n
| 		o.tfacp200.whti = tfacp200.whti			|#SUJEET20150330.n
| 		balance.amth = tfacp200.amth(1)
		balance.amth = o.tfacp200.amth(1)

		document = o.tfacp200.ttyp & str$(o.tfacp200.ninv)
		
		
		
		
		
| 		select	tdpur400.orno, tdpur400.cofc, tcmcs065.comp
| 		from	tdpur400, tcmcs065
| 		where	tdpur400._index1 = {:v.prno}	
| 		and	tdpur400.cofc refers to tcmcs065 Unref Clear
| 		selectdo
| 		endselect

| 		
		select	sum(a_tfacp200.amth(1)):tmp.bal
		from	tfacp200 a_tfacp200
		where	a_tfacp200._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
		and	a_tfacp200.docn <> 0
| 		and	a_tfacp200._compnr = :tcmcs065.comp
		selectdo
		selectempty
			tmp.bal = 0
		endselect	
		
		for i = 1 to 6
			o.tfacp201.amnt(i) = 0
		endfor	
		i = 0
		select	tfacp201.amnt, tfacp201.cdf_bloc:tmp.bloc
		from	tfacp201
		where	tfacp201._index1 = {:tfacp200.ttyp, :tfacp200.ninv}
		and	tfacp201.cdf_bloc <> ""
| 		and	tfacp201._compnr = :tcmcs065.comp
		selectdo
			i = i + 1
			if i <= 6 then
				o.tfacp201.amnt(i) = tfacp201.amnt
			endif		
		endselect
						
		one.time = true
		
		select 	tfacp200.tdoc:l.tfacp200.tdoc,
			tfacp200.docn:l.tfacp200.docn,
			tfacp200.amth:l.tfacp200.amth,
			tfacp200.tpay:l.tfacp200.tpay,
			tfacp200.pdoc:l.tfacp200.pdoc,
			tfacp200.docd:o.tfacp200.docd,
			tfacp200.refr:l.tfacp200.refr
		from	tfacp200
		where	tfacp200._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
		and	tfacp200.docn <> 0
| 		and	tfacp200._compnr = :tcmcs065.comp
		selectdo
			if	prv.docn <> document	then
				prv.docn = document
| 				tot.basic = tot.basic + o.tfacp251.amth(1)			|#SUJEET20150330.o
				cost.basic = cost.basic + o.tfacp251.amth(1)			|#SUJEET20150330.n
				tot.balance = tot.balance + (balance.amth - (-1 * tmp.bal))
| 				tot.gross = tot.gross + o.tfacp200.amth(1)			|#SUJEET20150330.o
				cost.gross = cost.gross + o.tfacp200.amth(1)			|#SUJEET20150330.n
				tot.adjust = tot.adjust + l.tfacp200.amth(1)
			endif

		
| 			if not isspace(document) and document <> tfacp251.ityp & str$(tfacp251.idoc) then
| 		| 				print.condition = 5		|#SUJEET20150330.o	
| 				
| 				rprt_send()
| 			endif	
| 		
			| 			print.condition = 3			|#SUJEET20150330.o
			
			linking_document = true
			if o.tfacp200.whti = tcyesno.yes and one.time = true then
				select 	tfacp203.amti
				from	tfacp203
				where	tfacp203._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
				and	tfacp203.txtp = tctax.txtp.income.tax	
				selectdo
					o.tfacp200.amth(1) = o.tfacp200.amth(1) + tfacp203.amti
					balance.amth = balance.amth + tfacp203.amti
				endselect
				
				one.time =false
			endif
			
			balance.amth = balance.amth - (  -1 * l.tfacp200.amth(1))
			
			rprt_send()
		selectempty	
			if o.tfacp200.whti = tcyesno.yes and one.time = true then
				select 	tfacp203.amti
				from	tfacp203
				where	tfacp203._index1 = {:o.tfacp200.ttyp,:o.tfacp200.ninv}
				and	tfacp203.txtp = tctax.txtp.income.tax	
				selectdo
					o.tfacp200.amth(1) = o.tfacp200.amth(1) + tfacp203.amti
					balance.amth = balance.amth + tfacp203.amti
				endselect
				one.time =false
			endif
		endselect
		
		|******** Check TDS Document
		
		tds.tfacp200.ttyp = ""
		tds.tfacp200.ninv = 0
		tds.tfacp200.line = 0

		select 	tfacp200.ttyp:tds.tfacp200.ttyp,
			tfacp200.ninv:tds.tfacp200.ninv,
			tfacp200.line:tds.tfacp200.line,
			tfacp200.whti:tds.tfacp200.whti
		from	tfacp200
		where	tfacp200._index1 = {:o.tfacp200.ttyp, :o.tfacp200.ninv}
		and	tfacp200.docn = 0
| 		and	tfacp200._compnr = :tcmcs065.comp
		and	tfacp200.whti = tcyesno.yes
		selectdo
			select 	tfacp203.amti
			from	tfacp203
			where	tfacp203._index1 = {:tds.tfacp200.ttyp,:tds.tfacp200.ninv}
			and	tfacp203.txtp = tctax.txtp.income.tax
			selectdo
				l.tfacp200.tdoc = tds.tfacp200.ttyp
				l.tfacp200.docn = tds.tfacp200.ninv
				l.tfacp200.amth(1) = tfacp203.amti * (-1)
				balance.amth = balance.amth - tfacp203.amti
| 				tot.gross = tot.gross + tfacp203.amti			|#SUJEET20150330.o
				cost.gross = cost.gross + tfacp203.amti			|#SUJEET20150330.n
				l.tfacp200.pdoc = ""
				
				rprt_send()
			selectempty
				tfacp203.amti  =0
				tds.tfacp200.whti = tcyesno.no
				l.tfacp200.pdoc = ""
			endselect
		selectempty
			l.tfacp200.tdoc = ""
			l.tfacp200.docn = 0
			l.tfacp200.amth(1) = 0
		endselect

	if not linking_document and tds.tfacp200.whti = tcyesno.no then
		rprt_send()
	endif
						
	endselect

}

							|# ISGEC004016.en
function get.ir.details()
{
	amnt.total = 0
	domain tcqsl1 l.pksp 
	domain tcdsca pksp.str 
	
	
	rcno.var = ""
	l.pksp = 0
	pksp.str = ""
	in.date.utc = 0 
	new.irno = 0
	tfisg001.irdt = 0
	tfisg001.amnt = 0
	tfisg001.rcno = ""
	tfisg001.rcln = 0
	tfisg001.irno = 0
	amnt.total = 0
	grna.w = 0
	date.var = 0
		
	l.pksp = lval(tfacp251.shpm)
	select tfisg001.*
	from    tfisg001
	where   tfisg001._index1 = {:l.pksp}
	selectdo
		new.irno = tfisg001.irno
		
		in.date.utc = utc.to.date(tfisg001.irdt,yearno,monthno,month_dayno,hours,minutes,seconds)
		date.var = date.to.num(yearno,monthno,month_dayno)
		pksp.str = str$(l.pksp)
		pksp.str = shiftl$(strip$(pksp.str))
		
		if isspace(tfisg001.rcno) then
			select tfacp251.rcno,tfacp251.rseq,tfacp251.orno
			from    tfacp251
| 			where   tfacp251._index1 = {:curr.comp,:tfisg001.invt,:tfisg001.pinv,:curr.comp,:pksp.str}
			where   tfacp251._index1 = {:curr.comp,:o.tfacp200.ttyp,:o.tfacp200.ninv,:curr.comp,:pksp.str}
			as set with 1 rows
			selectdo
				rcno.var = tfacp251.rcno 
				amnt.total = 0
				select	tfacp935.tbam, tfacp935.vamt	from	tfacp935
				where	tfacp935._index1 = {:curr.comp,1,:tfacp251.orno}
				and	tfacp935.rcno	 = {:tfacp251.rcno}
				and	tfacp935.rseq	 = {:tfacp251.rseq}
				selectdo
					amnt.total = amnt.total + tfacp935.vamt	
				selectempty
					grna.w = 0
				endselect
				
				select whisg312.amnt
				from   whisg312
				where  whisg312._index1 = {:tfacp251.rcno,:tfacp251.rseq}
				selectdo
				selectempty
					select tdpur406.damt
					from    tdpur406
					where   tdpur406._index2 = {:tfacp251.rcno,:tfacp251.rseq}
					selectdo
						
					endselect	
				endselect
			endselect
			
		else
			rcno.var = tfisg001.rcno
			amnt.total = 0
			select	tfacp935.tbam, tfacp935.vamt	from	tfacp935
			where	tfacp935._index1 = {:curr.comp,1,:tfisg001.orno}
			and	tfacp935.rcno	 = {:tfisg001.rcno}
			and	tfacp935.rseq	 = {:tfisg001.rcln}
			selectdo
				amnt.total = amnt.total + tfacp935.vamt	
			selectempty
				grna.w = 0
			endselect
			select whisg312.amnt
			from   whisg312
			where  whisg312._index1 = {:tfisg001.rcno,:tfisg001.rcln}
			selectdo
			selectempty
				select tdpur406.damt
				from    tdpur406
				where   tdpur406._index2 = {:tfacp251.rcno,:tfacp251.rseq}
				selectdo
					
				endselect	
			endselect
		endif	
		if whisg312.amnt <> 0 then
			grna.w = amnt.total + whisg312.amnt
		else
			grna.w = amnt.total + tdpur406.damt
		endif	
	
	selectempty
		in.date.utc = utc.to.date(tfisg001.irdt,yearno,monthno,month_dayno,hours,minutes,seconds)
		date.var = date.to.num(yearno,monthno,month_dayno)
		pksp.str = str$(l.pksp)
		pksp.str = shiftl$(strip$(pksp.str))
		
		select tfacp251.rcno,tfacp251.rseq,tfacp251.orno
		from    tfacp251
		where   tfacp251._index2 = {:curr.comp,:pksp.str}
		as set with 1 rows
		selectdo
			rcno.var = tfacp251.rcno 
			amnt.total = 0
			select	tfacp935.tbam, tfacp935.vamt	from	tfacp935
			where	tfacp935._index1 = {:curr.comp,1,:tfacp251.orno}
			and	tfacp935.rcno	 = {:tfacp251.rcno}
			and	tfacp935.rseq	 = {:tfacp251.rseq}
			selectdo
				amnt.total = amnt.total + tfacp935.vamt	
			selectempty
				grna.w = 0
			endselect
			
			select whisg312.amnt
			from   whisg312
			where  whisg312._index1 = {:tfacp251.rcno,:tfacp251.rseq}
			selectdo
			selectempty
				select tdpur406.damt
				from    tdpur406
				where   tdpur406._index2 = {:tfacp251.rcno,:tfacp251.rseq}
				selectdo
					
				endselect	
			endselect
		endselect
		if whisg312.amnt <> 0 then
			grna.w = amnt.total + whisg312.amnt
		else
			grna.w = amnt.total + tdpur406.damt
		endif	
	endselect	
}

function anticipated.payments.receipts()
{
	domain tfcmg.bank bank.f, bank.t
	bank.f = ""
	bank.t = "ZZZ"
	select	tfcmg110.cheq:cheq.w	from	tfcmg110				|Check Number 
	where	tfcmg110._index1 inrange {:bank.f} and {:bank.t}
	and	tfcmg110.tdoc = {:tfacp200.tdoc} 
	and	tfcmg110.pdoc = {:tfacp200.docn}
	selectdo
	endselect
}

function anticipated.payments.receipts.1()
{
	select	tfcmg110.cheq:cheq.w	from	tfcmg110				|Check Number 
	where	tfcmg110._index6 = {:tfacp200.ttyp,:tfacp200.ninv}
	selectdo
	endselect
}
