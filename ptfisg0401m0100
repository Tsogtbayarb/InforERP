|******************************************************************************
|* tfisg0401m010  0  VRC B61U a7 live
|* Payment Details (IR Wise)
|* Tools                         
|* 2014-05-03
|******************************************************************************
|* Main table tfisg001 GR Details, Form Type 4
|*****************************************************************************
|* ID: ISGEC001118, IT0327, Ritu Shrivastava, Dt. 18-10-2014, VRC B61U a7 isg      

|*****************************************************************************
|* ID: ISGEC01023, IT0289, Shilpa Janardanan, Dt. 16-01-2015, VRC B61U a7 isg  
|* Change in Logic for  "Supplier Invoice No.", "Invoice Amount", & new total field added
|*****************************************************************************
|* ID:149, IDENT ISGEC01051 , Mani sharma, Dt.10-02-2015, VRC B61U a7 isg
|* Change on report labels
|*****************************************************************************
|* ID : ISGECFIN013, IT0386, Saurabh Dubey, VRC B61U a7 isg
|* GST Tax Related Logic Added
|*
|* ID ISGEC001214, Priya Jindal, 18/1/2018, VRC B61U a7 isg
|* Changes in IR report
|*
|* ID ISGEC001220, Manwendra singh, 13/3/2018, VRC B61U a7 isg
|* changes in script
|*
|* ID ISGEC001232, Manwendra singh, 21/02/2019, VRC B61U a7 isg
|* Modification regarding financial company
|*
|* ID:ISGEC01199, Aditi Aggarwal, 03/09/2019, VRC B61U a7 isg
|* Modification 
|*
|* ID:ISGEC01201, Aditi Aggarwal, 18/11/2019, VRC B61U a7 isg
|* Modification in Confirmation Date
|****************************** declaration section ***************************
declaration:
#include<bic_desktop>
  table   	ttfisg001 | GR Details
  table		ttfacp200
  table		ttccom100
  table		ttfcmg110
  table		ttfcmg112				|#ISGEC001118.sn
  table		ttfcmg113
  table		ttfcmg100
  table		ttfcmg103			
  table		ttfgld102
  table		ttfgld106				|#ISGEC001118.en
  table		ttfacp100				|#ISGEC01023.n
  table		ttdpur401				|#ISGEC01023.n
  table		twhinh312				|#ISGEC01023.n
  table		ttcmcs036
  table		ttcmcs032
  table		twhinh310
  table		ttclct200
  table		ttfacp935
  table		twhinh936
  table		ttdpur406
  table		ttctax941				|#ISGEC01023.en
  table		ttfacp201				|ISGEC001214.n
  table		ttcmcs065				|ISGEC001232.n    
  table 	ttdmsl400				|ISGEC01199.n
  table		ttppdm600				|ISGEC01199.n	
  
	extern	domain	tccom.bpid	bpid.f
	extern	domain	tccom.bpid	bpid.t
	extern	domain	tfgld.docn	irno.f
	extern	domain	tfgld.docn	irno.t
	extern	domain	tccprj		cprj.f
	extern	domain	tccprj		cprj.t
	extern	domain	tcorno		orno.f
	extern	domain	tcorno		orno.t
							|#ISGEC001173.sn
	extern	domain	tfgld.date	irdt.f
	extern	domain	tfgld.date	irdt.t		|#ISGEC001173.en
	extern	domain	tcdate		o.irdt.f	|#ISGEC001220.n
	extern	domain	tcdate		o.irdt.t	|#ISGEC001220.n
	extern 	domain	tcamnt		gross_amnt	|#ISGEC01023.sn
	extern	domain	tcamnt		r.eces.per, r.cess.per, r.vat.per
	extern	domain	tcpvat		r.sgst.per, r.cgst.per, r.igst.per	|#ISGECFIN013.n
	extern	domain	tcamnt		temp.cgst.amnt, temp.igst.amnt		|#ISGECFIN013.n
	extern	domain	tcamnt		r.eces, r.cess, r.vat, add.chg,frt.amnt,add.chg.tax
	extern	domain	tcamnt		total.vat,v.eces, v.cess, v.vat, v.add.chg,tax.amnt,tot.amnt
	extern	domain	tcamnt		r.disc,cal.per
	extern	domain	tcamnt		rep.ot.amnt
	extern	domain	tcamnt		rep.exc.amnt
	extern	domain	tcamnt		rep.st.amnt
	extern	domain	tcamnt		tmp.rep.st.amnt
	extern	domain	tcamnt		tmp.rep.exc.amnt
	extern	domain	tcamnt		tmp.rep.sgst.amnt	|#ISGECFIN013.n
	extern	domain	tcamnt		rep.sgst.amnt, gross.sgst.amnt	|#ISGECFIN013.n
	extern	domain	tcamnt		line.amnt
	extern	domain	tcamnt		gros.total
	extern	domain	tcamnt		line.total
	domain	tcbool			service.tax	
	domain	tcbool			fwhinh936.found
	extern	domain	tcpric		v.totl
	extern	domain	tfgld.ttyp	link.ttyp,link.tdoc,link.typa
	extern	domain	tfgld.docn	link.ninv,link.docn,link.doca
	extern	domain	tfgld.amnt	link.amth,link.amth.1,assig.amth,ret.amnt	|#ISGEC01023.en
	extern	domain	tcmcs.str100m	reason.code,reason.amnt			|ISGEC001214.sn
	extern	domain	tcdate		cdf_oird
	extern	domain	tfgld.amnt	total_gross_amount,total_invoice_amount,total_bal_inc_reten
	extern	domain	tfgld.amnt	total_reten_amount,total_paid_amount,total_assign_amount
	string	cdf_bloc(10)
	string	line(1500), server.file(100), file.name(100)
	extern	domain	tfgld.date	ir.date,or.ir.date
	extern	domain	tcdate		whr.creation.date,whr.confirmation.date
	long	ret2, stat.fp,year1,month1,day1,hour1,minute1,second1		|ISGEC001214.en
	long yearno, yearno1
	long monthno, monthno1
	long month_dayno, month_dayno1
	long hours
	long minutes
	long seconds
	extern	domain	tcncmp	i.comp       |ISGEC001232.n    
	long			new_compnr   |ISGEC001232.n  
	extern	domain	tcmcs.str10		pay.mode	|ISGEC01199.n
	extern domain	tfcmg.cheq		o.cheq		|ISGEC01199.n
	extern	domain	tcibd.sern		var.temp	|ISGEC01201.n
	
  
|****************************** program section ********************************
before.program:					|ISGEC001232.sn
	new_compnr = get.compnr()			|ISGEC001232.en

|****************************** group section **********************************

group.1:
init.group:
   get.screen.defaults()

|****************************** choice section ********************************

choice.cont.process:
on.choice:
   execute(print.data)

choice.print.data:
on.choice:
   if rprt_open() then
       read.main.table()
       rprt_close()
   else
       choice.again()
   endif

choice.generate:			|ISGEC001214.sn
on.choice:
	generate.file()			|ISGEC001214.en

|****************************** field section *********************************

field.irno.f:
when.field.changes:
   irno.t = irno.f

field.bpid.f:
when.field.changes:
	bpid.t = bpid.f

field.orno.f:
when.field.changes:
	orno.t = orno.f

field.cprj.f:
when.field.changes:
	cprj.t = cprj.f


field.irdt.f:
when.field.changes:
	irdt.t = irdt.f
	
|****************************** function section ******************************

functions:
									|ISGEC001214.sn
function  generate.file()
{
	server.file = bse.dir$() & str$(utc.num()) & ".xls"
	
	file.name = "c:\temp\" & str$(utc.num())  & ".xls"
	
	stat.fp = seq.open(server.file, "w+")
	
	process.file()
	
| 	message("Please refer to file %s in C:", file.name)
	
	seq.close(stat.fp)
| 	if tc.is.html.ui() = false then  
| 		
| 		ret2 = server2client(server.file,file.name,1)

| 		app_start(file.name,"c:","","","") 
| 		
| 	else
| 		client.download.file(server.file,"")
| 	endif     

	ret2 = server2client(server.file,file.name,1)
	ret2 = app_start(file.name,"c:","","","")

}

function process.file()
{
	generate.header()
	read.main.table()
}

function generate.header()
{
	if stat.fp >0 then
		
| 		line =concat$("	", 						|ISGEC01199.so		
| 			sprintf$(" "),			
| 			sprintf$(" "),			 
| 			sprintf$(" "),			
| 			sprintf$(" "),		
| 			sprintf$(" "),			
| 			sprintf$(" "),		
| 			sprintf$(" "),	
| 			sprintf$(" "),		
| 			sprintf$(" "),		
| 			sprintf$("Payment Details(IR Wise)"))
| 		line = strip$(shiftl$(line))
| 		seq.puts(line, stat.fp)
| 		line =concat$("	", 
| 			sprintf$("Supplier From " & bpid.f & " To " & bpid.t))			
| 		line = strip$(shiftl$(line))
| 		seq.puts(line, stat.fp)
| 		line =concat$("	", 
| 			sprintf$("IR Number From " & str$(irno.f) & " To " & str$(irno.t)))			
| 		line = strip$(shiftl$(line))
| 		seq.puts(line, stat.fp)
| 		line =concat$("	", 
| 			sprintf$("Project From " & cprj.f & " To " & cprj.t))			
| 		line = strip$(shiftl$(line))
| 		seq.puts(line, stat.fp)
| 		line =concat$("	", 
| 			sprintf$("Purchase Order From " & orno.f & " To " & orno.t))			
| 		line = strip$(shiftl$(line))
| 		seq.puts(line, stat.fp)						|ISGEC01199.eo
		
		line =concat$("	", 
			sprintf$("IR No."),				|0.1	|ISGEC01199.n
			sprintf$("IR Date"),				|1
			sprintf$("Origial IR Date"),			|2 
| 			sprintf$("IR No."),				|3 	|ISGEC01199.o
| 			sprintf$("Supplier Invoice No."),		|4	|ISGEC01199.o
			sprintf$("Purchase Order"),			|5
			sprintf$("PO Date"),				|5.1	|ISGEC01199.n
			sprintf$("Project"),				|6
			sprintf$("Project name"),			|6.1	|ISGEC01199.n
			sprintf$("Supplier Code"),			|6.2	|ISGEC01199.n
			sprintf$("Supplier"),				|7
			sprintf$("Supplier Invoice No."),		|7.1	|ISGEC01199.n
			sprintf$("Supplier Invoice Date."),		|7.2	|ISGEC01199.n
			sprintf$("Supplier Invoice Amount."),		|7.3	|ISGEC01199.n
			sprintf$("W/H Receipt No."),			|8
			sprintf$("WHR Creation Date."),		|8.1	|ISGEC01199.n
			sprintf$("WHR Confirmation Date"),		|8.2	|ISGEC01199.n
			sprintf$("Gross Receipt Amount"),		|9
			sprintf$("Billing Assign Date"),		|10
			sprintf$("Sales Invoice Date"),		|11	
			sprintf$("Sent to Finance (Original Invoice)"),|11.1	|ISGEC01199.n
			sprintf$("Purchase Booking No./Ptr No."),	|12
			sprintf$("Purchase Booking Date/Ptr Date"),	|13
| 			sprintf$("Invoice Amount"),			|14
			sprintf$("PTR Amount"),			|14
			sprintf$("Retention Amount"),			|15
			sprintf$("Paid Amount"),			|16
			sprintf$("Assigned Amount"),			|17
			sprintf$("Balance Include Retention"),		|18
			sprintf$("Retention Amount(With Reason Codes)"),|19
			sprintf$("Payment Mode"),			|19.1	 |ISGEC01199.n
			sprintf$("Cheque/RTGS"),				|20
			sprintf$("Cheque/RTGS Date"))			|21
		line = strip$(shiftl$(line))
		seq.puts(line, stat.fp)
	endif
	
}

function write.reason.code()
{
	line = concat$("	",
		sprintf$(""),					|0.1	|ISGEC01199.n	
		sprintf$(""),					|1
		sprintf$(""),					|2	
| 		sprintf$(""),					|3	|ISGEC01199.o
| 		sprintf$(""),					|4	|ISGEC01199.o
		sprintf$(""),					|5
		sprintf$(""),					|5.1	|ISGEC01199.n
		sprintf$(""),					|6 
		sprintf$(""),					|6.1	|ISGEC01199.n
		sprintf$(""),					|6.2	|ISGEC01199.n
		sprintf$(""),					|7
		sprintf$(""),					|7.1	|ISGEC01199.n
		sprintf$(""),					|7.2	|ISGEC01199.n
		sprintf$(""),					|7.3	|ISGEC01199.n
		sprintf$(""),					|5	
		sprintf$(""),					|8
		sprintf$(""),					|8.1	|ISGEC01199.n
		sprintf$(""),					|8.2	|ISGEC01199.n
		sprintf$(""),					|9		
		sprintf$(""),					|10	
		sprintf$(""),					|11
		sprintf$(""),					|11.1	|ISGEC01199.n
		sprintf$(""),	 				|12	
		sprintf$(""),					|13			
		sprintf$(""),					|14	
		sprintf$(""),					|15	
		sprintf$(""),					|16
		sprintf$(""),					|17
		sprintf$(""),					|18
		sprintf$("%s", trim$(reason.code)))		|19
		line = strip$(shiftl$(line))
		seq.puts(line, stat.fp)
		
}
function write.data()
{	
	if cdf_oird <> 0  then
		utc.to.date(cdf_oird, year1,month1,day1,hour1,minute1,second1)
		or.ir.date = date.to.num(year1,month1,day1)
	else
		or.ir.date = 0
	endif
	
	if tfisg001.irdt <> 0  then
		utc.to.date(tfisg001.irdt, year1,month1,day1,hour1,minute1,second1)
		ir.date = date.to.num(year1,month1,day1)
	else
		ir.date = 0
	endif
	
	line = concat$("	",
		sprintf$("%d",tfisg001.irno),								|0.1	IR No.		|ISGEC01199.n
		sprintf$("%D(%02d/%02m/%04Y)",ir.date),						|1	IR Date
		sprintf$("%D(%02d/%02m/%04Y)",or.ir.date),						|2	Original IR Date
| 		sprintf$("%d",tfisg001.irno),								|3	IR No.		|ISGEC01199.o	
| 		sprintf$("%s",trim$(tfacp100.isup)),							|4	Supplier Invoice No. |ISGEC01199.o
		sprintf$("%s",trim$(tfisg001.orno)),							|5	Purchase Order
		sprintf$("%u(%02d/%02m/%04Y)",tdmsl400.apdt),						|5.1	PO Date 	|ISGEC01199.n
		sprintf$("%s",trim$(tfisg001.cprj)),							|6	Project
		sprintf$("%s",trim$(tppdm600.seak)),							|6.1	Project Name	|ISGEC01199.n
		sprintf$("%s",trim$(tfisg001.bpid)),							|6.2	Supplier Code	|ISGEC01199.n
		sprintf$("%s",trim$(tccom100.nama)),							|7	Supplier 
		sprintf$("%s",trim$(tfacp100.isup)),							|7.1	Supplier invoice No.	|ISGEC01199.n
		sprintf$("%D(%02d/%02m/%04Y)",tfacp100.invd),						|7.2	Supplier Invoice Date |ISGEC01199.n
		sprintf$("%f",tfacp100.amti),								|7.3	Supplier Invoice Amount |ISGEC01199.n
		sprintf$("%s",trim$(tfisg001.rcno)),							|8	W/H Receipt No.	
		sprintf$("%u(%02d/%02m/%04Y) ",whr.creation.date),					|8.1	WHR Creation Date	|ISGEC01199.sn
		sprintf$("%u(%02d/%02m/%04Y) ",whr.confirmation.date),						|8.2	WHR Confirmation Date	|ISGEC01199.en
		
		sprintf$("%f",gross_amnt),								|9	Gross Receipt Amount
		sprintf$("%D(%02d/%02m/%04Y)",tfisg001.bdat),	 					|10 	Billing Assign Date
		sprintf$("%D(%02d/%02m/%04Y)",tfisg001.ivdt),						|11	Sales Invoice Date
		sprintf$("%u(%02d/%02m/%04Y) ",tfisg001.date),						|11.1	Sent To Finance Date	|ISGEC01199.n
		sprintf$("%s",tfisg001.invt & str$(tfisg001.pinv)),					|12	Purchase Booking No./Ptr No.	
		sprintf$("%D(%02d/%02m/%04Y)",tfacp200.docd),						|13	Purchase Booking Date/Ptr Date
		sprintf$("%f",tfacp200.amth(1)),							|14	Invoice Amount
		sprintf$("%f",ret.amnt),								|15	Retention Amount
		sprintf$("%f",link.amth),								|16	Paid Amount
		sprintf$("%f",assig.amth),								|17	Assigned Amount
		sprintf$("%f",abs(tfacp200.amth(1)) - abs(link.amth) -abs(assig.amth)),		|18	Balance Include Retention
		sprintf$("%s",trim$(reason.code)),							|19	Reason Amount
		sprintf$("%s",trim$(pay.mode)),							|19.1	Payment Mode	|ISGEC01199.n
		sprintf$("%s",tfcmg110.cheq),								|20	Cheque
		sprintf$("%u(%02d/%02m/%04Y) %U(%02h%x%02m%x%02s %a)",tfcmg100.rdat,tfcmg100.rdat))	|21	Cheque Date
| 		sprintf$("%s",tccom122.cpay))								|22
		
		line = strip$(shiftl$(line))
		seq.puts(line, stat.fp)
		
		total_gross_amount = total_gross_amount + gross_amnt
		total_invoice_amount = total_invoice_amount + tfacp200.amth(1)
		total_reten_amount = total_reten_amount + ret.amnt
		total_paid_amount = total_paid_amount + link.amth
		total_assign_amount = total_assign_amount + assig.amth
		total_bal_inc_reten = total_bal_inc_reten + abs(tfacp200.amth(1)) - abs(link.amth) -abs(assig.amth)
		
		
}

function write.total()
{
	line = concat$("	",
		sprintf$(""),								|0.1	IR No.		|ISGEC01199.n
		sprintf$(""),								|1	IR Date
		sprintf$(""),								|2	Original IR Date
| 		sprintf$(""),								|3	IR No.
| 		sprintf$(""),								|4	Supplier Invoice No.
		sprintf$("TOTAL:"),							|5	Purchase Order
		sprintf$(""),								|5.1	PO Date 	|ISGEC01199.n	
		sprintf$(""),								|6	Project
		sprintf$(""),								|6.1	Project Name	|ISGEC01199.n
		sprintf$(""),								|6.2	Supplier Code	|ISGEC01199.N
		sprintf$(""),								|7	Supplier 
		sprintf$(""),								|7.1	Supplier invoice No.	|ISGEC01199.n
		sprintf$(""),								|7.2	Supplier Invoice Date |ISGEC01199.n
		sprintf$(""),								|7.3	Supplier Invoice Amount |ISGEC01199.n
		sprintf$(""),								|8	W/H Receipt No.	
		sprintf$(""),								|8.1	WHR Creation Date	|ISGEC01199.n
		sprintf$(""),								|8.2	WHR Confirmation Date	|ISGEC01199.n
		sprintf$("%f",total_gross_amount),					|9	Gross Receipt Amount
		sprintf$(""),	 							|10	Billing Assign Date
		sprintf$(""),								|11	Sales Invoice Date
		sprintf$(""),								|11.1	Sent To Finance Date	|ISGEC01199.n
		sprintf$(""),								|12	Purchase Booking No./Ptr No.	
		sprintf$(""),								|13	Purchase Booking Date/Ptr Date
		sprintf$("%f",total_invoice_amount),					|14	Invoice Amount
		sprintf$("%f",total_reten_amount),					|15	Retention Amount
		sprintf$("%f",total_paid_amount),					|16	Paid Amount
		sprintf$("%f",total_assign_amount),					|17	Assigned Amount
		sprintf$("%f",total_bal_inc_reten),					|18	Balance Include Retention
		sprintf$(""),								|19	Reason Amount
		sprintf$(""),								|19.1	Payment Mode	|ISGEC01199.n
		sprintf$(""),								|20	Cheque
		sprintf$(""))								|21	Cheque Date
		
		line = strip$(shiftl$(line))
		seq.puts(line, stat.fp)
}

													|ISGEC001214.en
function read.main.table()
{

	domain	tfacp.tpay	dummy.tpay

								|#ISGEC001173.sn
	
	
	yearno = 0
	monthno = 0
	month_dayno = 0
| 	hours = 0
| 	minutes = 0
| 	seconds=  0
	
	num.to.date(irdt.f, yearno, monthno, month_dayno)
| 	irdt.f = date.to.utc(yearno, monthno, month_dayno, 00, 00, 00)		|#ISGEC001220.o
	o.irdt.f = date.to.utc(yearno, monthno, month_dayno, 00, 00, 00)	|#ISGEC001220.n
	
	num.to.date(irdt.t, yearno1, monthno1, month_dayno1)
| 	irdt.t = date.to.utc(yearno1, monthno1, month_dayno1, 23, 59, 59)	|#ISGEC001220.o
	o.irdt.t = date.to.utc(yearno1, monthno1, month_dayno1, 23, 59, 59)	|#ISGEC001220.n
	
| 								|#ISGEC001173.en
	total_gross_amount = 0			|ISGEC001214.sn
	total_reten_amount = 0
	total_invoice_amount = 0
	total_paid_amount = 0
	total_assign_amount = 0			|ISGEC001214.en

	
	select 	tfisg001.*,
		tccom100.nama
	from	tfisg001,tccom100
	where	tfisg001._index1 inrange {:irno.f} and {:irno.t}
| 	and	tfisg001.irdt inrange :irdt.f and :irdt.t		|#ISGEC001173.n		|#ISGEC001220.o
	and	tfisg001.irdt inrange :o.irdt.f and :o.irdt.t					|#ISGEC001220.n
| 	and	tfisg001.cust inrange :bpid.f and :bpid.t
	and	tfisg001.bpid inrange :bpid.f and :bpid.t
	and	tfisg001.cprj inrange :cprj.f and :cprj.t
	and 	tfisg001.orno inrange :orno.f and :orno.t
| 	and	tfisg001.cust refers to tccom100
	and	tfisg001.bpid refers to tccom100
	order by tfisg001.irdt
	selectdo
		select	tdpur400.orno,tdpur400.fdpt,tcmcs065.comp			|ISGEC001232.sn     
		from	tdpur400,tcmcs065
		where 	tdpur400._index1 = {:tfisg001.orno}
		and	tdpur400.fdpt refers to tcmcs065
		selectdo
			switch.to.company(tcmcs065.comp)
	
		endselect								|ISGEC001232.en    
|  	
		
		
		select	tdmsl400.apdt						|ISGEC01199.sn
		from	tdmsl400
		where	tdmsl400._index1 = {:tfisg001.orno,0}
| 		as set with 1 rows
		selectdo
		selectempty
			tdmsl400.apdt=0
		endselect 
			
		
		select	tppdm600.seak		
		from	tppdm600
		where	tppdm600._index1 = {:tfisg001.cprj}
		selectdo
		selectempty
			tppdm600.seak =""	
		endselect							
		
		
		select	whinh310.crdt					
		from	whinh310
		where	whinh310._index1 = {:tfisg001.rcno}
		selectdo
			whr.creation.date = whinh310.crdt
		selectempty
			select	tdpur406.rcld
			from	tdpur406
			where	tdpur406._index2 = {:tfisg001.rcno}
			selectdo
				whr.creation.date = tdpur406.rcld
			selectempty
				whr.creation.date = 0
			endselect	
		endselect
		
		if strip$(tfisg001.rcno) = "" then		|ISGEC01201.sn
			var.temp = str$(tfacp100.ninv)
			select	tdpur406.ddte
			from	tdpur406
			where	tdpur406.dino = {:var.temp}
			and	tdpur406.rcno not in (select	whinh312.rcno	from	whinh312		|ISGEC01201.sn
						where	whinh312.psno = {:tfisg001.rcno})			|ISGEC01201.en
			selectdo
				whr.confirmation.date = tdpur406.ddte
			selectempty
				whr.confirmation.date = 0	
			endselect							|ISGEC01199.en
		
		else
		
			select	tdpur406.ddte
			from	tdpur406
			where	tdpur406._index2 = {:tfisg001.rcno}
			and	tdpur406.rcno not in (select	whinh312.rcno	from	whinh312		|ISGEC01201.sn
						where	whinh312.psno = {:tfisg001.rcno})			|ISGEC01201.en
			selectdo
				whr.confirmation.date = tdpur406.ddte
			selectempty
				whr.confirmation.date = 0	
			endselect							|ISGEC01199.en
		
		endif				|ISGEC01201.en				
								
								

		link.ttyp = ""
		link.tdoc = ""
		link.ninv = 0
		link.docn = 0
		link.amth = 0
		assig.amth = 0
		tfcmg110.cheq = ""
		tfcmg100.rdat = 0
		tfacp200.isup = ""
		tfacp200.amth(1) = 0
		reason.code = ""
		cdf_bloc = ""
		reason.amnt = ""
		
		ret.amnt = 0 
		tfacp200.docd = 0
		
		get_gross_amount()		|ISGEC01023.n
		select	tfacp100.*			|#ISGEC01023.sn
		from	tfacp100
		where	tfacp100._index1 = {:tfisg001.irno}
		selectdo
			get.var(pid,"tfacp100.cdf_oird",cdf_oird)	|ISGEC001214.n
		selectempty
			tfacp100.isup = ""
			cdf_oird = 0					|ISGEC001214.n
		endselect				|#ISGEC01023.en
		|********
		|* When tfacp200.tpay = 1 or 4
		|********
		
		select tfacp200.ttyp,
			tfacp200.ninv,
			tfacp200.isup,
			tfacp200.docd,
			tfacp200.amth,
			tfacp200.dued
		from	tfacp200
		where	tfacp200._index1 = {:tfisg001.invt,:tfisg001.pinv}
| 		and	(tfacp200.tpay = 1 or tfacp200.tpay = 4)		|temp.o
		and	(tfacp200.tpay = 1)		|temp.n
		selectdo
			
			link.ttyp = ""
			link.tdoc = ""
			link.ninv = 0
			link.docn = 0
			link.amth = 0
			assig.amth = 0
			ret.amnt = 0
			
			select 	tfacp200.amth(1):link.amth.1,
				tfacp200.ttyp:link.ttyp,
				tfacp200.ninv:link.ninv,
				tfacp200.tdoc:link.tdoc,
				tfacp200.docn:link.docn,
				tfacp200.tpay, tfacp200.pdoc,				|#ISGEC001118.n
				tfacp200.typa:link.typa,
				tfacp200.doca:link.doca
			from	tfacp200
			where	tfacp200._index1 = {:tfacp200.ttyp,:tfacp200.ninv}
			and	(tfacp200.tpay = 2 or tfacp200.tpay = 8 or tfacp200.tpay = 4 or tfacp200.tpay = 14)	|#sujeet29112014
			selectdo
				
| 				on case etol(tfacp200.tpay)				|#ISGEC001118.so
| 				case 2:
| 					select tfcmg110.crea,
| 						tfcmg110.cheq				
| 					from	tfcmg110
| 					where	tfcmg110.tdoc = :tfacp200.ttyp 
| 					and	tfcmg110.pdoc = :tfacp200.ninv
| 					as set with 1 rows
| 					selectdo
| 					selectempty
| 						tfcmg110.cheq = ""			
| 						tfcmg110.crea = 0
| 					endselect
| 					

| 					break
| 				case 8:
| 					select tfcmg110.crea,
| 						tfcmg110.cheq			
| 					from	tfcmg110
| 					where	tfcmg110.tdoc = :tfacp200.tdoc
| 					and	tfcmg110.pdoc = :tfacp200.docn
| 					as set with 1 rows
| 					selectdo
| 					selectempty
| 						tfcmg110.cheq = ""			
| 						tfcmg110.crea = 0
| 					endselect
| 					
| 					break
| 				endcase							|#ISGEC001118.eo
					

				on case etol(tfacp200.tpay)
				case	2:
				case	8:
					link.amth = link.amth + link.amth.1			|#sujeet29112014
					break
				case	4:
				case	14:
					assig.amth = assig.amth + link.amth.1
					break
					
				endcase
				
											|#ISGEC001118.sn
				on case etol(tfacp200.tpay)				
				case 8:
					switch.to.company(new_compnr)
					select	tfcmg100.cheq, tfcmg100.rdat,tfcmg100.chst
					from	tfcmg100
| 					where	tfcmg100.typo = :link.tdoc	  |test.o    23 feb
					where	tfcmg100.typo = :link.typa        |test.n   23 feb
| 					and	tfcmg100.doco = :link.docn	  |test.o    23 feb
					and	tfcmg100.doco = :link.doca	  |test.n   23 feb
| 					and	tfcmg100._compnr = :new_compnr
					selectdo
						if tfcmg100.chst = ltoe(5) then
							tfcmg110.cheq = "*" & strip$(shiftl$(tfcmg100.cheq))
						else
							tfcmg110.cheq = strip$(shiftl$(tfcmg100.cheq))
						endif	
						tfcmg113.rdat = tfcmg100.rdat
						
						if not isspace(tfcmg110.cheq) then				|ISGEC01199.sn
							pay.mode = "Cheque"
						endif							|ISGEC01199.en	
					selectempty
| 						Get_Cheque_Normal(link.tdoc, link.docn, link.ttyp, link.ninv, tfcmg.tcsh.cntr.ant, tfcmg110.cheq,tfcmg100.chst) |test.o
						Get_Cheque_Normal(link.typa, link.doca, link.ttyp, link.ninv, tfcmg.tcsh.cntr.ant, tfcmg110.cheq,tfcmg100.chst) |test.n
						if not isspace(tfcmg110.cheq) then				|ISGEC01199.sn
							pay.mode = "Cheque"
						endif							|ISGEC01199.en	
					endselect
					if tfcmg100.chst = ltoe(5) then
						tfcmg110.cheq = "*" & strip$(shiftl$(tfcmg100.cheq))
						if not isspace(tfcmg110.cheq) then				|ISGEC01199.sn
							pay.mode = "Cheque"
						endif							|ISGEC01199.en

					else
						tfcmg110.cheq = strip$(shiftl$(tfcmg100.cheq))
						if not isspace(tfcmg110.cheq) then				|ISGEC01199.sn
							pay.mode = "Cheque"
						endif							|ISGEC01199.en

					endif
					
					
					
					break
				case 2:
					Get_Cheque_Normal(link.tdoc, link.docn,link.ttyp, link.ninv, tfcmg.tcsh.cntr, tfacp200.pdoc,tfcmg100.chst)
| 					if tfacp200.pdoc <> "" then					|ISGEC01199.sn
| 						pay.mode = "Cheque"
| 					endif
					break
				endcase
				
				
				
											|#ISGEC001118.en
| 				rprt_send()			|#sujeet29112014
			endselect
			
											
			
			
			ret.amnt = 0
			select 	sum(tfacp201.amnt):ret.amnt
			from	tfacp201
			where	tfacp201._index1 = {:tfacp200.ttyp,:tfacp200.ninv}
			and	tfacp201.cdf_bloc <> ""
			selectdo
			endselect
			
			reason.code = ""
			cdf_bloc = ""
			reason.amnt = ""
			select	tfacp201.*						|ISGEC001214.sn
			from	tfacp201
			where	tfacp201._index1 = {:tfacp200.ttyp,:tfacp200.ninv}
			and	tfacp201.cdf_bloc <> ""			
			selectdo
				get.var(pid,"tfacp201.cdf_bloc",cdf_bloc)
				if isspace(reason.code) then
					reason.code = trim$(cdf_bloc) & "|" & str$(tfacp201.amnt)
				else
					reason.code =  reason.code & "|" & trim$(cdf_bloc) & "|" & str$(tfacp201.amnt)
				endif
| 				if isspace(reason.amnt) then
| 					reason.amnt = str$(tfacp201.amnt)
| 				else
| 					reason.amnt =  reason.amnt & "|" & str$(tfacp201.amnt)
| 				endif
			endselect	
| 			if not isspace(reason.code) then
| 				write.reason.code()				|ISGEC001214.en
| 			endif
			if isspace(pay.mode) then					|#ISGEC01199.sn
				select	a_tfacp200.tpay:dummy.tpay								
				from	tfacp200	a_tfacp200
| 				where	tfacp200._index1 = {:tfacp200.ttyp,:tfacp200.ninv}
				where	a_tfacp200._index1 = {:tfisg001.invt,:tfisg001.pinv}
| 				and	tfacp200.tdoc = :link.tdoc
| 				and	tfacp200.docn = :link.docn
				and	(a_tfacp200.tpay = tfacp.tpay.anticipated or a_tfacp200.tpay = tfacp.tpay.normal)
				as set with 1 rows
				selectdo
					pay.mode = "RTGS"
				selectempty
					pay.mode = ""
				endselect
			endif							|#ISGEC01199.en
			
			write.data()			|ISGEC001214.n
			pay.mode = "" 			|#ISGEC01199.n
| 			rprt_send()				|#sujeet29112014	|ISGEC001214.o
		selectempty
			
			write.data()			|ISGEC001214.n
| 			pay.mode = "" 			|#ISGEC01199.n

| 			rprt_send()			|ISGEC001214.o
		endselect
		
		
			
		
		
		
		switch.to.company(new_compnr)       |ISGEC001232.n  
	endselect
	write.total()
 								|#ISGEC001173.en

}


function Get_Cheque_Normal(								|#ISGEC001118.sn
			domain	tfgld.ttyp	i.tdoc,
			domain	tfgld.docn	i.docn,
			domain	tfgld.ttyp	i.ttyp,
			domain	tfgld.docn	i.ninv,
			domain	tfcmg.tcsh	i.tcsh,
		ref	domain	tfcmg.cheq	o.cheq,
		ref	domain	tfcmg.chst	o.chst
			)
{
	o.cheq = ""
	select	tfgld102.lino
	from	tfgld102
	where	tfgld102.ttyp = :i.tdoc
	and	tfgld102.docn = :i.docn
	and	tfgld102.tcsh = :i.tcsh
	and	tfgld102.ctyp = :i.ttyp
	and	tfgld102.cdoc = :i.ninv
	selectdo
		select	tfcmg112.bank, tfcmg112.tdoc, tfcmg112.pdoc
		from	tfcmg112
		where	tfcmg112._index2 = {:i.tdoc, :i.docn, :tfgld102.lino}
		selectdo
			select	tfcmg103.paym
			from	tfcmg103
			where	tfcmg103.ttyp = :tfcmg112.tdoc
			and	tfcmg103.docn = :tfcmg112.pdoc
			and	tfcmg103.bank = :tfcmg112.bank
			selectdo
				select	tfcmg100.cheq:o.cheq,
				        tfcmg100.rdat,tfcmg100.chst:o.chst
				from	tfcmg100
				where	tfcmg100._index1 = {:tfcmg112.bank, :tfcmg103.paym}
				and	tfcmg100.typo = :tfcmg112.tdoc
				and	tfcmg100.doco = :tfcmg112.pdoc
				selectdo
					tfcmg113.rdat = tfcmg100.rdat
				selectempty
					tfcmg113.rdat = 0
					o.cheq = ""
				endselect
			selectempty
				tfcmg113.rdat = 0
				o.cheq = ""
			endselect
		selectempty
			tfcmg113.rdat = 0
			o.cheq = ""
		endselect
	selectempty

		select	tfgld106.olin
		from	tfgld106
		where	tfgld106._index1 = {:i.tdoc, :i.docn}
		and	tfgld106._index9 = {:i.ttyp, :i.ninv}
		and	tfgld106.tcsh = :i.tcsh
		selectdo
			select	tfcmg112.bank, tfcmg112.tdoc, tfcmg112.pdoc
			from	tfcmg112
			where	tfcmg112._index2 = {:i.tdoc, :i.docn, :tfgld106.olin}
			selectdo
				select	tfcmg103.paym
				from	tfcmg103
				where	tfcmg103.ttyp = :tfcmg112.tdoc
				and	tfcmg103.docn = :tfcmg112.pdoc
				and	tfcmg103.bank = :tfcmg112.bank
				selectdo
					select	tfcmg100.cheq:o.cheq,tfcmg100.chst:o.chst
					from	tfcmg100
					where	tfcmg100._index1 = {:tfcmg112.bank, :tfcmg103.paym}
					and	tfcmg100.typo = :tfcmg112.tdoc
					and	tfcmg100.doco = :tfcmg112.pdoc
					selectdo
						tfcmg113.rdat = tfcmg100.rdat
					selectempty
						tfcmg113.rdat = 0
						o.cheq = ""
					endselect
				selectempty
					tfcmg113.rdat = 0
					o.cheq = ""
				endselect
			selectempty
				tfcmg113.rdat = 0
				o.cheq = ""
			endselect
		selectempty
			tfcmg113.rdat = 0
			o.cheq = ""
		endselect	
	endselect
	
}		
													|#ISGEC001118.en
function get_gross_amount()			|#ISGEC01023.sn
{
	gross_amnt = 0
	select	whinh312.*
	from	whinh312
	where	whinh312._index1 = {:tfisg001.rcno}
	selectdo
		select	whinh310.stat						|#ISGEC01199.o
		from	whinh310
		where	whinh310._index1 = {:whinh312.rcno}
		selectdo
		selectempty
		endselect
		
		select	tdpur401.*
		from	tdpur401
		where	tdpur401._index1 = {:whinh312.orno ,:whinh312.pono, :whinh312.seqn}
		selectdo
			get.discount.amount()
			v.totl = (tdpur401.pric - r.disc ) * whinh312.qrec
			rep.ot.amnt = 0
			rep.exc.amnt = 0
			rep.sgst.amnt = 0	|#ISGECFIN013.n
			rep.st.amnt = 0
			service.tax = false	
			calculate_freight()
			get.tax.rate(tdpur401.ccty, tdpur401.cvat)
			if	service.tax	then
				if	tdpur401.qoor <> 0	then
					line.amnt = (tdpur401.tass.l/tdpur401.qoor) * whinh312.qrcr
				else
					line.amnt = 0
				endif
			else
				if	tdpur401.qoor <> 0	then
					line.amnt = (tdpur401.tase.l/tdpur401.qoor) * whinh312.qrcr
				else
					line.amnt = 0
				endif
				
				if tdpur401.tasg.l <> 0.00 and tdpur401.gsta.l = tcyesno.yes then
					line.amnt = (tdpur401.tasg.l/tdpur401.qoor) * tdpur406.qiap
				endif
			endif
			
			v.eces =  ( (line.amnt * r.eces.per) / 100 )
			v.cess = (v.eces * r.cess.per) / 100 
			temp.cgst.amnt = (line.amnt * r.cgst.per) / 100 	|#ISGECFIN013.sn
			rep.sgst.amnt = (line.amnt * r.sgst.per) / 100 	
			temp.igst.amnt = (line.amnt * r.igst.per) / 100 	|#ISGECFIN013.en
			
			rep.exc.amnt = rep.exc.amnt + (v.eces + v.cess) + temp.igst.amnt
			r.eces = r.eces + v.eces
			r.cess = r.cess + v.cess
			if	tdpur401.qoor <> 0	then
				total.vat = (total.vat/tdpur401.qoor)*whinh312.qrcr
			else
				total.vat = 0
			endif
			
			if tdpur401.gsta.l = tcyesno.yes then				|#ISGECFIN013.sn
				rep.st.amnt = temp.cgst.amnt
			else								|#ISGECFIN013.en
				rep.st.amnt = ((line.amnt ) * r.vat.per) / 100 |#ISGEC01033.n
			endif	
			v.vat = ((total.vat + v.eces + v.cess  ) * r.vat.per) / 100
			rep.st.amnt = ((total.vat + rep.exc.amnt  ) * r.vat.per) / 100
			on case whinh310.stat
				case whinh.rhst.confirmed:
					get.tax.from.tfacp935(whinh312.rcno, whinh312.rcln, whinh312.orno, whinh312.pono,
								whinh312.seqn)
				break
				case whinh.rhst.open:
					tmp.rep.exc.amnt = rep.exc.amnt
					tmp.rep.st.amnt = rep.st.amnt
					tmp.rep.sgst.amnt = rep.sgst.amnt	|#ISGECFIN013.n
					fwhinh936.found = false		
					get.tax.from.whinh936()

					if	fwhinh936.found = false	then
						rep.st.amnt = tmp.rep.st.amnt
						rep.exc.amnt = tmp.rep.exc.amnt
						rep.sgst.amnt = tmp.rep.sgst.amnt
					endif	
				break	
			ENDCASE	
			
			line.total = 0
			line.total = (rep.ot.amnt + rep.exc.amnt + rep.st.amnt + rep.sgst.amnt) + (whinh312.qrcr * tdpur401.pric)
			gross_amnt = gross_amnt + line.total
| 			gross_amnt = gross_amnt +(whinh312.qrcr * tdpur401.pric)	
		selectempty
			gross_amnt = 0 
		endselect	
	selectempty
		get_gross_fromservice()
| 		gross_amnt = 0 
	
	endselect
}						|#ISGEC01023.en

function get.discount.amount()
{
	r.disc = 0
	
	if tdpur401.disc(1) <> 0 then 	| disc % 
		r.disc = tdpur401.pric * tdpur401.disc(1) / 100
	else
		if tdpur401.ldam(1) <> 0 then  | disc amnt	
			r.disc = tdpur401.ldam(1)
		endif
	endif
}


function get.tax.rate(domain tcccty i.ccty, 
		      domain tccvat i.cvat)
{
	domain	tcpvat	gst.pvat	|#ISGECFIN013.n
	
	r.eces.per = 0 
	r.cess.per = 0
	r.vat.per = 0
	
	r.cgst.per = 0	|#ISGECFIN013.sn	
	r.sgst.per = 0	
	gst.pvat = 0	
	r.igst.per = 0	|#ISGECFIN013.en
	
	select 	tctax941.*
	from 	tctax941
	where	tctax941._index1={:i.ccty,
				  :i.cvat}
	and	tctax941.type = {20}
	selectdo
		select 	tcmcs036.*
		from 	tcmcs036
		where	tcmcs036._index1={:tctax941.ccty,
					  :tctax941.cvat}
		selectdo
			if tcmcs036.indt.l = tctax.indt.l.bed or
				tcmcs036.indt.l = tctax.indt.l.service	then 
				select 	tcmcs032.*
				from 	tcmcs032
				where	tcmcs032._index1={:tcmcs036.ccty,
							  :tcmcs036.cvat}
				order by tcmcs032._index1 desc
				as set with 1 rows
				selectdo
					r.eces.per = tcmcs032.pvat
				endselect
				
				if	tcmcs036.indt.l = tctax.indt.l.service	then
					service.tax = true
				endif	
				
			endif
			
			if tcmcs036.indt.l = tctax.indt.l.e.cess.excise or
			   tcmcs036.indt.l = tctax.indt.l.hse.cess.excise or
			   tcmcs036.indt.l = tctax.indt.l.e.cess.service or		 
			   tcmcs036.indt.l = tctax.indt.l.hse.cess.servic 	then 
				select 	tcmcs032.*
				from 	tcmcs032
				where	tcmcs032._index1={:tcmcs036.ccty,
							  :tcmcs036.cvat}
				order by tcmcs032._index1 desc
				as set with 1 rows
				selectdo
					r.cess.per = r.cess.per + tcmcs032.pvat
				endselect
			endif
			
									|#ISGECFIN013.sn
			if tcmcs.dll0036.tax.code.is.of.type.gst(tcmcs036.ccty, tcmcs036.cvat) then 
				if not tcmcs.dll0032.get.tax.rate.l(	tcmcs036.ccty, 
									tcmcs036.cvat,
									gst.pvat) 	then
				else
					gst.pvat = 0.00
				endif
				
				on case tcmcs036.indt.l
				case tctax.indt.l.cgst:
					r.cgst.per = r.cgst.per + gst.pvat
					r.igst.per = 0.00
					break
					
				case tctax.indt.l.sgst:
				case tctax.indt.l.utgst:
					r.sgst.per = r.sgst.per + gst.pvat
					r.igst.per = 0.00
					break	
				
				case tctax.indt.l.igst:
					r.igst.per = r.igst.per + gst.pvat
					r.cgst.per = 0.00
					r.sgst.per = 0.00
					break	
				endcase
			endif
									|#ISGECFIN013.en	
					
			if tcmcs036.indt.l = tctax.indt.l.vat  or
			tcmcs036.indt.l = tctax.indt.l.cst	or
			tcmcs036.indt.l = tctax.indt.l.lst	or
			tcmcs036.indt.l	= tctax.indt.l.n.a	then 
				select 	tcmcs032.*
				from 	tcmcs032
				where	tcmcs032._index1={:tcmcs036.ccty,
							  :tcmcs036.cvat}
				order by tcmcs032._index1 desc
				as set with 1 rows
				selectdo
					r.vat.per = r.vat.per + tcmcs032.pvat
				endselect
			endif
		endselect
	endselect
	
}

function calculate_freight()
{
	frt.amnt = 0
	add.chg = 0
	domain tcamnt	additional.amount
	select 	tclct200.lcos, sum(tclct200.lcam):additional.amount
	from	tclct200
	where	tclct200._index1 = {21, 100, :tfisg001.rcno, :1}
	
	group by tclct200.lcos
	wherebind(1, str$(whinh312.rcln))
	selectdo
		select	tclct115.dsca from tclct115
		where	tclct115._index1 = {:tclct200.lcos}
		selectdo
		endselect
		if tclct200.lcos = "FRT0001     " then
			frt.amnt = additional.amount
		else
			add.chg = add.chg + additional.amount
		endif
		rep.ot.amnt = rep.ot.amnt + additional.amount
	endselect
| 	if tdpur401.txin.l = tcyesno.no then
| 		g.totl = g.totl + frt.amnt + add.chg
| 	endif
	
}
function get.tax.from.tfacp935(domain	tcorno	rcno, domain	tcpono rcln, domain	tcorno	orno
				, domain	tcpono	pono
				, domain	tcpono	sqnb)
{
	domain	tcamnt	amount
	
	rep.exc.amnt = 0
	rep.st.amnt = 0
	
	select	tfacp935.ccty, tfacp935.cvat, sum(tfacp935.vamt):amount
	from	tfacp935
	where	tfacp935.rcno = :rcno
	and	tfacp935.rseq = :rcln
	and	tfacp935.orno = :orno			
	and	tfacp935.pono = :pono			
	and	tfacp935.sqnb = :sqnb			
	group by tfacp935.ccty, tfacp935.cvat
	selectdo
		select	tcmcs036.indt.l,tcmcs036.dsca
		from	tcmcs036
		where	tcmcs036._index1 = {:tfacp935.ccty, :tfacp935.cvat}
		selectdo
			on case etol(tcmcs036.indt.l)
			case 1:				|Service
			case 4:				|Basic Excise Duty
			case 9:				|Basic Custom Duty	
			case 10:			|Countervailing Duty
			case 14:			|ECess CVD
			case 15:			|ECess on Custom
			case 16:			|Ecess on Service
			case 17:			|Ecess on Excise
			case 19:			|SHE Cess on CVD
			case 20:			|SHE Cess on Excise
			case 21:			|SHE Cess on Service
			case 22:			|SHE Cess on Custom
			case 42:			|IGST					|#ISGECFIN013.sn
				rep.exc.amnt = rep.exc.amnt + amount
				break
			case 40:			|SGST		
			case 43:			|UTGST		
				rep.sgst.amnt = rep.sgst.amnt + amount
				break								|#ISGECFIN013.en
			case 2:				|Local Sales Tax	
			case 3:				|Central Sales Tax
			case 26:			|VAT
			case 30:			|Not Applicable
			case 41:			|CGST		|#ISGECFIN013.n
				rep.st.amnt = rep.st.amnt + amount
			endcase
		endselect
	endselect
}

function get.tax.from.whinh936()
{
	domain	tcamnt	amount
	
	rep.exc.amnt = 0
	rep.st.amnt = 0
	
	select   sum(whinh936.aamt):amount, whinh936.rcno, whinh936.taxc, whinh936.pvat
	from	 whinh936
	where	 whinh936._index1 = {:whinh312.rcno,:whinh312.rcln}
	group by whinh936.rcno,whinh936.taxc,whinh936.pvat
	selectdo
		fwhinh936.found = true		|#ISGECDV001020.n
		select	tcmcs036.indt.l,tcmcs036.dsca
		from	tcmcs036
		where	tcmcs036._index1 = {"IN", :whinh936.taxc}
		selectdo
			on case etol(tcmcs036.indt.l)
			case 1:				|Service
			case 4:				|Basic Excise Duty
			case 9:				|Basic Custom Duty	
			case 10:			|Countervailing Duty
			case 14:			|ECess CVD
			case 15:			|ECess on Custom
			case 16:			|Ecess on Service
			case 17:			|Ecess on Excise
			case 19:			|SHE Cess on CVD
			case 20:			|SHE Cess on Excise
			case 21:			|SHE Cess on Service
			case 22:			|SHE Cess on Custom
			case 42:			|IGST		|#ISGECFIN013.sn
				rep.exc.amnt = rep.exc.amnt + amount
				break
			case 40:			|SGST	
			case 43:			|UTGST	
				rep.sgst.amnt = rep.sgst.amnt + amount	|#ISGECFIN013.en
				break	
			case 2:				|Local Sales Tax	
			case 3:				|Central Sales Tax
			case 26:			|VAT
			case 30:			|Not Applicable
			case 41:			|CGST		
				rep.st.amnt = rep.st.amnt + amount
			endcase
		endselect
	endselect
}


function get_gross_fromservice()
{
	v.eces = 0
	v.cess = 0
	select	tdpur406.*
	from	tdpur406
	where	tdpur406._index2 =  {:tfisg001.rcno}
	selectdo
		select	tdpur401.*
		from	tdpur401
		where	tdpur401._index1 =  {:tdpur406.orno, :tdpur406.pono, :tdpur406.sqnb}
		selectdo
			get.discount.amount()
			v.totl = (tdpur401.pric - r.disc ) * tdpur406.qiap
			rep.ot.amnt = 0
			rep.exc.amnt = 0
			rep.st.amnt = 0
			service.tax = false	
			calculate_freight()
			get.tax.rate(tdpur401.ccty, tdpur401.cvat)
			if	service.tax	then
				if	tdpur401.qoor <> 0	then
					line.amnt = (tdpur401.tass.l/tdpur401.qoor) * tdpur406.qiap
				else
					line.amnt = 0
				endif
			else
				if	tdpur401.qoor <> 0	then
					line.amnt = (tdpur401.tase.l/tdpur401.qoor) * tdpur406.qiap
				else
					line.amnt = 0
				endif
							|#ISGECGFIN013.sn
				if tdpur401.tasg.l <> 0.00 and tdpur401.gsta.l = tcyesno.yes then
					line.amnt = (tdpur401.tasg.l/tdpur401.qoor) * tdpur406.qiap
				endif
							|#ISGECFIN013.en
			endif
			
			v.eces =  ( (line.amnt * r.eces.per) / 100 )
			v.cess = (v.eces * r.cess.per) / 100 
			
			temp.cgst.amnt = (line.amnt * r.cgst.per) / 100 	|#ISGECFIN013.sn
			rep.sgst.amnt = (line.amnt * r.sgst.per) / 100 	
			temp.igst.amnt = (line.amnt * r.igst.per) / 100 	|#ISGECFIN013.en
			
| 			rep.exc.amnt = rep.exc.amnt + (v.eces + v.cess) 
			rep.exc.amnt = rep.exc.amnt + (v.eces + v.cess) + temp.igst.amnt
			r.eces = r.eces + v.eces
			r.cess = r.cess + v.cess
			if	tdpur401.qoor <> 0	then
				total.vat = (total.vat/tdpur401.qoor)*tdpur406.qiap
			else
				total.vat = 0
			endif	
			v.vat = ((total.vat + v.eces + v.cess  ) * r.vat.per) / 100
			
			if tdpur401.gsta.l = tcyesno.yes then				|#ISGECFIN013.sn
				rep.st.amnt = temp.cgst.amnt
			else		
				rep.st.amnt = ((total.vat + rep.exc.amnt  ) * r.vat.per) / 100
			endif
			if	tdpur406.conf = tcyesno.yes	then
					get.tax.from.tfacp935(tdpur406.rcno, tdpur406.rseq, tdpur406.orno, tdpur406.pono,
						tdpur406.sqnb	)
			endif
			
			
			line.total = 0
			line.total = (rep.ot.amnt + rep.exc.amnt + rep.st.amnt + rep.sgst.amnt) + (tdpur406.qiap * tdpur401.pric)
			gross_amnt = gross_amnt + line.total
		endselect	
	selectempty	
			gross_amnt = 0
	endselect
}
