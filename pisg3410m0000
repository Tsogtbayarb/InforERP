|******************************************************************************
|* whmsl3410r  0  VRC B61U a  msl 
|* Purchase Bill Approval Memo
|* Dhirender                     
|* 2009-07-23
|******************************************************************************
|* Main table whinh310 Receipt Headers, Form Type 4
|******************************************************************************
|* ISGECDV001020, IT0205, Arjit Gupta, Dt. 15/09/2014 VRC B61U a7 live 
|* If record exist in whinh936 then no need to pick from tdpur401
|*
|* ISGECDV001031, IT0205, Arjit Gupta, Dt. 19-09-2014, VRC B61U a7 live
|* Calculate Excise on tdpur401.tase.l and Service on tdpur401.tass.l
|*
|* ISGECDV001032, IT0205, Arjit Gupta, Dt. 20-09-2014, VRC B61U a7 live
|* Calculate Excise on tdpur401.tase.l and Service on tdpur401.tass.l on the basis 
|* of receipt quantity.
|*
|* ISGECDV001074, IT0205, Arjit Gupta, Dt. 04-10-2014, VRC B61U a7 live
|* Add SRN Details in Annexure Report.
|*
|* ISGECDV001078, IT0205, Arjit Gupta, Dt. 04-10-2014, VRC B61U a7 live
|* Tax Calculation based on PO line wise 
|*
|* ISGECDV001146, IT0205, Arjit Gupta, Dt. 07-11-2014, VRC B61U a7 live
|* Add GR Weight & Vehicle Number

|* ISGEC01046, IT0289, Shilpa Janardanan , Dt. 04-02-2015, VRC B61U a7 live
|* Checking the taxes in financial company

|*
|* ID: ISGEC001172, IT0327, Ritu Shrivastava, Dt. 05-03-2015, VRC B61U a7 isg
|* Modification to calculate taxes as per the tax break down structure.

|* ISGEC001174, IT0289, Shilpa Janardanan, Dt. 20-03-2015,VRC B61U a7 live
|* Tax calculation according to the layers
|*
|* PATCH002015, Mani sharma , Dt. 24-03-2015, VRC B61U a7 isg
|* Change supplier address fields
|****************************** declaration section ***************************
declaration:

table	twhinh310 | Receipt Headers
table	twhinh312
table	twhinh940
table	ttdpur400
table	ttdpur401	
table	ttccom130
table	ttcibd001
table	ttctax400
table	ttctax941
table   ttcmcs041
table	ttcmcs013
table	ttcmcs032
table	ttcmcs052
table	ttcmcs036
table   ttcmcs143
table	ttcmcs010
table   ttcmcs080  | transporter Name
table   ttccom139  |PATCH002015.n
	table	ttppdm600
	table	ttfisg001
	table	ttfisg003
	table	ttcisg001
	table	ttdisg001
	table	ttpisg005
	table	twhisg312
| 	table	ttdmsl121
| 	table   ttimsl000
table   twhinh936
table	ttclct200, ttclct115, ttfacp935
table	ttcmcs003
	table	ttdmsl400
	table	tttaad200
	table	ttppdm740
	table	ttfisg002
	table	ttfisg000
	table	ttdisg452			|#ISGECDV001074.n

extern  domain  whinh.shpm       rcno.f    
extern  domain  whinh.shpm       rcno.t  
extern  domain  tcdsca           v.dsca
extern  domain  tcpric           v.totl,g.totl,gv.totl,rate.pric
extern  domain  tcfovn           v.tino,v.ecno 
extern  domain  tcsern	    srno
extern  domain tcamnt	    bed.amount, ecess.amount,hecess.amount,cst.amount,ad.amount, total.amount, decc, final.amount
extern  domain tcmcs.st65m       amount1,amount2,amount3,amount4, amount5, amount6
extern  domain tcmcs.s130m       decode0,decode1,decode2,decode3,decode4,decode5,decode6,decode7
extern 	domain tcmcs.str20	rcpt.date,pur.date,inv.date
extern	domain	tcnama		reportdesc,company_name,tc
extern	domain	tcamnt	r.eces.per, r.cess.per, r.vat.per
extern	domain	tcamnt	r.eces, r.cess, r.vat, add.chg,frt.amnt,add.chg.tax
extern	domain	tcamnt	total.vat,v.eces, v.cess, v.vat, v.add.chg,tax.amnt,tot.amnt
extern	domain	tcamnt	r.disc,cal.per
extern	domain	tclang	language
extern	domain	tcdsca	additional.code
string	qury.strg(5000)
extern 	domain tcsern a
extern  domain  tcpono  pono
extern	string additional.array(20, 5)
extern	domain	tcamnt		additional.value(5)
extern	domain	tcsern	printed.addition
|Varibales for Additional Charges

extern  domain	tcccty		g.imp.tax.country
extern  domain	tccvat		g.imp.group.tax.code
extern  domain	tcdate		g.imp.tax.date
extern  domain	tcamnt		g.imp.order.line.price
extern  domain	tcamnt		g.imp.customs.value
extern  domain	tcamnt		g.imp.market.retail.price
extern  domain	tcamnt		g.imp.retail.sales.price 
extern  domain	tcamnt		g.imp.tariff.price
extern  domain	tcccur		g.imp.price.currency
extern  domain	tcdate		g.imp.rate.date
extern  domain	tcrtyp		g.imp.exchange.rate.type				
extern  domain	tcpric		g.imp.asv.excise,previous.maximum.amount
extern  domain	tcpric		g.imp.asv.vat
extern  domain	tcpric		g.imp.asv.service.tax
extern	domain	tcdate		g.ship.or.recreive.date
extern	domain	tcyesno		g.as.is.sales
extern	domain	tcyesno		g.used.goods
extern	domain	tctax.indt.l	g.duty.type.array(1,1)	based
extern	domain	tcamnt		g.duties.array(1,1)	based
extern	domain	tcpvat		g.layer.tax.rate(1,1)	based
extern	domain	tcamnt		g.layer.base.amount.array(1, 1)	based
extern	domain	tcamnt		g.layer.tax.amount.array(1, 1)	based
extern	domain	tccvat		g.layer.tax.code.array(1, 1)	based
extern	domain	tctax.indt.l	g.line.indirect.tax.array(1,1) 	based
extern	domain	tcyesno		g.expensed.tax(1,1)		based
domain	tcmcs.s250m	comb.output.set(1)	based
extern	domain	tcamnt		f.claimable
extern	domain	tcamnt		f.non.claimable
extern	domain	tcamnt		f.total,totaltax ,grndtotaltax ,truetotaltax
extern	domain	tcamnt		f.layer.base.amnt,var
extern	domain	tcamnt		f.layer.tax.amnt	
extern	domain	tcpvat		f.layer.tax.rate	
extern	domain	tctax.indt.l	f.indirect.tax		
extern	domain	tcdsca		f.tax.code.dsca
extern		long	i, j
extern	domain	tccvat		f.cvat
extern	domain	tcnamb		tax   
	long	line.no
domain	tcmcs.s250m	i.comb.output.set(1) based
domain	tccvat		o.line.tax.code.array(1,1)	based
domain	tctax.indt.l	i.duty.type.array(1,1)	based
domain	tcamnt 		i.duties.array(1,1)	based
domain	tcpvat		o.tax.rates(1,1)	based
domain	tctax.seqn	o.maximum.sequence.number
domain	tcamnt		o.line.base.amount.array(1,1)	based
domain	tcamnt		o.line.tax.amount.array(1,1)	based
domain	tctax.indt.l	o.line.indirect.tax.array(1,1)	based
domain	tcyesno		o.expensed.tax(1,1)	based
domain	tcamnt		o.total.tax.amount
domain	tcamnt		o.sales.tax
domain	tcmcs.s250m	o.error.msg

extern	domain	tcnama		v.nama
extern	domain	tcmcs.str100	v.ln01,v.ln02,v.ln03,v.ln04,v.ln05
	extern	domain	tcmcs.str16	progname
	extern	domain	whinh.shpm	im.rcno
	extern	domain	tcyesno		with.tax
	extern	domain	tcbool		fwhinh936.found		|#ISGECDV001020.n
	extern	domain	tcnama		rep.prj.nama
	extern	domain	tcnamd		rep.prj.namd
	extern	domain	tcmcs.str100m	rep.prj.ln01
	extern	domain	tcmcs.str100m	rep.prj.ln03
	extern	domain	tcdsca		rep.prj.dsca
	extern	domain	tcmail		rep.prj.info
	extern	domain	tcamnt		rep.ot.amnt
	extern	domain	tcamnt		rep.exc.amnt
	extern	domain	tcamnt		rep.st.amnt
	extern	domain	tcamnt		tmp.rep.st.amnt
	extern	domain	tcamnt		tmp.rep.exc.amnt
	extern	domain	tcamnt		line.amnt
	extern	domain	tcamnt		gros.total
	extern	domain	tcamnt		line.total
	extern	domain	tfgld.amnt	gros.amnt.total
	extern	domain	tfgld.amnt	gros.exc.amnt
	extern	domain	tfgld.amnt	gros.ot.amnt
	extern	domain	tfgld.amnt	gros.st.amnt
	extern	domain	tfgld.amnt	less.amnt
	extern	domain	tfgld.amnt	gros.less.amnt
	extern	domain	tcmcs.long	prnt
	extern	domain	tcdsca		rep.free.issue
	extern	domain	tcyesno		free.issue
	extern	domain	tcnama		rep.prd.by
	extern	domain	tcnama		rep.tran.name
	extern	domain	tcmcs.long	rpt.no
	extern	domain	tcdsca		rep.from.place
	extern	domain	tcdsca		rep.to.place
		domain	tcbool		service.tax			|#ISGECDV001031.n
		
	extern domain tcdesc  vend.nama,vend.namb,vend.namc,vend.namd,vend.namf,vend.pstc,vend.telp,vend.tefx,vend.dsca,vend.ccty,vend.cste,vend.ccit |PATCH002015.n	
	domain	tcncmp		fin_comp, curr_comp		|#ISGEC01046.n
	domain tctax.layr.l	layer.temp1,layer.temp2		|#ISGEC001174.n
|****************************** program section ********************************
before.program:
	reportdesc = "Purchase Bill Approval Memo"
	language = language$
	import("prog.name$", progname)
	on case trim$(progname)
		case "whinh3512m000":
			import("whinh310.rcno", im.rcno)
			rcno.f = im.rcno
			rcno.t = im.rcno
			break
	ENDCASE		
	curr_comp = get.compnr()			|ISGEC01046.n
|****************************** group section **********************************

group.1:
init.group:
   get.screen.defaults()

|****************************** choice section ********************************

choice.cont.process:
on.choice:
   execute(print.data)

choice.print.data:
on.choice:
| 	if rprt_open() then
| 		if reportno = 1   then
| 			read.main.table()
| 		endif	
| 		for i = 1 to 5 step 1
| 			additional.array(1, i) = ""
| 			additional.value(i) = 0
| 		endfor

| 		if reportno = 2 then
| 			read.main.table2()
| 		else
| 			read.main.table2()	
| 		endif		
| 		rprt_close()
| 	else
| 		choice.again()
| 	endif
	rpt.no = 0
	spool.open("",spool.device,1)
		rpt.no = brp.open("rwhisg341001003",spool.device,0)
		if rpt.no > 0 then
			read.main.table()
			brp.close(rpt.no)
		else
			choice.again()
		endif
		
		rpt.no = brp.open("rwhisg341001004",spool.device,0)
		if rpt.no > 0 then
			read.main.table.annexure()
			brp.close(rpt.no)
		else
			choice.again()
		endif
		
	spool.close()

|****************************** field section *********************************

field.rcno.f:
when.field.changes:
	rcno.t = rcno.f
	
before.zoom:
	qury.strg = "whinh310.rcno in (select whinh312.rcno from whinh312 where whinh312.oorg in (1,2,3,80,81,82))"	
	query.extend.where.in.zoom(qury.strg)

|****************************** function section ******************************

functions:

function read.main.table()
{
	srno =0
	g.totl = 0
	v.totl =0
	bed.amount =0
	ecess.amount =0
	hecess.amount =0
	cst.amount =0
	ad.amount =0
	total.amount =0
	decc =0
	final.amount =0
	r.eces.per = 0 
	r.cess.per = 0
	r.vat.per = 0
	r.eces = 0
	r.cess = 0
	r.vat = 0
	add.chg = 0
	
	v.eces = 0
	v.cess = 0
	v.vat = 0
	v.add.chg = 0
	total.vat = 0
	fwhinh936.found = false		|#ISGECDV001020.n

	fin_comp = 0		|#ISGEC01046.n
	
	select	ttaad200.name:rep.prd.by
	from	ttaad200
	where	ttaad200._index1 = {:1}
	and	ttaad200._compnr = 000
	wherebind(1, logname$)
	selectdo
	selectempty
		rep.prd.by = ""
	endselect
	

	select	whinh310.*
	from	whinh310
	where	whinh310._index1 inrange {:rcno.f} and {:rcno.t}
	order by whinh310._index1
	selectdo
		gros.total = 0
		gros.amnt.total = 0
		gros.exc.amnt = 0
		gros.ot.amnt = 0
		gros.st.amnt = 0
		gros.less.amnt = 0
		prnt = 0
			
		select	whinh312.*
		from	whinh312
		where	whinh312._index1 = {:whinh310.rcno}
		selectdo
			tmp.rep.st.amnt = 0
			tmp.rep.exc.amnt = 0
			
			if	free.issue = tcyesno.yes	then
				rep.free.issue = "Free Issue Delivery"
			else
				rep.free.issue = ""
			endif
				
			select	whisg312.inrq
			from	whisg312
			where	whisg312._index1 = {:whinh312.rcno, :whinh312.rcln}
			selectdo
			selectempty
				whisg312.inrq = ""
			endselect
			
			select	tfisg001.irno, tfisg001.irdt, tfacp100.isup, tfacp100.invd,
				tfacp100.amth
			from	tfisg001, tfacp100
			where	tfisg001._index1 = {:1}
			and	tfisg001.irno refers to tfacp100 Unref Clear
			as set with 1 rows
			wherebind(1, lval(whinh310.dino))
			selectdo
				select	tfisg003.grno, tfisg003.grdt
				from	tfisg003
				where	tfisg003._index3 = {:tfisg001.irno}
				as set with 1 rows
				selectdo
				endselect
			endselect	
					
			srno = srno +1

			pur.date = sprintf$("%u(%02d/%02m/%04Y)", whinh312.trdt)
			select	tcibd001.dsca
			from	tcibd001
			where	tcibd001._index1 = {:whinh312.item}
			selectdo
				v.dsca = tcibd001.dsca
			selectempty
				v.dsca = ""
			endselect		
			
			select	tdpur400.*, tcmcs065.dsca, tccom100.nama, tcmcs041.dsca,
				tcmcs065.comp:fin_comp				|#ISGEC01046.n
			from	tdpur400, tcmcs065, tccom100, tcmcs041
			where	tdpur400._index1 = {:whinh312.orno}
			and	tdpur400.cofc refers to tcmcs065 Unref Clear
			and	tdpur400.otbp refers to tccom100 Unref Clear
			and	tdpur400.cdec refers to tcmcs041 Unref Clear
			selectdo
				
				select	tdmsl400.vrsn, tdmsl400.apdt
				from	tdmsl400
				where	tdmsl400._index1 = {:whinh312.orno}
				and	tdmsl400.stat = tcyesno.yes
				order by tdmsl400.vrsn desc
				as set with 1 rows
				selectdo
				endselect
				
				
				select	tctax400.*
				from	tctax400
				where	tctax400._index1 = {:tdpur400.otbp}
				and	tctax400.efdt <= :whinh312.ardt
				and	(tctax400.exdt >= :whinh312.ardt or tctax400.exdt =0)
				selectdo
					if	tctax400.catg.l = tctax.catg.l.excise then
						v.ecno = tctax400.fovn
					endif 
					if	tctax400.catg.l = tctax.catg.l.lst then
						v.tino = tctax400.fovn
					endif
				endselect
				
				
				get.address(tdpur400.otad)				|PATCH002015.n
				select	tccom130.*
				from	tccom130
				where	tccom130._index1 = {:tdpur400.otad}
				selectdo
					select	tcmcs143.dsca
					from	tcmcs143
					where	tcmcs143._index1 ={:tccom130.ccty, :tccom130.cste} 
					selectdo
					endselect

					select	tcmcs010.dsca
					from	tcmcs010
					where	tcmcs010._index1 = {:tccom130.ccty} 
					selectdo
					endselect
				endselect
				
				total.vat = 0
				line.amnt = 0
				select	tdpur401.*, tppdm600.padr, tcmcs052.dsca
				from	tdpur401, tppdm600, tcmcs052
				where	tdpur401._index1 = {:whinh312.orno ,:whinh312.pono, :whinh312.seqn}
| 				and	tdpur401.rcno = :whinh312.rcno
				and	tdpur401.item = :whinh312.item
				and	tdpur401.cprj refers to tppdm600 Unref Clear
				and	tdpur401.cprj refers to tcmcs052 Unref Clear
				selectdo
| 					v.totl = tdpur401.pric * whinh312.qrec  |Changes done later on
					get.discount.amount()
					v.totl = (tdpur401.pric - r.disc ) * whinh312.qrec
					g.totl = g.totl + v.totl	
					total.vat = total.vat + tdpur401.tasv.l
| 					line.amnt = line.amnt + (whinh312.qrcr * tdpur401.pric)		|#ISGECDV001031.o
				endselect
				select	tppdm740.ofbp
				from	tppdm740
				where	tppdm740._index1 = {:tdpur401.cprj}
				as set with 1 rows
				selectdo
				selectempty
					tppdm740.ofbp = ""
				endselect
				
				if	not isspace(tppdm600.padr)	then
					Get_Project_addr(tppdm600.padr)
				endif	
				
			endselect
			rep.ot.amnt = 0
			rep.exc.amnt = 0
			rep.st.amnt = 0
			service.tax = false			|#ISGECDV001031.n
			calculate_freight()
			get.tax.rate(tdpur401.ccty, tdpur401.cvat)
								|#ISGECDV001031.sn
			if	service.tax	then
| 				line.amnt = tdpur401.tass.l		|#ISGECDV001032.o
											|#ISGECDV001032.sn
				if	tdpur401.qoor <> 0	then
					line.amnt = (tdpur401.tass.l/tdpur401.qoor) * whinh312.qrcr
				else
					line.amnt = 0
				endif
											|#ISGECDV001032.en
			else
| 				line.amnt = tdpur401.tase.l		|#ISGECDV001032.o
											|#ISGECDV001032.sn
				if	tdpur401.qoor <> 0	then
					line.amnt = (tdpur401.tase.l/tdpur401.qoor) * whinh312.qrcr
				else
					line.amnt = 0
				endif
											|#ISGECDV001032.en
			endif
								|#ISGECDV001031.en	
					
			
| 			v.eces =  ( (v.totl * r.eces.per) / 100 )
			v.eces =  ( (line.amnt * r.eces.per) / 100 )
			v.cess = (v.eces * r.cess.per) / 100 
			
			rep.exc.amnt = rep.exc.amnt + (v.eces + v.cess)
			r.eces = r.eces + v.eces
			r.cess = r.cess + v.cess
					
			if	tdpur401.qoor <> 0	then
				total.vat = (total.vat/tdpur401.qoor)*whinh312.qrcr
			else
				total.vat = 0
			endif	
			v.vat = ((total.vat + v.eces + v.cess  ) * r.vat.per) / 100
			rep.st.amnt = ((total.vat + rep.exc.amnt  ) * r.vat.per) / 100
| 				v.vat = (v.totl + v.eces + v.cess + add.chg ) * r.vat.per / 100				
| 			else
| 				v.vat = (v.totl + v.eces + v.cess ) * r.vat.per / 100
| 			endif
			r.vat =  r.vat + v.vat
			g.totl = g.totl + v.eces + v.cess + v.vat + v.add.chg
			
			on case whinh310.stat
				case whinh.rhst.confirmed:
					get.tax.from.tfacp935()
				break
				case whinh.rhst.open:
					tmp.rep.exc.amnt = rep.exc.amnt
					tmp.rep.st.amnt = rep.st.amnt
					fwhinh936.found = false		|#ISGECDV001020.n
					get.tax.from.whinh936()
| 					if	rep.st.amnt = 0 and  rep.exc.amnt = 0	then	|#ISGECDV001020.o
					if	fwhinh936.found = false	then	|#ISGECDV001020.n
						rep.st.amnt = tmp.rep.st.amnt
						rep.exc.amnt = tmp.rep.exc.amnt
					endif	
				break	
			ENDCASE	
			
			
			line.total = 0
			line.total = (rep.ot.amnt + rep.exc.amnt + rep.st.amnt) + (whinh312.qrcr * tdpur401.pric)
			gros.amnt.total = gros.amnt.total + (whinh312.qrcr * tdpur401.pric)
			gros.exc.amnt = gros.exc.amnt + rep.exc.amnt
			gros.ot.amnt = gros.ot.amnt + rep.ot.amnt
			gros.st.amnt = gros.st.amnt + rep.st.amnt
			gros.total = gros.total + line.total
					
			tcmcs.dll0006.decode(g.totl,2,decode0,decode1,decode2,decode3, language)
			decc= lval(decode3) * 1
			tcmcs.dll0006.decode(decc,2,decode4,decode5,decode6,decode7, language)
			if isspace(decode3)  then
				amount1=toupper$("Rs. " & strip$(decode0))                       
				amount2 =toupper$(" and " & strip$(decode4) & " Paise" &" ONLY") 
			
			endif
			if not isspace(decode3)  then
				amount1=toupper$("Rs. " & strip$(decode0))                         
				amount2=toupper$(" and " & strip$(decode4)  & " Paise" &  " ONLY") 
				
			endif
			prnt = 1
| 			rprt_send()
			brp.ready(rpt.no)
			prnt = 0	
		endselect
		
		prnt = 2
| 		rprt_send()
		brp.ready(rpt.no)
		prnt = 0
		
		select	tcisg001.*
		from	tcisg001
		where	tcisg001._index1 = {:whinh312.orno, :tdmsl400.vrsn}
		and	tcisg001.cpay = {:tdpur400.cpay}
		selectdo
			select	tdisg001.*, tpisg005.desc
			from	tdisg001, tpisg005
			where	tdisg001._index1 = {:whinh312.orno, :tdmsl400.vrsn}
			and	tdisg001.pmtl = :tcisg001.srno
			and	tdisg001.docn refers to tpisg005 Unref Clear
			selectdo
				prnt = 3
				|rprt_send()
				brp.ready(rpt.no)
				prnt = 0
			selectempty
				prnt = 3
				|rprt_send()
				brp.ready(rpt.no)
				prnt = 0
			endselect	
		endselect
		
		prnt = 4
		|rprt_send()
		brp.ready(rpt.no)
		prnt = 0
		
		select	tcisg001.*
		from	tcisg001
		where	tcisg001._index1 = {:whinh312.orno, :tdmsl400.vrsn}
		and	tcisg001.cpay = {:tdpur400.cpay}
		and	tcisg001.catg in (tcisg.catg.advance, tcisg.catg.retention)
		selectdo
			less.amnt = 0
			if	with.tax = tcyesno.yes	then
				less.amnt = (tcisg001.perc * gros.total) / 100
			else	
				less.amnt = (tcisg001.perc * gros.amnt.total) / 100
			endif	
			gros.less.amnt = gros.less.amnt + less.amnt
			prnt = 5
			|rprt_send()
			brp.ready(rpt.no)
			prnt = 0
		endselect
		
	endselect
}

function read.main.table.annexure()
{
	prnt = 0
	rep.tran.name = ""
	tcmcs.dll0095.read.parm("tfisg000")
	select	whinh310.*
	from	whinh310
	where	whinh310._index1 inrange {:rcno.f} and {:rcno.t}
	order by whinh310._index1
	selectdo
		prnt = 0
			
		select	whinh312.*
		from	whinh312
		where	whinh312._index1 = {:whinh310.rcno}
		selectdo
		endselect
		
			if	free.issue = tcyesno.yes	then
				rep.free.issue = "Free Issue Delivery"
			else
				rep.free.issue = ""
			endif
				
			select	tdpur400.odat
			from	tdpur400
			where	tdpur400._index1 = {:whinh312.orno}
			selectdo
				select	tdmsl400.vrsn, tdmsl400.apdt
				from	tdmsl400
				where	tdmsl400._index1 = {:whinh312.orno}
				and	tdmsl400.stat = tcyesno.yes
				order by tdmsl400.vrsn desc
				as set with 1 rows
				selectdo
				endselect
				
				select	tdpur401.*, tcmcs052.dsca
				from	tdpur401, tcmcs052
				where	tdpur401._index1 = {:whinh312.orno ,:whinh312.pono, :whinh312.seqn}
				and	tdpur401.item = :whinh312.item
				and	tdpur401.cprj refers to tcmcs052 Unref Clear
				selectdo
				endselect
			endselect	
				
			select	tfisg001.irno, tfisg001.irdt, tfacp100.isup, tfacp100.invd,
				tfacp100.amth
			from	tfisg001, tfacp100
			where	tfisg001._index1 = {:1}
			and	tfisg001.irno refers to tfacp100 Unref Clear
			as set with 1 rows
			wherebind(1, lval(whinh310.dino))
			selectdo
				select	tfisg002.grno, tfisg002.grdt, tfisg002.grbp, tccom100.nama:rep.tran.name
				from	tfisg002, tccom100
				where	tfisg002._index1 = {:tfisg001.irno}
				and	tfisg002.grbp refers to tccom100 Unref Clear
				selectdo
					select	tfisg003.plcf, tfisg003.plct, tfisg003.citf, tfisg003.citt,
						tfisg003.cctf, tfisg003.cctt, tfisg003.bpnm, tfisg003.tmod,
						tfisg003.grwt, tfisg003.vhno					|#ISGECDV001146.n
					from	tfisg003
					where	tfisg003._index1 = {:tfisg002.grno, :tfisg002.grbp, :tfisg002.grdt}
					selectdo
						rep.from.place = get.city.desc(tfisg003.cctf, tfisg003.plcf, tfisg003.citf)
						rep.to.place = get.city.desc(tfisg003.cctt, tfisg003.plct, tfisg003.citt)
					selectempty
						rep.from.place = ""
						rep.to.place = ""
					endselect
					if	tfisg002.grbp = tfisg000.bpid	then
						rep.tran.name = tfisg003.bpnm
					endif	
					prnt = 1
					brp.ready(rpt.no)
					prnt = 0
										|#ISGECDV001074.sn
					select	tdisg452.srdt, tdisg452.srct
					from	tdisg452
					where	tdisg452._index2 = {:tfisg002.grno, :tfisg002.grbp, :tfisg002.grdt}
					selectdo
| 						prnt = 2		|#ISGECDV001146.o
						prnt = 1		|#ISGECDV001146.n
						brp.ready(rpt.no)
						prnt = 0
					endselect	
										|#ISGECDV001074.en
				selectempty
					tfisg002.grno = ""
					tfisg002.grbp = ""
					rep.tran.name = ""
					tfisg002.grdt = 0
				endselect
			endselect	
	endselect
}


function get.tax.rate(domain tcccty i.ccty, 
		      domain tccvat i.cvat)
{
	r.eces.per = 0 
	r.cess.per = 0
	r.vat.per = 0
	
	domain	tcamnt		tmp.rate, rate	|#ISGEC001174.sn
	domain	tcamnt		temp.1.rate, temp.amnt	
	
	
	tmp.rate = 0					
	temp.1.rate = 0	
	rate = 0					|#ISGEC001174.en
	
	select 	tctax941.*
	from 	tctax941
	where	tctax941._index1={:i.ccty,:i.cvat}
	and	tctax941.type = {20}
	selectdo
		select 	tcmcs036.*
		from 	tcmcs036
		where	tcmcs036._index1={:tctax941.ccty,
					  :tctax941.cvat}
		selectdo
			if tcmcs036.indt.l = tctax.indt.l.bed or
				tcmcs036.indt.l = tctax.indt.l.service	then 
				select 	tcmcs032.*
				from 	tcmcs032
				where	tcmcs032._index1={:tcmcs036.ccty,
							  :tcmcs036.cvat}
				order by tcmcs032._index1 desc
				as set with 1 rows
				selectdo
					r.eces.per = tcmcs032.pvat
				endselect
				|#ISGECDV001031.sn
				if	tcmcs036.indt.l = tctax.indt.l.service	then
					service.tax = true
				endif	
				|#ISGECDV001031.en
			endif
			
			if tcmcs036.indt.l = tctax.indt.l.e.cess.excise or
			   tcmcs036.indt.l = tctax.indt.l.hse.cess.excise or
			   tcmcs036.indt.l = tctax.indt.l.e.cess.service or		 
			   tcmcs036.indt.l = tctax.indt.l.hse.cess.servic 	then 
				select 	tcmcs032.*
				from 	tcmcs032
				where	tcmcs032._index1={:tcmcs036.ccty,
							  :tcmcs036.cvat}
				order by tcmcs032._index1 desc
				as set with 1 rows
				selectdo
					r.cess.per = r.cess.per + tcmcs032.pvat
				endselect
			endif
					
			if tcmcs036.indt.l = tctax.indt.l.vat  or
			tcmcs036.indt.l = tctax.indt.l.cst	or
			tcmcs036.indt.l = tctax.indt.l.lst	or
			tcmcs036.indt.l	= tctax.indt.l.n.a	then 
				select 	tcmcs032.*
				from 	tcmcs032
				where	tcmcs032._index1={:tcmcs036.ccty,
							  :tcmcs036.cvat}
				order by tcmcs032._index1 desc
				as set with 1 rows
				selectdo
					rate = rate + 1		|#ISGEC001174.sn
					if rate =  1 then
						r.vat.per = tcmcs032.pvat
						temp.1.rate = r.vat.per
						get.layer(layer.temp1)
					else										|#ISGEC001164.eo
						get.layer(layer.temp2)	
						if layer.temp1 = layer.temp2 then
							r.vat.per = r.vat.per + tcmcs032.pvat
						else			
							r.vat.per = r.vat.per + (temp.1.rate * (tcmcs032.pvat/100))	
							
						endif			
					endif			|#ISGEC001174.en	
| 					r.vat.per = r.vat.per + tcmcs032.pvat		|#ISGEC001174.o
				endselect
			endif
		endselect
	endselect
	
}

function get.discount.amount()
{
	r.disc = 0
	
	if tdpur401.disc(1) <> 0 then 	| disc % 
		r.disc = tdpur401.pric * tdpur401.disc(1) / 100
	else
		if tdpur401.ldam(1) <> 0 then  | disc amnt	
			r.disc = tdpur401.ldam(1)
		endif
	endif
}

function Get_Project_addr(domain tccom.cadr r.cadr)
{
	init.addr.var()
	select	a_tccom130.nama:rep.prj.nama,
		a_tccom130.namd:rep.prj.namd,
		a_tccom130.dsca:rep.prj.dsca,
		a_tccom130.ln01:rep.prj.ln01,
		a_tccom130.ln03:rep.prj.ln03,
		a_tccom130.info:rep.prj.info
	from	tccom130 a_tccom130
	where	a_tccom130._index1 = {:r.cadr}
	selectdo
	endselect	
}

function init.addr.var()
{
	rep.prj.nama = ""
	rep.prj.namd = ""
	rep.prj.ln01 = ""
	rep.prj.ln03 = ""
	rep.prj.dsca = ""
	rep.prj.info = ""
}

function read.main.table2()
{
	srno =0
	g.totl = 0
	v.totl =0
	gv.totl = 0
	bed.amount =0
	ecess.amount =0
	hecess.amount =0
	cst.amount =0
	ad.amount =0
	total.amount =0
	decc =0
	final.amount =0
	r.eces.per = 0 
	r.cess.per = 0
	r.vat.per = 0
	r.eces = 0
	r.cess = 0
	r.vat = 0
	add.chg = 0
	frt.amnt = 0
	v.eces = 0
	v.cess = 0
	v.vat = 0
	v.add.chg = 0
	total.vat = 0
	cal.per = 0 
	tax.amnt = 0 

	select	whinh310.*
	from	whinh310
	where   whinh310._index1 inrange {:rcno.f} and {:rcno.t}
	order by whinh310._index1
	selectdo
		company_address()	
		add.chg = 0
		if strip$(whinh310.einv.l)="" then
			whinh310.einv.l = whinh310.dino
			whinh310.invd.l =  whinh310.crdt
		endif
		rcpt.date= sprintf$("%u(%02d/%02m/%04Y)", whinh310.crdt)
		inv.date = sprintf$("%u(%02d/%02m/%04Y)", whinh310.invd.l)		

		select	tcmcs080.dsca
		from	tcmcs080
		where	tcmcs080._index1 = {:whinh310.carr}
		selectdo
		selectempty
			tcmcs080.dsca=""
		endselect
		
| 		select 	tdmsl121.gten,tdmsl121.rcno
| 		from 	tdmsl121
| 		where 	tdmsl121.rcno = {:whinh310.rcno}
| 		as set with 1 rows 
| 		selectdo
| 		endselect
| 		
		add.chg = 0
		pono = 0
		select	whinh312.*
		from	whinh312
		where	whinh312._index1 = {:whinh310.rcno}
		selectdo
			srno = srno +1
			
			pur.date = sprintf$("%u(%02d/%02m/%04Y)", whinh312.trdt)
			select	tcibd001.dsca
			from	tcibd001
			where	tcibd001._index1 = {:whinh312.item}
			selectdo
				v.dsca = tcibd001.dsca
			selectempty
				v.dsca = ""
			endselect		
			
			select	tdpur400.*
			from	tdpur400
			where	tdpur400._index1 = {:whinh312.orno}
			selectdo
				select 	tcmcs041.dsca
				from 	tcmcs041
				where 	tcmcs041._index1={:tdpur400.cdec}
				selectdo
				endselect

				select 	tcmcs013.dsca
				from 	tcmcs013
				where 	tcmcs013._index1={:tdpur400.cpay}
				selectdo
				endselect				
				
				select	tctax400.*
				from	tctax400
				where	tctax400._index1 = {:tdpur400.otbp}
				and	tctax400.efdt <= :whinh312.ardt
				and	(tctax400.exdt >= :whinh312.ardt or tctax400.exdt =0)
				selectdo
					if tctax400.catg.l = tctax.catg.l.excise then
						v.ecno = tctax400.fovn
					endif 
					if tctax400.catg.l = tctax.catg.l.lst then
						v.tino = tctax400.fovn
					endif
				endselect
				get.address(tdpur400.otad)				|PATCH002015.n
				select	tccom130.*
				from	tccom130
				where	tccom130._index1 = {:tdpur400.otad}
				selectdo
					select  tcmcs143.dsca
					from tcmcs143
					where tcmcs143._index1 ={:tccom130.ccty, :tccom130.cste} 
					selectdo
					endselect

					select  tcmcs010.dsca
					from tcmcs010
					where tcmcs010._index1 ={:tccom130.ccty} 
					selectdo
					endselect
				endselect
				
				total.vat = 0
				
				select	tdpur401.*
				from	tdpur401
				where	tdpur401._index1 = {:whinh312.orno ,:whinh312.pono} 
				and	tdpur401.item = :whinh312.item
				and     tdpur401.sqnb = :whinh312.seqn
				as set with 1 rows
				selectdo
					get.discount.amount()
					v.totl = (tdpur401.pric - r.disc ) * whinh312.qrec
					g.totl = g.totl + v.totl	
					total.vat = total.vat + tdpur401.tasv.l
					
				endselect
			endselect
			if	tdpur401.qidl <> 0	then
				rate.pric = tdpur401.damt/tdpur401.qidl
			else
				rate.pric = 0
			endif	
			get.tax.rate(tdpur401.ccty, tdpur401.cvat)
			v.eces =  ( (v.totl * r.eces.per) / 100 )
			v.cess = (v.eces * r.cess.per) / 100 
			r.eces = r.eces + v.eces
			r.cess = r.cess + v.cess
			
			|******* Added by tushar for fraight amnt ******** 10/05/11
			domain  tcamnt  aamt ||tushar 05.10.11 a
			aamt = 0	     ||tushar 05.10.11 a	
                        | select	tdpur938.aamt|:frt.amnt                                 
			| from	tdpur938							
			| where	tdpur938._index1 = {:whinh312.orno,:whinh312.pono}
			| and     tdpur938.ccha = "003"
			| selectdo
				|frt.amnt = (tdpur938.aamt / tdpur401.qoor) * whinh312.qrcr   |tushar 05.10.11 c
				| aamt = (tdpur938.aamt / tdpur401.qoor) * whinh312.qrcr
				| frt.amnt = frt.amnt + aamt |tushar 05.10.11 a
			| endselect
                        |***********************************************************	
			if	tdpur401.qoor <> 0	then
				total.vat = (total.vat/tdpur401.qoor)*whinh312.qrcr
			else
				total.vat = 0
			endif	
			v.vat = ((total.vat + v.eces + v.cess  ) * r.vat.per) / 100
			r.vat =  r.vat + v.vat
			
			a = 2
			gv.totl = gv.totl + v.totl
			rprt_send()			
			a = 0	
		endselect
			| g.totl = g.totl + add.chg + frt.amnt
			tcmcs.dll0006.decode(g.totl,2,decode0,decode1,decode2,decode3, language)
			decc= lval(decode3) * 1
			tcmcs.dll0006.decode(decc,2,decode4,decode5,decode6,decode7, language)
			if isspace(decode3)  then
| 				amount1=toupper$("Rs. " & strip$(decode0))  				|28.10.11(tushar)
| 				amount2 =toupper$(" and " & strip$(decode4) & " Paise" &" ONLY") 	|28.10.11(tushar)
				amount1=toupper$(" " & strip$(decode0)) 
				amount2 =toupper$(" and " & strip$(decode4) & " ONLY")
			endif
			if not isspace(decode3)  then
| 				amount1=toupper$("Rs. " & strip$(decode0))				|28.10.11(tushar)
| 				amount2=toupper$(" and " & strip$(decode4)  & " Paise" &  " ONLY")	|28.10.11(tushar)
				amount1=toupper$(" " & strip$(decode0)) 			
				amount2 =toupper$(" and " & strip$(decode4) & " ONLY")
			endif
			a = 3
			rprt_send()			
			a = 0
		g.totl = gv.totl
		get.additional.value.200()
| 		 gettax936()
	endselect
}

function	company_address()
{
	select	tcmcs003.cadr
	from	tcmcs003
	where	tcmcs003._index1 = {:whinh310.cwar}
	selectdo
		select	tccom130.*
		from	tccom130
		where	tccom130._index1 = {:tcmcs003.cadr}
		selectdo
			v.nama = tccom130.nama
			v.ln01 = tccom130.ln01
			v.ln02 = tccom130.ln02
			v.ln03 = tccom130.ln03
			v.ln04 = tccom130.ln04
			v.ln05 = tccom130.ln05
		selectempty
		endselect
	endselect
}

function gettax936()
{
	tot.amnt = 0

	extern domain tcpvat  per.pvat
	extern domain   tcamnt  cal.prnt.per,cnt,cal.tot.per
	if tax.amnt = 0 then
		select   sum(whinh936.aamt) :tax.amnt,whinh936.rcno ,whinh936.taxc,whinh936.pvat|,whinh936.tseq   |7 feb
		from	 whinh936
		where	 whinh936._index1 = {:whinh312.rcno}|,:whinh312.rcln}
		group by whinh936.rcno,whinh936.taxc,whinh936.pvat|,whinh936.tseq
	| 	order by whinh936.tseq
		selectdo
			tot.amnt = tot.amnt + tax.amnt
			if tdpur401.txin.l = tcyesno.no then
				g.totl = g.totl + tax.amnt
			endif
			
			
			for i = 1 to 5 step 1
				additional.array(1, i) = ""
				additional.value(i) = 0
			endfor
			
			select	tcmcs036.indt.l,tcmcs036.dsca
			from	tcmcs036
	| 		where	tcmcs036._index1 = {:tfacp935.ccty, :tfacp935.cvat}
			where	tcmcs036._index1 = {"IND", :whinh936.taxc}
			selectdo
				on case etol(tcmcs036.indt.l)
				case 1:
| 					additional.array(1,5) = "Service"
					additional.array(1,5) = tcmcs036.dsca
					break
				case 4:
| 					additional.array(1,1) = "Exicse"
					additional.array(1,1) = tcmcs036.dsca
					break
				case 17:
				case 20:
| 					additional.array(1,2) = "Cess"
					additional.array(1,2) = tcmcs036.dsca
					break
				case 15:
				case 22:
| 					additional.array(1,4) = "Custom"
					additional.array(1,4) = tcmcs036.dsca
					break
				case 3:
				case 2:
				case 9:
				case 30:
| 					additional.array(1,3) = "CST/VAT"
					additional.array(1,3) = tcmcs036.dsca
				endcase
			endselect
			
			for i = 1 to 5 step 1
				if not isspace(additional.array(1,i)) then
					
					additional.code = additional.array(1,i)
				endif
			endfor
			
			prnt.perc(whinh312.rcno,whinh936.taxc)
			
			tcmcs.dll0006.decode(g.totl,2,decode0,decode1,decode2,decode3, language)
			decc= lval(decode3) * 1
			tcmcs.dll0006.decode(decc,2,decode4,decode5,decode6,decode7, language)
			if isspace(decode3)  then
	| 					amount1=toupper$("Rs. " & strip$(decode0)) 				|28.10.11(tushar)
	| 					amount2 =toupper$(" and " & strip$(decode4) & " Paise" &" ONLY") 	|28.10.11(tushar)
				amount1=toupper$(" " & strip$(decode0)) 				|28.10.11(tushar)
				amount2 =toupper$(" and " & strip$(decode4) & " ONLY") 
				
			endif
			if not isspace(decode3)  then
	| 					amount1=toupper$("Rs. " & strip$(decode0))				|28.10.11(tushar)
	| 					amount2=toupper$(" and " & strip$(decode4)  & " Paise" &  " ONLY")	|28.10.11(tushar)
				amount1=toupper$(" " & strip$(decode0)) 				|28.10.11(tushar)
				amount2 =toupper$(" and " & strip$(decode4) & " ONLY")
			endif
				
			
			a = 1
			rprt_send()
			a = 0
		selectempty
			whinh936.taxc = ""
		endselect
	endif
}


function prnt.perc(domain whinh.shpm prnt.rcno,domain tccvat  prnt.cvat)
{
cnt = 0
cal.per = 0 
cal.prnt.per = 0 
cal.tot.per = 0
	select   whinh936.pvat :per.pvat ,whinh936.taxc,whinh936.eamt,whinh936.aamt
	from	 whinh936
	where	 whinh936._index1 = {:prnt.rcno}
	and      whinh936.taxc = :prnt.cvat
	selectdo
		if whinh936.eamt > 0 then                             |  11 feb 2011 
			cnt = cnt + 1
			cal.per = (per.pvat/whinh936.eamt) * whinh936.aamt
			cal.tot.per = cal.tot.per + cal.per
		else
			cal.per = 0
			cal.tot.per = 0
		endif	

	endselect
	if cal.tot.per > 0 then 
		if	cnt <> 0	then
			cal.prnt.per =  cal.tot.per / cnt
		else
			cal.prnt.per = 0
		endif	
	else
		cal.prnt.per = 0 
	endif
}


function get.additional.value.200()
{
	domain	tcamnt	additional.amount
	printed.addition = 0
	a = 1
	amount1 = ""
	amount2 = ""
| 	itdind0003.decode(g.totl,2,decode0,decode1,decode2,decode3)
	| decc= lval(decode3) * 1
	| itdind0003.decode(decc,2,decode4,decode5,decode6,decode7)
	| if isspace(decode3)  then
| 				amount1=toupper$("Rs. " & strip$(decode0)) 				|28.10.11(tushar)
| 				amount2 =toupper$(" and " & strip$(decode4) & " Paise" &" ONLY") 	|28.10.11(tushar)
		amount1=toupper$(" " & strip$(decode0))
		if isspace(decode3) then
			amount2 = ""
		else
			amount2 =toupper$(" and " & strip$(decode3) & " ONLY")
		endif
	| endif
	| if not isspace(decode3)  then
| 				amount1=toupper$("Rs. " & strip$(decode0))				|28.10.11(tushar)
| 				amount2=toupper$(" and " & strip$(decode4)  & " Paise" &  " ONLY")	|28.10.11(tushar)
		| amount1=toupper$(" " & strip$(decode0)) 
		| amount2 =toupper$(" and " & strip$(decode4) & " ONLY")
	| endif
			
	for i = 1 to 5 step 1
		additional.array(1, i) = ""
		additional.value(i) = 0
	endfor
	
	select	whinh312.rcno, whinh312.rcln, whinh312.orno, whinh312.pono,whinh312.conf
	from	whinh312
	where	whinh312._index1 = {:whinh310.rcno}
	selectdo
		if tdpur401.txin.l = tcyesno.no then
| 			if whinh312.conf = tcyesno.yes then
			if whinh310.stat = whinh.rhst.confirmed  then
				get.additional.charges.from.tclct200()
			else if whinh310.stat = whinh.rhst.open then
				gettax936()
			endif
			endif
		else 
			if whinh310.stat = whinh.rhst.confirmed  then
				get.additional.charges.from.tclct200()
			else if whinh310.stat = whinh.rhst.open then
				gettax936()
			endif
			endif
		endif
		
		select	tdpur401.txin.l, tdpur401.orno, tdpur401.pono
		from 	tdpur401
		where	tdpur401._index1 = {:whinh312.orno, :whinh312.pono}
		and	tdpur401.txin.l = tcyesno.no
		as  set with 1 rows
		selectdo
			
		endselect
	endselect
	calculate_freight()
	for i = 1 to 5 step 1
		if not isspace(additional.array(1,i)) then
			printed.addition = 1
			additional.code = additional.array(1,i)
			tax.amnt = additional.value(i)
			if tdpur401.txin.l = tcyesno.no then
				g.totl = g.totl + tax.amnt
			endif
			
| 			itdind0003.decode(g.totl,2,decode0,decode1,decode2,decode3)
			| decc= lval(decode3) * 1
			| itdind0003.decode(decc,2,decode4,decode5,decode6,decode7)
			| if isspace(decode3)  then
| 				amount1=toupper$("Rs. " & strip$(decode0)) 				|28.10.11(tushar)
| 				amount2 =toupper$(" and " & strip$(decode4) & " Paise" &" ONLY") 	|28.10.11(tushar)
				amount1=toupper$(" " & strip$(decode0)) 
				if isspace(decode3) then
					amount2 = ""
				else
					amount2 =toupper$(" and " & strip$(decode3) & " ONLY")
				endif
			| endif
			| if not isspace(decode3)  then
| 				amount1=toupper$("Rs. " & strip$(decode0))				|28.10.11(tushar)
| 				amount2=toupper$(" and " & strip$(decode4)  & " Paise" &  " ONLY")	|28.10.11(tushar)
				| amount1=toupper$(" " & strip$(decode0)) 
				| amount2 =toupper$(" and " & strip$(decode4) & " ONLY")
			| endif
			
			rprt_send()
			|frt.amnt = 0  |10.06.2013*************
		endif
	endfor
	
	for i = 1 to 5 step 1
		additional.array(1, i) = ""
		additional.value(i) = 0
	endfor
	|TCTERRY013001.so|09042013
	select 	tclct200.bobj, tclct200.lcos, sum(tclct200.lcam):additional.amount
	from	tclct200
	where	tclct200._index1 = {21, 100, :whinh310.rcno}
	group by tclct200.bobj, tclct200.lcos
	selectdo
		
		select	tclct115.dsca from tclct115
		where	tclct115._index1 = {:tclct200.lcos}
		selectdo
		endselect
		for i = 1 to 5 step 1
			if isspace(additional.array(1,i)) then
				additional.array(1,i) = tclct115.dsca
				additional.value(i) = additional.amount
				break
			endif
		endfor
	endselect
	|TCTERRY013001.eo|09042013



| 	for i = 1 to 5 step 1
| 		if not isspace(additional.array(1,i)) then
| 			printed.addition = 1
| 			additional.code = additional.array(1,i)
| 			tax.amnt = additional.value(i)
| 			g.totl = g.totl + tax.amnt
| 			itdind0003.decode(g.totl,2,decode0,decode1,decode2,decode3)
| 				| decc= lval(decode3) * 1
| 				| itdind0003.decode(decc,2,decode4,decode5,decode6,decode7)
| 				| if isspace(decode3)  then
| 	| 				amount1=toupper$("Rs. " & strip$(decode0)) 				|28.10.11(tushar)
| 	| 				amount2 =toupper$(" and " & strip$(decode4) & " Paise" &" ONLY") 	|28.10.11(tushar)
| 				amount1=toupper$(" " & strip$(decode0)) 
| 				if isspace(decode3) then
| 					amount2 = ""
| 				else
| 					amount2 =toupper$(" and " & strip$(decode3) & " ONLY")
| 				endif
| 				| endif
| 				| if not isspace(decode3)  then
| 	| 				amount1=toupper$("Rs. " & strip$(decode0))				|28.10.11(tushar)
| 	| 				amount2=toupper$(" and " & strip$(decode4)  & " Paise" &  " ONLY")	|28.10.11(tushar)
| 					| amount1=toupper$(" " & strip$(decode0)) 
| 					| amount2 =toupper$(" and " & strip$(decode4) & " ONLY")
| 				| endif
| 			rprt_send()
| 		endif
| 	endfor
	
	if not printed.addition then
		rprt_send()
	endif
	a = 0
}


function calculate_freight()
{
	frt.amnt = 0
	add.chg = 0
	domain tcamnt	additional.amount
	select 	tclct200.lcos, sum(tclct200.lcam):additional.amount
	from	tclct200
	where	tclct200._index1 = {21, 100, :whinh310.rcno, :1}
	
	group by tclct200.lcos
	wherebind(1, str$(whinh312.rcln))
	selectdo
		select	tclct115.dsca from tclct115
		where	tclct115._index1 = {:tclct200.lcos}
		selectdo
		endselect
| 		for i = 1 to 5 step 1
| 			if isspace(additional.array(1,i)) then
| 				additional.array(1,i) = tclct115.dsca
| 				additional.value(i) = additional.amount
| 				break
| 			endif
| 		endfor
		if tclct200.lcos = "FRT0001     " then
			frt.amnt = additional.amount
		else
			add.chg = add.chg + additional.amount
		endif
		rep.ot.amnt = rep.ot.amnt + additional.amount
	endselect
	|frt.amnt = additional.amount
	if tdpur401.txin.l = tcyesno.no then
		g.totl = g.totl + frt.amnt + add.chg
	endif
	
}

function get.additional.charges.from.tclct200()
{
	domain	tcncmp	company
	domain	tcamnt	amount
	domain	tcamnt	additional.amount
	company = get.compnr()
	
	select	tfacp935.ccty, tfacp935.cvat, sum(tfacp935.vamt):amount
	from	tfacp935
| 	where	tfacp935._index1 = {:company, 1, :tdpur401.orno, :tdpur401.pono}
| 	where	tfacp935._index1 = {:company, 1, :whinh312.orno, :whinh312.pono}
	where	tfacp935.rcno = :whinh312.rcno
	and	tfacp935.rseq = :whinh312.rcln
	group by tfacp935.ccty, tfacp935.cvat
	selectdo
		printed.addition = 1
		select	tcmcs036.indt.l,tcmcs036.dsca
		from	tcmcs036
		where	tcmcs036._index1 = {:tfacp935.ccty, :tfacp935.cvat}
		selectdo
			on case etol(tcmcs036.indt.l)
			case 1:
| 				additional.array(1,5) = "Service"
				additional.array(1,5) = tcmcs036.dsca
				additional.value(5) = additional.value(5) + amount
				break
			case 4:
| 				additional.array(1,1) = "Exicse"
				additional.array(1,1) = tcmcs036.dsca
				additional.value(1) = additional.value(1) + amount
				break
			case 17:
			case 20:
| 				additional.array(1,2) = "Cess"
				additional.array(1,2) = tcmcs036.dsca
				additional.value(2) = additional.value(2) + amount
				break
			case 15:
			case 22:
| 				additional.array(1,4) = "Custom"
				additional.array(1,4) = tcmcs036.dsca
				additional.value(4) = additional.value(4) + amount
				break
			case 3:
			case 2:
			case 9:
			case 30:
| 				additional.array(1,3) = "CST/VAT"
				additional.array(1,3) = tcmcs036.dsca
				additional.value(3) = additional.value(3) + amount
			endcase
		endselect
	endselect
	
| 	select 	tclct200.bobj, tclct200.lcos, sum(tclct200.lcam):additional.amount
| 	from	tclct200
| 	where	tclct200._index1 = {21, 100, :whinh310.rcno}
| 	group by tclct200.bobj, tclct200.lcos
| 	selectdo
| 		
| 		select	tclct115.dsca from tclct115
| 		where	tclct115._index1 = {:tclct200.lcos}
| 		selectdo
| 		endselect
| 		for i = 1 to 5 step 1
| 			if isspace(additional.array(1,i)) then
| 				additional.array(1,i) = tclct115.dsca
| 				additional.value(i) = additional.amount
| 				break
| 			endif
| 		endfor
| 	endselect
| 	frt.amnt = additional.amount
| 	g.totl = g.totl + frt.amnt
}

function get.tax.from.tfacp935()
{
	domain	tcamnt	amount
	
	rep.exc.amnt = 0
	rep.st.amnt = 0
	
	switch.to.company(fin_comp)		|#ISG10103.n
	select	tfacp935.ccty, tfacp935.cvat, sum(tfacp935.vamt):amount
	from	tfacp935
	where	tfacp935.rcno = :whinh312.rcno
	and	tfacp935.rseq = :whinh312.rcln
	and	tfacp935.orno = :whinh312.orno			|#ISGECDV001078.n
	and	tfacp935.pono = :whinh312.pono			|#ISGECDV001078.n
	and	tfacp935.sqnb = :whinh312.seqn			|#ISGECDV001078.n
	group by tfacp935.ccty, tfacp935.cvat
	selectdo
		select	tcmcs036.indt.l,tcmcs036.dsca
		from	tcmcs036
		where	tcmcs036._index1 = {:tfacp935.ccty, :tfacp935.cvat}
		selectdo
			on case etol(tcmcs036.indt.l)
			case 1:				|Service
			case 4:				|Basic Excise Duty
			case 9:				|Basic Custom Duty	
			case 10:			|Countervailing Duty
			case 14:			|ECess CVD
			case 15:			|ECess on Custom
			case 16:			|Ecess on Service
			case 17:			|Ecess on Excise
			case 19:			|SHE Cess on CVD
			case 20:			|SHE Cess on Excise
			case 21:			|SHE Cess on Service
			case 22:			|SHE Cess on Custom
				rep.exc.amnt = rep.exc.amnt + amount
				break
			case 2:				|Local Sales Tax	
			case 3:				|Central Sales Tax
			case 26:			|VAT
			case 30:			|Not Applicable
				rep.st.amnt = rep.st.amnt + amount
			endcase
		endselect
	endselect
	switch.to.company(curr_comp)		|#ISG10103.n
}

function get.tax.from.whinh936()
{
	domain	tcamnt	amount
	
	rep.exc.amnt = 0
	rep.st.amnt = 0
	
	switch.to.company(fin_comp)		|#ISG10103.n
	select   sum(whinh936.aamt):amount, whinh936.rcno, whinh936.taxc, whinh936.pvat
	from	 whinh936
	where	 whinh936._index1 = {:whinh312.rcno,:whinh312.rcln}
	group by whinh936.rcno,whinh936.taxc,whinh936.pvat
	selectdo
		fwhinh936.found = true		|#ISGECDV001020.n
		select	tcmcs036.indt.l,tcmcs036.dsca
		from	tcmcs036
		where	tcmcs036._index1 = {"IN", :whinh936.taxc}
		selectdo
			on case etol(tcmcs036.indt.l)
			case 1:				|Service
			case 4:				|Basic Excise Duty
			case 9:				|Basic Custom Duty	
			case 10:			|Countervailing Duty
			case 14:			|ECess CVD
			case 15:			|ECess on Custom
			case 16:			|Ecess on Service
			case 17:			|Ecess on Excise
			case 19:			|SHE Cess on CVD
			case 20:			|SHE Cess on Excise
			case 21:			|SHE Cess on Service
			case 22:			|SHE Cess on Custom
				rep.exc.amnt = rep.exc.amnt + amount
				break
			case 2:				|Local Sales Tax	
			case 3:				|Central Sales Tax
			case 26:			|VAT
			case 30:			|Not Applicable
				rep.st.amnt = rep.st.amnt + amount
			endcase
		endselect
	endselect
	switch.to.company(curr_comp)		|#ISG10103.n
}


function domain tcdsca get.city.desc(
			domain	tcccty		i.cctf,
			domain	tcmcs.cste	i.plcf,
			domain	tccity		i.citf
					)
{
	domain	tcdsca	tmp.dsca
	
	select	c_tccom139.dsca:tmp.dsca
	from	tccom139 c_tccom139
	where	c_tccom139._index1 = {:i.cctf, :i.plcf, :i.citf}
	selectdo
	selectempty
		tmp.dsca = ""
	endselect

	return(tmp.dsca)
}					
					
function get.layer(ref domain tctax.layr.l layer.temp)		|#ISGEC001174.sn
{
	if tctax941.lr01 = tcyesno.yes then	
		layer.temp  = 1
	else
		if tctax941.lr02 = tcyesno.yes then	
			layer.temp  = 2
		else
			if tctax941.lr03 = tcyesno.yes then	
				layer.temp  = 3
			else
				if tctax941.lr04 = tcyesno.yes then	
					layer.temp  = 4		
				else
					if tctax941.lr05 = tcyesno.yes then	
						layer.temp  = 5
					else
						if tctax941.lr06 = tcyesno.yes then	
							layer.temp  = 6
						else
							if tctax941.lr07 = tcyesno.yes then	
								layer.temp  = 7
							else
								if tctax941.lr08 = tcyesno.yes then	
									layer.temp  = 8		
								else
									if tctax941.lr09 = tcyesno.yes then	
										layer.temp  = 9
									endif
								endif
							endif
						endif
					endif
				endif
			endif
		endif	
	endif
}									|#ISGEC001174.en							


function get.address(domain tccom.cadr in.address)			|PATCH002015.sn
{
	select tccom130vend.nama:vend.nama,
		tccom130vend.namb:vend.namb,
		tccom130vend.namc:vend.namc,
		tccom130vend.telp:vend.telp,
		tccom130vend.tefx:vend.tefx,
		tccom130vend.namd:vend.namd,
		tccom130vend.namf:vend.namf,
		tccom130vend.pstc:vend.pstc,
		tccom130vend.dsca:vend.dsca,
		tccom130vend.ccty:vend.ccty,
		tccom130vend.ccit:vend.ccit,           
		tccom130vend.cste:vend.cste
	from    tccom130 tccom130vend
	where   tccom130vend._index1 = {:in.address}
	selectdo
		if isspace(vend.namf) then
			vend.namf = vend.dsca
		endif
		if isspace(vend.namf) then
			select tccom139.dsca from tccom139
			where tccom139._index1 = {:vend.ccty,:vend.cste,:vend.ccit}
			as set with 1 rows
			selectdo
				vend.namf = tccom139.dsca
			endselect
		endif
	endselect	


}										|PATCH002015.en

